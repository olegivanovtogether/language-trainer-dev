<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish A0 ‚Äì —Ç—Ä–µ–Ω–∞–∂–µ—Ä (SER/ESTAR)</title>
    <style>
        :root {
            --base-font: 16px;
            --accent: #ffb74d;
            --accent-soft: #fff4e0;
            --card-bg: #ffffff;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 12px 12px 24px;
            line-height: 1.5;
            font-size: var(--base-font);
            box-sizing: border-box;
            background: #f5f5f5;
            transition: background-color 0.15s;
        }

        h1 {
            text-align: center;
            margin: 16px 0 4px;
            font-size: 1.4rem;
        }

        .subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }

        .warning {
            font-size: 0.85rem;
            color: #a15a00;
            background: var(--accent-soft);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 8px 10px;
            margin-bottom: 10px;
        }

        .top-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .block-selector-label {
            font-size: 0.85rem;
            color: #555;
        }

        select {
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            background: #fff;
        }

        .block-header {
            margin: 8px 0 4px;
        }

        .block-title {
            font-weight: 700;
            font-size: 1.05rem;
        }

        .block-progress {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--accent);
        }

        .exercise-step {
            font-size: 0.9rem;
            margin: 6px 0 8px;
            color: #333;
        }

        .explain {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            padding: 10px 12px;
            margin-bottom: 12px;
        }

        .topic-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 999px;
            background: #eef4ff;
            color: #244272;
            margin-bottom: 4px;
        }

        .explain h2 {
            margin: 2px 0 6px;
            font-size: 1rem;
        }

        .explain p {
            margin: 4px 0;
        }

        .explain ul {
            margin: 4px 0 4px 18px;
            padding: 0;
        }

        .explain li {
            margin-bottom: 3px;
        }

        .toggle-explain-row {
            margin-bottom: 6px;
            text-align: right;
        }

        .card {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            background: var(--card-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .label {
            font-size: 0.83rem;
            color: #555;
            margin-bottom: 4px;
        }

        .question {
            font-size: 1.05rem;
            margin-bottom: 8px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 8px;
        }

        .option-btn {
            text-align: left;
            width: 100%;
            border-radius: 999px;
            padding-left: 14px;
        }

            .option-btn.correct {
                border-color: #2e7d32;
                background: #e6f7e6;
            }

            .option-btn.wrong {
                border-color: #c62828;
                background: #ffecec;
            }

        .feedback {
            min-height: 20px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.92rem;
        }

            .feedback.correct {
                color: #2e7d32;
            }

            .feedback.wrong {
                color: #c62828;
            }

        .input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: nowrap;
        }

        input[type="text"], textarea {
            flex: 1 1 auto;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 0.95rem;
            min-width: 0;
            font-family: inherit;
            resize: vertical;
            background: #fafafa;
        }

        button {
            padding: 9px 13px;
            border-radius: 999px;
            border: 1px solid #ccc;
            cursor: pointer;
            font-size: 0.9rem;
            background: #fff;
            transition: background 0.15s, transform 0.05s, box-shadow 0.1s;
            touch-action: manipulation;
        }

            button:hover:enabled {
                background: #f5f5f5;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }

            button:active:enabled {
                transform: scale(0.97);
            }

            button.primary {
                border-color: #333;
                background: #f0f0f0;
                font-weight: 600;
            }

            button:disabled {
                opacity: 0.6;
                cursor: default;
                box-shadow: none;
            }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-top: 8px;
        }

            .nav-buttons button {
                flex: 1 1 0;
            }

        .next-ex-btn-wrap {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
            margin-top: 4px;
        }

        .stats {
            font-size: 0.8rem;
            color: #555;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 6px 8px;
            margin-top: 6px;
        }


        /* –°–º—É–≥–∞ –ø—Ä–æ–≥—Ä–µ—Å—É –µ—Ç–∞–ø—É (—á–µ—Ä–≤–æ–Ω–∞ ‚Üí –∂–æ–≤—Ç–∞ ‚Üí –∑–µ–ª–µ–Ω–∞) */
        #stage-bar-wrap{
            height: 10px;
            width: 100%;
            border-radius: 999px;
            background: #e6e6e6;
            overflow: hidden;
            margin: 10px 0 8px;
            border: 1px solid #ddd;
        }
        #stage-bar{
            height: 100%;
            width: 0%;
            background: #ff4d4d;
            border-radius: 999px;
            transition: width 0.25s ease, background-color 0.25s ease;
        }

        .small {
            font-size: 0.8rem;
            color: #777;
            margin-top: 6px;
            text-align: center;
        }

        /* –°–ø–∞–ª–∞—Ö–∏ –µ–∫—Ä–∞–Ω–∞ */
        @keyframes flash-green {
            0% {
                background-color: #c8f7c5;
            }

            100% {
                background-color: #f5f5f5;
            }
        }

        @keyframes flash-red {
            0% {
                background-color: #ffb3b3;
            }

            100% {
                background-color: #f5f5f5;
            }
        }

        /* –∑–µ–ª–µ–Ω–µ ‚Äì –æ–¥–∏–Ω —Ä–∞–∑, –∞–ª–µ –¥–æ–≤—à–µ; —á–µ—Ä–≤–æ–Ω–µ ‚Äì 1 –±–ª–∏–º–∞–Ω–Ω—è */
        body.flash-green {
            animation: flash-green 0.5s ease-out;
        }

        
        /* Toast for penalties */
        .toast-overlay{
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity .15s ease;
            z-index: 9999;
        }
        .toast-overlay.show{ opacity: 1; }
        .toast{
            max-width: 90vw;
            background: rgba(30,30,30,0.92);
            color: #fff;
            padding: 10px 14px;
            border-radius: 14px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }

        body.flash-red {
            animation: flash-red 0.5s ease-out 1;
        }

        .small-toggle{
            display:none;
            margin: 6px 0 10px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
                font-size: 15px;
            }

            h1 {
                font-size: 1.2rem;
                margin-top: 12px;
            }

            .input-row {
                flex-direction: column;
            }

                .input-row button {
                    width: 100%;
                }

            .nav-buttons {
                flex-direction: column;
            }

            .top-row {
                flex-direction: column;
                align-items: stretch;
            }

            select {
                width: 100%;
            }

            .toggle-explain-row {
                text-align: left;
            }
        }

        /* ====== MODAL (–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏, –∑–∞–º—ñ—Å—Ç—å confirm/alert) ====== */
        .modal-overlay{
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
        }
        .modal{
            width: min(520px, 100%);
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 18px 60px rgba(0,0,0,0.25);
            padding: 18px 18px 14px;
        }
        .modal h2{
            margin: 0 0 10px;
            font-size: 1.2rem;
        }
        .modal p{
            margin: 0 0 14px;
            line-height: 1.35;
            white-space: pre-wrap;
        }
        .modal-actions{
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        .modal-actions button{
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #cfcfcf;
            background: #fff;
            cursor: pointer;
            font-weight: 600;
        }
        .modal-actions button.primary{
            border-color: #222;
            background: #222;
            color: #fff;
        }

</style>
</head>
<body>
    <h1>Spanish A0 ‚Äì —Ç—Ä–µ–Ω–∞–∂–µ—Ä (SER / ESTAR)</h1>
    <div class="subtitle">–ü–æ–∫—Ä–æ–∫–æ–≤—ñ –≤–ø—Ä–∞–≤–∏: SER / ESTAR (Presente, Pasado, Futuro) + –ø—Ä–∞–∫—Ç–∏–∫–∞.</div>

    <div id="topPanel">
        <div class="warning">
            –ö—Ä–∞—â–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç–∏ –≤–ø—Ä–∞–≤–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É. –ú–æ–∂–Ω–∞ —Å—Ç—Ä–∏–±–∞—Ç–∏ –ø–æ —Å–ø–∏—Å–∫—É, –∞–ª–µ –º–æ–∑–æ–∫ –±—É–¥–µ —Å–∏–ª—å–Ω—ñ—à–µ –≤—Ç–æ–º–ª—é–≤–∞—Ç–∏—Å—è üôÇ
        </div>

        <div class="top-row">
            <div class="block-selector-label">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –≤–ø—Ä–∞–≤–∏:</div>
            <select id="block-select"></select>
        </div>

        <div class="block-header">
            <div class="block-title" id="block-title"></div>
        </div>
        <div class="block-progress">
            <span class="progress-dot"></span>
            <span id="block-progress-text"></span>
        </div>
    </div>

    <button id="btn-topPanel" class="small-toggle">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å</button>

    <div class="exercise-step" id="exercise-step"></div>


    <div id="stage-bar-wrap" aria-label="–ü—Ä–æ–≥—Ä–µ—Å –µ—Ç–∞–ø—É"><div id="stage-bar"></div></div>
    <div class="toggle-explain-row">
        <button id="btn-toggle-explain">–°—Ö–æ–≤–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è</button>
    </div>

    <!-- –ü–û–Ø–°–ù–ï–ù–ù–Ø –í–ü–†–ê–í–ò -->
    <div id="explain" class="explain"></div>

    <!-- –í–ø—Ä–∞–≤–∞ 1: –≤–∏–±—ñ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Ñ—Ä–∞–∑–∏ -->
    <div id="ex1" class="card" style="display:none;">
        <div class="card-title">1Ô∏è‚É£ –í–∏–±—ñ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Ñ—Ä–∞–∑–∏</div>
        <div class="label">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ —Ñ—Ä–∞–∑–∞:</div>
        <div id="mc-question" class="question"></div>

        <div class="label">–û–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–µ—Ä–µ–∫–ª–∞–¥ —ñ—Å–ø–∞–Ω—Å—å–∫–æ—é:</div>
        <div id="mc-options" class="options"></div>

        <div id="mc-feedback" class="feedback"></div>
        <button id="mc-next" class="primary">–ù–∞—Å—Ç—É–ø–Ω–µ —Å–ª–æ–≤–æ –≤ —Ü—ñ–π –≤–ø—Ä–∞–≤—ñ</button>
    </div>

    <!-- –í–ø—Ä–∞–≤–∞ 2: –≤–ø–∏—Å–∞—Ç–∏ —Ñ—Ä–∞–∑—É -->
    <div id="ex2" class="card" style="display:none;">
        <div class="card-title">2Ô∏è‚É£ –ù–∞–ø–∏—Å–∞—Ç–∏ —Ñ—Ä–∞–∑—É —Å–∞–º–æ–º—É</div>
        <div class="label">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ —Ñ—Ä–∞–∑–∞:</div>
        <div id="w-question" class="question"></div>

        <div class="label">–ù–∞–ø–∏—à–∏ –ø–µ—Ä–µ–∫–ª–∞–¥ —ñ—Å–ø–∞–Ω—Å—å–∫–æ—é:</div>
        <div class="input-row">
            <input id="w-input" type="text" autocomplete="off">
            <button id="w-check">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
        </div>

        <div id="w-feedback" class="feedback"></div>
        <button id="w-show">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</button>
        <button id="w-next" class="primary">–ù–∞—Å—Ç—É–ø–Ω–µ —Å–ª–æ–≤–æ –≤ —Ü—ñ–π –≤–ø—Ä–∞–≤—ñ</button>
    </div>

    <!-- –í–ø—Ä–∞–≤–∞ 3: –ø–µ—Ä–µ–∫–ª–∞–¥ —Ä–µ—á–µ–Ω—å -->
    <div id="ex3" class="card" style="display:none;">
        <div class="card-title">3Ô∏è‚É£ –ü–µ—Ä–µ–∫–ª–∞–¥ –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ä–µ—á–µ–Ω—å</div>
        <div class="label">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π —Ç–µ–∫—Å—Ç:</div>
        <div id="s-question" class="question"></div>

        <div class="label">–ü–µ—Ä–µ–∫–ª–∞–¥–∏ —ñ—Å–ø–∞–Ω—Å—å–∫–æ—é:</div>
        <div class="input-row">
            <textarea id="s-input" rows="3" autocomplete="off"></textarea>
            <button id="s-check">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
        </div>

        <div id="s-feedback" class="feedback"></div>
        <button id="s-show">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</button>
        <button id="s-next" class="primary">–ù–∞—Å—Ç—É–ø–Ω–µ —Ä–µ—á–µ–Ω–Ω—è –≤ —Ü—ñ–π –≤–ø—Ä–∞–≤—ñ</button>
    </div>

    <div class="next-ex-btn-wrap">
        <button id="btn-restart" class="primary">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ü—é –≤–ø—Ä–∞–≤—É</button>
        <button id="btn-next-ex" class="primary">–ü–æ—á–∞—Ç–∏ –≤–ø—Ä–∞–≤–∏</button>
    </div>

    <div id="stats" class="stats"></div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü—ñ—è –ø–æ –≤–ø—Ä–∞–≤–∞–º -->
    <div class="nav-buttons">
        <button id="btn-prev">‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—è –≤–ø—Ä–∞–≤–∞</button>
        <button id="btn-next">–ù–∞—Å—Ç—É–ø–Ω–∞ –≤–ø—Ä–∞–≤–∞ ‚Üí</button>
    </div>

    <div class="small">
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–∏—à–µ –ø–æ–∫–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞.
    </div>


    <!-- ====== MODAL (–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏) ====== -->
    <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal">
            <h2 id="modalTitle">–ì–æ—Ç–æ–≤–æ</h2>
            <p id="modalText"></p>
            <div class="modal-actions">
                <button id="modalSecondary">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑</button>
                <button id="modalPrimary" class="primary">–î–∞–ª—ñ</button>

                <button id="modalTertiary" class="secondary">–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –≤–ø—Ä–∞–≤—É</button>
            </div>
        </div>
    </div>

    <script>
        /* ====== –î–ê–ù–Ü –í–ü–†–ê–í ====== */
        const blocks = [
            {
                title: "SER ‚Äî —Ç–µ–ø–µ—Ä—ñ—à–Ω—ñ–π —á–∞—Å (Presente)",
                topicTag: "üß© ser = —Å—É—Ç—å / —Ö—Ç–æ —Ü–µ",
                explanation: `
                                            <div class="topic-tag">üß© SER = –ø–æ—Å—Ç—ñ–π–Ω–µ (—Ö—Ç–æ/—â–æ —Ü–µ —î)</div>
                                            <h2>SER ‚Äî Presente</h2>
                                            <p><b>ser</b> ‚Äî –¥–ª—è ¬´—Å—É—Ç—ñ¬ª: –ø—Ä–æ—Ñ–µ—Å—ñ—è, –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å, —Ö—Ç–æ —Ç–∏, —â–æ —Ü–µ —Ç–∞–∫–µ.</p>
                                            <ul>
                                                <li><b>yo</b> <b>soy</b> ‚Ä¶ (—è —î)</li>
                                                <li><b>t√∫</b> <b>eres</b> ‚Ä¶ (—Ç–∏ —î)</li>
                                                <li><b>√©l/ella</b> <b>es</b> ‚Ä¶ (–≤—ñ–Ω/–≤–æ–Ω–∞ —î)</li>
                                                <li><b>nosotros</b> <b>somos</b> ‚Ä¶ (–º–∏ —î)</li>
                                                <li><b>vosotros</b> <b>sois</b> ‚Ä¶ (–≤–∏ —î)</li>
                                                <li><b>ellos/ellas</b> <b>son</b> ‚Ä¶ (–≤–æ–Ω–∏ —î)</li>
                                            </ul>
                                            <p>–ó–∞–ø–∞–º‚Äô—è—Ç–∞–π: <b>ser</b> = ¬´—Ö—Ç–æ/—â–æ —Ü–µ?¬ª</p>
                                        `,
                vocab: [
                    { ua: "–Ø —É–∫—Ä–∞—ó–Ω–µ—Ü—å.", en: "Yo soy ucraniano." },
                    { ua: "–¢–∏ –º—ñ–π –¥—Ä—É–≥.", en: "T√∫ eres mi amigo." },
                    { ua: "–í—ñ–Ω –ª—ñ–∫–∞—Ä.", en: "√âl es m√©dico." },
                    { ua: "–í–æ–Ω–∞ —Ä–æ–∑—É–º–Ω–∞.", en: "Ella es inteligente." },
                    { ua: "–ú–∏ —Å—Ç—É–¥–µ–Ω—Ç–∏.", en: "Nosotros somos estudiantes." },
                    { ua: "–í–∏ —ñ—Å–ø–∞–Ω—Ü—ñ.", en: "Vosotros sois espa√±oles." },
                    { ua: "–í–æ–Ω–∏ —ñ–Ω–∂–µ–Ω–µ—Ä–∏.", en: "Ellos son ingenieros." }
                ],
                sentences: [
                    { ua: "–Ø —É–∫—Ä–∞—ó–Ω–µ—Ü—å. –¢–∏ –º—ñ–π –¥—Ä—É–≥.", en: "Yo soy ucraniano. T√∫ eres mi amigo." },
                    { ua: "–í—ñ–Ω –ª—ñ–∫–∞—Ä, –∞ –≤–æ–Ω–∞ —Ä–æ–∑—É–º–Ω–∞.", en: "√âl es m√©dico y ella es inteligente." },
                    { ua: "–ú–∏ —Å—Ç—É–¥–µ–Ω—Ç–∏. –í–æ–Ω–∏ —ñ–Ω–∂–µ–Ω–µ—Ä–∏.", en: "Nosotros somos estudiantes. Ellos son ingenieros." }
                ]
            },
            {
                title: "ESTAR ‚Äî —Ç–µ–ø–µ—Ä—ñ—à–Ω—ñ–π —á–∞—Å (Presente)",
                topicTag: "üìç estar = —Å—Ç–∞–Ω / –¥–µ",
                explanation: `
                                            <div class="topic-tag">üìç ESTAR = —Å—Ç–∞–Ω –∞–±–æ –º—ñ—Å—Ü–µ</div>
                                            <h2>ESTAR ‚Äî Presente</h2>
                                            <p><b>estar</b> ‚Äî –¥–ª—è ¬´–¥–µ?¬ª —Ç–∞ ¬´—è–∫ –∑–∞—Ä–∞–∑?¬ª (—Å—Ç–∞–Ω, –µ–º–æ—Ü—ñ—ó, –ª–æ–∫–∞—Ü—ñ—è).</p>
                                            <ul>
                                                <li><b>yo</b> <b>estoy</b> ‚Ä¶</li>
                                                <li><b>t√∫</b> <b>est√°s</b> ‚Ä¶</li>
                                                <li><b>√©l/ella</b> <b>est√°</b> ‚Ä¶</li>
                                                <li><b>nosotros</b> <b>estamos</b> ‚Ä¶</li>
                                                <li><b>vosotros</b> <b>est√°is</b> ‚Ä¶</li>
                                                <li><b>ellos/ellas</b> <b>est√°n</b> ‚Ä¶</li>
                                            </ul>
                                            <p>–ó–∞–ø–∞–º‚Äô—è—Ç–∞–π: <b>estar</b> = ¬´–¥–µ?¬ª –∞–±–æ ¬´–≤ —è–∫–æ–º—É —Å—Ç–∞–Ω—ñ?¬ª</p>
                                        `,
                vocab: [
                    { ua: "–Ø –≤—Ç–æ–º–ª–µ–Ω–∏–π.", en: "Yo estoy cansado." },
                    { ua: "–¢–∏ —Ç—É—Ç.", en: "T√∫ est√°s aqu√≠." },
                    { ua: "–í—ñ–Ω –≤–¥–æ–º–∞.", en: "√âl est√° en casa." },
                    { ua: "–í–æ–Ω–∞ —Å—É–º–Ω–∞.", en: "Ella est√° triste." },
                    { ua: "–ú–∏ –≥–æ—Ç–æ–≤—ñ.", en: "Nosotros estamos listos." },
                    { ua: "–í–∏ –∑–∞–π–Ω—è—Ç—ñ.", en: "Vosotros est√°is ocupados." },
                    { ua: "–í–æ–Ω–∏ –Ω–∞ —Ä–æ–±–æ—Ç—ñ.", en: "Ellos est√°n en el trabajo." }
                ],
                sentences: [
                    { ua: "–Ø –≤—Ç–æ–º–ª–µ–Ω–∏–π, –∞ —Ç–∏ —Ç—É—Ç.", en: "Yo estoy cansado y t√∫ est√°s aqu√≠." },
                    { ua: "–í—ñ–Ω –≤–¥–æ–º–∞. –í–æ–Ω–∞ —Å—É–º–Ω–∞.", en: "√âl est√° en casa. Ella est√° triste." },
                    { ua: "–ú–∏ –≥–æ—Ç–æ–≤—ñ. –í–æ–Ω–∏ –Ω–∞ —Ä–æ–±–æ—Ç—ñ.", en: "Nosotros estamos listos. Ellos est√°n en el trabajo." }
                ]
            },
            {
                title: "SER ‚Äî –º–∏–Ω—É–ª–∏–π —á–∞—Å (Pret√©rito indefinido)",
                topicTag: "‚è± ser (–ø—Ä–æ—à.) = fui/fuiste...",
                explanation: `
                                            <div class="topic-tag">‚è± SER —É –º–∏–Ω—É–ª–æ–º—É (–∑–∞–∫—ñ–Ω—á–µ–Ω–∞ –ø–æ–¥—ñ—è)</div>
                                            <h2>SER ‚Äî Pret√©rito indefinido</h2>
                                            <p>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π, –∫–æ–ª–∏ ¬´–±—É–ª–æ¬ª —ñ <b>–∑–∞–∫—ñ–Ω—á–∏–ª–æ—Å—å</b>.</p>
                                            <ul>
                                                <li>yo <b>fui</b></li>
                                                <li>t√∫ <b>fuiste</b></li>
                                                <li>√©l/ella <b>fue</b></li>
                                                <li>nosotros <b>fuimos</b></li>
                                                <li>vosotros <b>fuisteis</b></li>
                                                <li>ellos/ellas <b>fueron</b></li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø –±—É–≤ —Å—Ç—É–¥–µ–Ω—Ç–æ–º.", en: "Yo fui estudiante." },
                    { ua: "–¢–∏ –±—É–≤ –º–æ—ó–º –Ω–∞—á–∞–ª—å–Ω–∏–∫–æ–º.", en: "T√∫ fuiste mi jefe." },
                    { ua: "–í—ñ–Ω –±—É–≤ –≤–∏–∫–ª–∞–¥–∞—á–µ–º.", en: "√âl fue profesor." },
                    { ua: "–í–æ–Ω–∞ –±—É–ª–∞ –¥—É–∂–µ –≤–≤—ñ—á–ª–∏–≤–∞.", en: "Ella fue muy amable." },
                    { ua: "–ú–∏ –±—É–ª–∏ –¥—Ä—É–∑—è–º–∏.", en: "Nosotros fuimos amigos." },
                    { ua: "–í–∏ –±—É–ª–∏ —Å—É—Å—ñ–¥–∞–º–∏.", en: "Vosotros fuisteis vecinos." },
                    { ua: "–í–æ–Ω–∏ –±—É–ª–∏ —â–∞—Å–ª–∏–≤—ñ.", en: "Ellos fueron felices." }
                ],
                sentences: [
                    { ua: "–Ø –±—É–≤ —Å—Ç—É–¥–µ–Ω—Ç–æ–º. –í–æ–Ω–∞ –±—É–ª–∞ –≤–≤—ñ—á–ª–∏–≤–∞.", en: "Yo fui estudiante. Ella fue muy amable." },
                    { ua: "–ú–∏ –±—É–ª–∏ –¥—Ä—É–∑—è–º–∏. –í–æ–Ω–∏ –±—É–ª–∏ —â–∞—Å–ª–∏–≤—ñ.", en: "Nosotros fuimos amigos. Ellos fueron felices." }
                ]
            },
            {
                title: "ESTAR ‚Äî –º–∏–Ω—É–ª–∏–π —á–∞—Å (Pret√©rito indefinido)",
                topicTag: "‚è± estar (–ø—Ä–æ—à.) = estuve/estuviste...",
                explanation: `
                                            <div class="topic-tag">‚è± ESTAR —É –º–∏–Ω—É–ª–æ–º—É (–¥–µ/—Å—Ç–∞–Ω —Ç–æ–¥—ñ)</div>
                                            <h2>ESTAR ‚Äî Pret√©rito indefinido</h2>
                                            <p>–ö–æ–ª–∏ ¬´–±—É–≤/–±—É–ª–∞¬ª <b>–≤ —Å—Ç–∞–Ω—ñ</b> –∞–±–æ <b>–≤ –º—ñ—Å—Ü—ñ</b>, —ñ —Ü–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.</p>
                                            <ul>
                                                <li>yo <b>estuve</b></li>
                                                <li>t√∫ <b>estuviste</b></li>
                                                <li>√©l/ella <b>estuvo</b></li>
                                                <li>nosotros <b>estuvimos</b></li>
                                                <li>vosotros <b>estuvisteis</b></li>
                                                <li>ellos/ellas <b>estuvieron</b></li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø –±—É–≤ —Ö–≤–æ—Ä–∏–π.", en: "Yo estuve enfermo." },
                    { ua: "–¢–∏ –±—É–≤ —Ç–∞–º.", en: "T√∫ estuviste all√≠." },
                    { ua: "–í—ñ–Ω –±—É–≤ –≤—Ç–æ–º–ª–µ–Ω–∏–π.", en: "√âl estuvo cansado." },
                    { ua: "–í–æ–Ω–∞ –±—É–ª–∞ –≤ –ú–∞–¥—Ä–∏–¥—ñ.", en: "Ella estuvo en Madrid." },
                    { ua: "–ú–∏ –±—É–ª–∏ —Ä–∞–∑–æ–º.", en: "Nosotros estuvimos juntos." },
                    { ua: "–í–∏ –±—É–ª–∏ —Ç—É—Ç.", en: "Vosotros estuvisteis aqu√≠." },
                    { ua: "–í–æ–Ω–∏ –±—É–ª–∏ –≤–¥–æ–º–∞.", en: "Ellos estuvieron en casa." }
                ],
                sentences: [
                    { ua: "–Ø –±—É–≤ —Ö–≤–æ—Ä–∏–π. –¢–∏ –±—É–≤ —Ç–∞–º.", en: "Yo estuve enfermo. T√∫ estuviste all√≠." },
                    { ua: "–í–æ–Ω–∞ –±—É–ª–∞ –≤ –ú–∞–¥—Ä–∏–¥—ñ. –ú–∏ –±—É–ª–∏ —Ä–∞–∑–æ–º.", en: "Ella estuvo en Madrid. Nosotros estuvimos juntos." }
                ]
            },
            {
                title: "SER ‚Äî –º–∞–π–±—É—Ç–Ω—ñ–π —á–∞—Å (Futuro simple)",
                topicTag: "üîÆ ser (–º–∞–π–±.) = ser√©/ser√°s...",
                explanation: `
                                            <div class="topic-tag">üîÆ SER —É –º–∞–π–±—É—Ç–Ω—å–æ–º—É</div>
                                            <h2>SER ‚Äî Futuro simple</h2>
                                            <p>–ö–æ–ª–∏ –≥–æ–≤–æ—Ä–∏—à ¬´–±—É–¥—É/–±—É–¥–µ—à/–±—É–¥–µ¬ª –ø—Ä–æ <b>—Å—É—Ç–Ω—ñ—Å—Ç—å</b>.</p>
                                            <ul>
                                                <li>yo <b>ser√©</b></li>
                                                <li>t√∫ <b>ser√°s</b></li>
                                                <li>√©l/ella <b>ser√°</b></li>
                                                <li>nosotros <b>seremos</b></li>
                                                <li>vosotros <b>ser√©is</b></li>
                                                <li>ellos/ellas <b>ser√°n</b></li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø –±—É–¥—É –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º.", en: "Yo ser√© dise√±ador." },
                    { ua: "–¢–∏ –±—É–¥–µ—à –≤—ñ–¥–æ–º–∏–º.", en: "T√∫ ser√°s famoso." },
                    { ua: "–í—ñ–Ω –±—É–¥–µ –ª—ñ–∫–∞—Ä–µ–º.", en: "√âl ser√° m√©dico." },
                    { ua: "–í–æ–Ω–∞ –±—É–¥–µ –º–∞–º–æ—é.", en: "Ella ser√° madre." },
                    { ua: "–ú–∏ –±—É–¥–µ–º–æ –≤—ñ–ª—å–Ω—ñ.", en: "Nosotros seremos libres." },
                    { ua: "–í–∏ –±—É–¥–µ—Ç–µ —Å–∏–ª—å–Ω—ñ.", en: "Vosotros ser√©is fuertes." },
                    { ua: "–í–æ–Ω–∏ –±—É–¥—É—Ç—å —â–∞—Å–ª–∏–≤—ñ.", en: "Ellos ser√°n felices." }
                ],
                sentences: [
                    { ua: "–Ø –±—É–¥—É –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º. –¢–∏ –±—É–¥–µ—à –≤—ñ–¥–æ–º–∏–º.", en: "Yo ser√© dise√±ador. T√∫ ser√°s famoso." },
                    { ua: "–ú–∏ –±—É–¥–µ–º–æ –≤—ñ–ª—å–Ω—ñ. –í–æ–Ω–∏ –±—É–¥—É—Ç—å —â–∞—Å–ª–∏–≤—ñ.", en: "Nosotros seremos libres. Ellos ser√°n felices." }
                ]
            },
            {
                title: "ESTAR ‚Äî –º–∞–π–±—É—Ç–Ω—ñ–π —á–∞—Å (Futuro simple)",
                topicTag: "üîÆ estar (–º–∞–π–±.) = estar√©/estar√°s...",
                explanation: `
                                            <div class="topic-tag">üîÆ ESTAR —É –º–∞–π–±—É—Ç–Ω—å–æ–º—É</div>
                                            <h2>ESTAR ‚Äî Futuro simple</h2>
                                            <p>–ö–æ–ª–∏ ¬´–±—É–¥—É/–±—É–¥–µ—à/–±—É–¥–µ¬ª –ø—Ä–æ <b>—Å—Ç–∞–Ω</b> –∞–±–æ <b>–º—ñ—Å—Ü–µ</b>.</p>
                                            <ul>
                                                <li>yo <b>estar√©</b></li>
                                                <li>t√∫ <b>estar√°s</b></li>
                                                <li>√©l/ella <b>estar√°</b></li>
                                                <li>nosotros <b>estaremos</b></li>
                                                <li>vosotros <b>estar√©is</b></li>
                                                <li>ellos/ellas <b>estar√°n</b></li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø –±—É–¥—É –≤–¥–æ–º–∞.", en: "Yo estar√© en casa." },
                    { ua: "–¢–æ–±—ñ –±—É–¥–µ –¥–æ–±—Ä–µ.", en: "T√∫ estar√°s bien." },
                    { ua: "–í—ñ–Ω –±—É–¥–µ –∑–∞–π–Ω—è—Ç–∏–π.", en: "√âl estar√° ocupado." },
                    { ua: "–í–æ–Ω–∞ –±—É–¥–µ —Ç—É—Ç –∑–∞–≤—Ç—Ä–∞.", en: "Ella estar√° aqu√≠ ma√±ana." },
                    { ua: "–ú–∏ –±—É–¥–µ–º–æ –≥–æ—Ç–æ–≤—ñ.", en: "Nosotros estaremos listos." },
                    { ua: "–í–∏ –±—É–¥–µ—Ç–µ –≤—Ç–æ–º–ª–µ–Ω—ñ.", en: "Vosotros estar√©is cansados." },
                    { ua: "–í–æ–Ω–∏ –±—É–¥—É—Ç—å –Ω–∞ —Ä–æ–±–æ—Ç—ñ.", en: "Ellos estar√°n en el trabajo." }
                ],
                sentences: [
                    { ua: "–Ø –±—É–¥—É –≤–¥–æ–º–∞ –∑–∞–≤—Ç—Ä–∞. –í—ñ–Ω –±—É–¥–µ –∑–∞–π–Ω—è—Ç–∏–π.", en: "Yo estar√© en casa ma√±ana. √âl estar√° ocupado." },
                    { ua: "–ú–∏ –±—É–¥–µ–º–æ –≥–æ—Ç–æ–≤—ñ. –í–æ–Ω–∏ –±—É–¥—É—Ç—å –Ω–∞ —Ä–æ–±–æ—Ç—ñ.", en: "Nosotros estaremos listos. Ellos estar√°n en el trabajo." }
                ]
            },
            {
                title: "SER vs ESTAR ‚Äî –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è",
                topicTag: "‚öñÔ∏è —Ä—ñ–∑–Ω–∏—Ü—è –≤ –∑–Ω–∞—á–µ–Ω–Ω—ñ",
                explanation: `
                                            <div class="topic-tag">‚öñÔ∏è SER vs ESTAR</div>
                                            <h2>–ì–æ–ª–æ–≤–Ω–∞ —Ä—ñ–∑–Ω–∏—Ü—è</h2>
                                            <ul>
                                                <li><b>SER</b> = ¬´—Ö—Ç–æ/—â–æ —Ü–µ —î¬ª (—Å—É—Ç—å, –ø–æ—Å—Ç—ñ–π–Ω–µ)</li>
                                                <li><b>ESTAR</b> = ¬´–¥–µ/—è–∫ –∑–∞—Ä–∞–∑¬ª (—Å—Ç–∞–Ω, –º—ñ—Å—Ü–µ)</li>
                                            </ul>
                                            <p>–ö—Ä–∏—Ç–∏—á–Ω—ñ –ø–∞—Ä–∏:</p>
                                            <ul>
                                                <li><b>Soy aburrido.</b> ‚Äî —è –Ω—É–¥–Ω–∞ –ª—é–¥–∏–Ω–∞ (—Ö–∞—Ä–∞–∫—Ç–µ—Ä).</li>
                                                <li><b>Estoy aburrido.</b> ‚Äî –º–µ–Ω—ñ –∑–∞—Ä–∞–∑ –Ω—É–¥–Ω–æ (—Å—Ç–∞–Ω).</li>
                                                <li><b>Es bueno.</b> ‚Äî —Ö–æ—Ä–æ—à–∏–π –≤–∑–∞–≥–∞–ª—ñ.</li>
                                                <li><b>Est√° bueno.</b> ‚Äî —Å–º–∞—á–Ω–∏–π/–¥–æ–±—Ä–∏–π –∑–∞—Ä–∞–∑.</li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø –Ω—É–¥–Ω–∞ –ª—é–¥–∏–Ω–∞.", en: "Soy aburrido." },
                    { ua: "–ú–µ–Ω—ñ –∑–∞—Ä–∞–∑ –Ω—É–¥–Ω–æ.", en: "Estoy aburrido." },
                    { ua: "–¶–µ —Ö–æ—Ä–æ—à–µ (–≤–∑–∞–≥–∞–ª—ñ).", en: "Es bueno." },
                    { ua: "–¶–µ —Å–º–∞—á–Ω–µ (–∑–∞—Ä–∞–∑).", en: "Est√° bueno." },
                    { ua: "–Ø —É–∫—Ä–∞—ó–Ω–µ—Ü—å.", en: "Soy ucraniano." },
                    { ua: "–Ø –≤ –£–∫—Ä–∞—ó–Ω—ñ.", en: "Estoy en Ucrania." }
                ],
                sentences: [
                    { ua: "–Ø —É–∫—Ä–∞—ó–Ω–µ—Ü—å. –Ø –≤ –£–∫—Ä–∞—ó–Ω—ñ.", en: "Soy ucraniano. Estoy en Ucrania." },
                    { ua: "–í—ñ–Ω —Ö–æ—Ä–æ—à–∏–π (–≤–∑–∞–≥–∞–ª—ñ), –∞–ª–µ –∑–∞—Ä–∞–∑ –≤—Ç–æ–º–ª–µ–Ω–∏–π.", en: "√âl es bueno, pero ahora est√° cansado." }
                ]
            }
        ];


        /* ====== –Ü–ì–†–û–í–ê –õ–û–ì–Ü–ö–ê (—Ü—ñ–ª—ñ –µ—Ç–∞–ø—ñ–≤) ====== */
        const GAME = {
            livesPerStage: 3,
            stage: {
                mc: { needCorrect: 5, minAccuracy: 0.70 },
                write: { needCorrect: 5, minAccuracy: 0.70 },
                sent: { needCorrect: 3, minAccuracy: 0.60 }
            },
            stars: {
                two: 0.85,
                three: 0.95,
                streakForThree: 5
            }
        };

        let gameXP = 0;

        let stageState = {
            mc: { correct: 0, attempts: 0, streak: 0, lives: 3, cleared: false, stars: 0 },
            write: { correct: 0, attempts: 0, streak: 0, lives: 3, cleared: false, stars: 0 },
            sent: { correct: 0, attempts: 0, streak: 0, lives: 3, cleared: false, stars: 0 }
        };


        // ====== –ö–æ–º—ñ—Ç–∏: —à—Ç—Ä–∞—Ñ –∑–∞–º—ñ—Å—Ç—å —Å–∫–∏–¥–∞–Ω–Ω—è ======
        // –ü—Ä–∞–≤–∏–ª–∞:
        // - –Ø–∫—â–æ N <= 3: 3 –∂–∏—Ç—Ç—è, —à—Ç—Ä–∞—Ñ = –≤—ñ–¥–∫–∞—Ç –Ω–∞ 3
        // - –Ø–∫—â–æ N > 3: 5 –∂–∏—Ç—Ç—ñ–≤ (–º–∞–∫—Å), —à—Ç—Ä–∞—Ñ = –≤—ñ–¥–∫–∞—Ç –Ω–∞ 5
        // - –ñ–û–î–ù–ò–• –ø–æ–≤–Ω–∏—Ö —Å–∫–∏–¥—ñ–≤ –Ω–∞–∑–∞–¥. –õ–∏—à–µ –≤—ñ–¥–∫–∞—Ç correct —ñ –ø–æ–∑–∏—Ü—ñ—ó –ø–æ–∫–∞–∑—É.
        function getNFor(kind) {
            const b = blocks[currentBlockIndex];
            if (kind === "sent") return (b.sentences && b.sentences.length) ? b.sentences.length : 0;
            return (b.vocab && b.vocab.length) ? b.vocab.length : 0;
        }
        function getLivesMax(kind) {
            const n = getNFor(kind);
            return (n <= 3) ? 3 : 5;
        }
        function getRollbackSteps(kind) {
            // —à—Ç—Ä–∞—Ñ = 3 –∞–±–æ 5 (–Ω–µ –±—ñ–ª—å—à–µ 5)
            const n = getNFor(kind);
            return (n <= 3) ? 3 : 5;
        }

        function showToast(msg) {
            const ov = document.getElementById("toastOverlay");
            const el = document.getElementById("toastMsg");
            if (!ov || !el) return;
            el.textContent = msg;
            ov.classList.add("show");
            ov.setAttribute("aria-hidden", "false");
            setTimeout(() => {
                ov.classList.remove("show");
                ov.setAttribute("aria-hidden", "true");
            }, 1200);
        }

        function resetStage(kind) {
            stageState[kind] = { correct: 0, attempts: 0, streak: 0, lives: getLivesMax(kind), cleared: false, stars: 0 };
        }

        function resetAllStages() {
            resetStage("mc");
            resetStage("write");
            resetStage("sent");
        }

        // --- UX helpers: –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –µ—Ç–∞–ø—É/–≤–ø—Ä–∞–≤–∏ —ñ "–ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏" ---
        function restartStage(kind) {
            clearAutoNext();
            resetStage(kind);

            // —Å–∫–∏–¥–∞–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –ø—ñ–¥–∫–∞–∑–∫–∏
            if (kind === "mc") { wrongAttemptsMC = 0; lastVocabIndexMC = -1; try { const b = blocks[currentBlockIndex]; resetSeq("mc", (b.vocab && b.vocab.length) ? b.vocab.length : 0); } catch (e) { } loadMCQuestion(); }
            if (kind === "write") { wrongAttemptsWrite = 0; lastVocabIndexWrite = -1; try { const b = blocks[currentBlockIndex]; resetSeq("write", (b.vocab && b.vocab.length) ? b.vocab.length : 0); } catch (e) { } loadWQuestion(); }
            if (kind === "sent") { wrongAttemptsSent = 0; lastSentenceIndex = -1; try { const b = blocks[currentBlockIndex]; resetSeq("sent", (b.sentences && b.sentences.length) ? b.sentences.length : 0); } catch (e) { } loadSentence(); }

            updateExerciseVisibility();
            updateGateUI();
        }

        function restartCurrentBlock() {
            clearAutoNext();
            // —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—î—ó –≤–ø—Ä–∞–≤–∏ (—ñ –ø—Ä–æ–≥—Ä–µ—Å—É –µ—Ç–∞–ø—ñ–≤)
            try { if (typeof resetAllStages === "function") resetAllStages(); } catch (e) { }

            // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ü—ñ—î—ó —Å–µ—Å—ñ—ó (stats) —á—ñ–ø–∞—î–º–æ –ª–∏—à–µ —è–∫—â–æ –≤–æ–Ω–∞ –≤–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞
            try {
                if (typeof stats !== "undefined") {
                    stats[currentBlockIndex] = {
                        mc: { correct: 0, total: 0 },
                        write: { correct: 0, total: 0 },
                        sent: { correct: 0, total: 0 }
                    };
                }
            } catch (e) { }

            loadBlock(currentBlockIndex);
            try { if (typeof updateStatsView === "function") updateStatsView(); } catch (e) { }
        }

        function goNextStep() {
            clearAutoNext();
            nextExerciseStep();
        }

        function nextBlock() {
            clearAutoNext();
            if (currentBlockIndex < blocks.length - 1) {
                loadBlock(currentBlockIndex + 1);
            } else {
                // —è–∫—â–æ —Ü–µ –æ—Å—Ç–∞–Ω–Ω—è –≤–ø—Ä–∞–≤–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É —ñ –ª–∏—à–∞—î–º–æ—Å—è —Ç—É—Ç
                loadBlock(currentBlockIndex);
            }
        }

        function stageAccuracy(kind) {
            const s = stageState[kind];
            return s.attempts ? (s.correct / s.attempts) : 0;
        }

        function stageGoalMet(kind) {
            const cfg = GAME.stage[kind];
            const s = stageState[kind];
            return s.correct >= cfg.needCorrect && stageAccuracy(kind) >= cfg.minAccuracy;
        }

        function calcStars(kind) {
            const s = stageState[kind];
            if (!s.cleared) return 0;
            const a = stageAccuracy(kind);
            if (a >= GAME.stars.three && s.streak >= GAME.stars.streakForThree) return 3;
            if (a >= GAME.stars.two) return 2;
            return 1;
        }

        function currentKind() {
            if (currentExerciseStep === 1) return "mc";
            if (currentExerciseStep === 2) return "write";
            if (currentExerciseStep === 3) return "sent";
            return null;
        }


        // ====== MODAL helpers ======
        const modalOverlayEl = document.getElementById("modalOverlay");
        const modalTitleEl = document.getElementById("modalTitle");
        const modalTextEl = document.getElementById("modalText");
        const modalPrimaryEl = document.getElementById("modalPrimary");
        const modalSecondaryEl = document.getElementById("modalSecondary");
        const modalTertiaryEl = document.getElementById("modalTertiary");

        let modalPrimaryAction = null;
        let modalSecondaryAction = null;
        let modalTertiaryAction = null;

        function openModal({ title, text, primaryText = "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏", secondaryText = null, tertiaryText = null, onPrimary = null, onSecondary = null, onTertiary = null }) {
            modalTitleEl.textContent = title;
            modalTextEl.textContent = text;

            modalPrimaryEl.textContent = primaryText;
            modalSecondaryEl.textContent = secondaryText || "";
            modalTertiaryEl.textContent = tertiaryText || "";

            modalPrimaryAction = onPrimary;
            modalSecondaryAction = onSecondary;
            modalTertiaryAction = onTertiary;

            modalSecondaryEl.style.display = secondaryText ? "inline-flex" : "none";
            modalTertiaryEl.style.display = tertiaryText ? "inline-flex" : "none";

            modalOverlayEl.style.display = "flex";
            modalOverlayEl.setAttribute("aria-hidden", "false");

            // —Ñ–æ–∫—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ñ–π –∫–Ω–æ–ø—Ü—ñ
            modalPrimaryEl.focus();
        }

        function closeModal() {
            modalOverlayEl.style.display = "none";
            modalOverlayEl.setAttribute("aria-hidden", "true");
            modalPrimaryAction = null;
            modalSecondaryAction = null;
            modalTertiaryAction = null;
        }

        modalPrimaryEl.addEventListener("click", () => {
            const fn = modalPrimaryAction;
            closeModal();
            if (typeof fn === "function") fn();
        });

        modalSecondaryEl.addEventListener("click", () => {
            const fn = modalSecondaryAction;
            closeModal();
            if (typeof fn === "function") fn();
        });



        modalTertiaryEl.addEventListener("click", () => {
            const fn = modalTertiaryAction;
            closeModal();
            if (typeof fn === "function") fn();
        });
        // –∑–∞–∫—Ä–∏—Ç—Ç—è –∫–ª—ñ–∫–æ–º –ø–æ –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—é
        modalOverlayEl.addEventListener("click", (e) => {
            if (e.target === modalOverlayEl) {
                closeModal();
            }
        });

        function showVictory(kind) {
            clearAutoNext();

            // –í —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ —Ç–µ—Ö-—è—Ä–ª–∏–∫–∏ MC/WRITE/SENT.
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –Ω–æ–º–µ—Ä –µ—Ç–∞–ø—É 1..3 –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:
            const stageNumber = (kind === "mc") ? 1 : (kind === "write") ? 2 : 3;

            // –Ø–∫—â–æ —Ü–µ –æ—Å—Ç–∞–Ω–Ω—ñ–π –µ—Ç–∞–ø —ñ –≤—ñ–Ω –ø—Ä–æ–π–¥–µ–Ω–∏–π ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤–ø—Ä–∞–≤–∏
            const isFinalStage = (kind === "sent");
            const exerciseDone = isFinalStage && stageState.mc.cleared && stageState.write.cleared && stageState.sent.cleared;

            if (exerciseDone) {
                // –ú–æ–∂–µ–º–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥—Å—É–º–∫–æ–≤—ñ –∑—ñ—Ä–∫–∏ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–º –µ—Ç–∞–ø–æ–º (–∞–±–æ –ø—Ä–æ—Å—Ç–æ ‚≠ê‚≠ê‚≠ê –∑–∞ –±–∞–∂–∞–Ω–Ω—è–º).
                const stars = calcStars(kind);
                stageState[kind].stars = stars;

                openModal({
                    title: "–£–†–ê! –í–ò –ü–†–û–ô–®–õ–ò –¶–Æ –í–ü–†–ê–í–£ üéâ " + "‚≠ê".repeat(stars),
                    text: "–í–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤—Å—ñ –µ—Ç–∞–ø–∏ —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏.",
                    primaryText: "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –Ω–∞–≤—á–∞–Ω–Ω—è",
                    secondaryText: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π –µ—Ç–∞–ø",
                    tertiaryText: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –≤–ø—Ä–∞–≤—É",
                    onPrimary: () => {
                        closeModal();
                        nextBlock(); // –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –≤–ø—Ä–∞–≤–∏
                    },
                    onSecondary: () => {
                        closeModal();
                        restartStage(kind); // —Å–∫–∏–¥–∞–Ω–Ω—è –ª–∏—à–µ –µ—Ç–∞–ø—É 3
                    },
                    onTertiary: () => {
                        closeModal();
                        restartCurrentBlock(); // —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—î—ó –≤–ø—Ä–∞–≤–∏
                    }
                });
                return;
            }

            // –ó–≤–∏—á–∞–π–Ω–∞ –ø–µ—Ä–µ–º–æ–≥–∞ –µ—Ç–∞–ø—É
            const stars = calcStars(kind);
            stageState[kind].stars = stars;

            openModal({
                title: "–ï–¢–ê–ü " + stageNumber + " –ó 3 –ü–†–û–ô–î–ï–ù–û  " + "‚≠ê".repeat(stars),
                text: "–ß—É–¥–æ–≤–æ! –ú–æ–∂–µ—à –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∞–±–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Ü–µ–π –µ—Ç–∞–ø.",
                primaryText: "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏",
                secondaryText: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –µ—Ç–∞–ø",
                tertiaryText: "",
                onPrimary: () => {
                    closeModal();
                    goNextStep(); // –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –µ—Ç–∞–ø
                },
                onSecondary: () => {
                    closeModal();
                    restartStage(kind); // —Å–∫–∏–¥–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É –ø–æ—Ç–æ—á–Ω–æ–≥–æ –µ—Ç–∞–ø—É
                }
            });
        }

        function showFail(kind) {
            clearAutoNext();

            // –®—Ç—Ä–∞—Ñ –∑–∞–º—ñ—Å—Ç—å —Å–∫–∏–¥–∞–Ω–Ω—è: –≤—ñ–¥–∫–∞—Ç –Ω–∞ 3 –∞–±–æ 5, –ø–æ—Ç—ñ–º –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ
            const rollback = getRollbackSteps(kind);
            const s = stageState[kind];

            // –≤—ñ–¥–∫–∞—Ç –ø—Ä–æ–≥—Ä–µ—Å—É (–∞–ª–µ –Ω–µ –Ω–∏–∂—á–µ 0)
            s.correct = Math.max(0, s.correct - rollback);
            // –∂–∏—Ç—Ç—è –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –¥–æ –º–∞–∫—Å–∏–º—É–º—É –¥–ª—è —Ü—å–æ–≥–æ N
            s.lives = getLivesMax(kind);

            // –≤—ñ–¥–∫–∞—Ç –ø–æ–∑–∏—Ü—ñ—ó –ø–æ–∫–∞–∑—É (—â–æ–± —Ä–µ–∞–ª—å–Ω–æ –ø–æ–≤—Ç–æ—Ä—é–≤–∞–ª–æ, –∞ –Ω–µ –ø–µ—Ä–µ—Å–∫–∞–∫—É–≤–∞–ª–æ)
            try {
                if (seq && seq[kind]) {
                    seq[kind].pos = Math.max(0, (seq[kind].pos || 0) - rollback);
                    seq[kind].last = -1;
                }
            } catch (e) { }

            // —ñ–≥—Ä–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è + —á–µ—Ä–≤–æ–Ω–∞ –≤—Å–ø–∏—à–∫–∞
            flashScreen("red");
            showToast(`–£–ø—Å! –ü–æ–º–∏–ª–∫–∞ üòÖ –®—Ç—Ä–∞—Ñ: -${rollback}`);

            updateGateUI();

            // –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –µ—Ç–∞–ø
            if (kind === "mc") loadMCQuestion();
            if (kind === "write") loadWQuestion();
            if (kind === "sent") loadSentence();
        }
        function onCorrect(kind) {
            const s = stageState[kind];
            s.attempts++;
            s.correct++;
            s.streak++;
            gameXP += 10;

            if (!s.cleared && stageGoalMet(kind)) {
                s.cleared = true;
                s.stars = calcStars(kind);
                updateGateUI();
                showVictory(kind);
                return;
            }

            updateGateUI();
        }

        function onWrong(kind) {
            const s = stageState[kind];
            s.attempts++;
            s.streak = 0;
            s.lives--;

            if (s.lives <= 0) {
                showFail(kind);
                return;
            }

            updateGateUI();
        }

        function updateGateUI() {
            const kind = currentKind();

            // 1) –≤–µ—Ä—Ö–Ω—è –ø–∞–Ω–µ–ª—å (–º–µ–Ω—à–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –ø—Ä–∞–∫—Ç–∏–∫–∏)
            if (currentExerciseStep === 0) {
                // –Ω–∞ –ø–æ—è—Å–Ω–µ–Ω–Ω—ñ –ø–∞–Ω–µ–ª—å –∑–∞–≤–∂–¥–∏ –≤–∏–¥–Ω–∞, –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞
                topPanelEl.style.display = "block";
                btnTopPanelEl.style.display = "none";
                // –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –¥–æ –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø–∞–Ω–µ–ª—å –±—É–¥–µ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                btnTopPanelEl.textContent = "–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å";
            } else {
                // –ø—ñ–¥ —á–∞—Å –ø—Ä–∞–∫—Ç–∏–∫–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Ö–æ–≤–∞—î–º–æ, –∞–ª–µ –¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –≤—ñ–¥–∫—Ä–∏—Ç–∏
                topPanelEl.style.display = topPanelVisibleInPractice ? "block" : "none";
                btnTopPanelEl.style.display = "inline-flex";
                btnTopPanelEl.textContent = topPanelVisibleInPractice ? "–°—Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å" : "–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å";
            }

            // 2) “ë–µ–π—Ç –∑–∞ –µ—Ç–∞–ø–∞–º–∏
            if (!kind) {
                btnNextEx.disabled = false;
                return;
            }

            btnNextEx.disabled = !stageState[kind].cleared;

            const cfg = GAME.stage[kind];
            const s = stageState[kind];
            const acc = Math.round(stageAccuracy(kind) * 100);
            const needAcc = Math.round(cfg.minAccuracy * 100);

            // —Å–º—É–∂–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—É –µ—Ç–∞–ø—É (—á–µ—Ä–≤–æ–Ω–∞ ‚Üí –∂–æ–≤—Ç–∞ ‚Üí –∑–µ–ª–µ–Ω–∞)
            if (stageBarWrapEl && stageBarEl) {
                if (currentExerciseStep === 0) {
                    stageBarWrapEl.style.display = "none";
                } else {
                    stageBarWrapEl.style.display = "block";
                    const progress = Math.max(0, Math.min(1, s.correct / cfg.needCorrect));
                    stageBarEl.style.width = `${Math.round(progress * 100)}%`;
                    const hue = Math.round(progress * 120); // 0=—á–µ—Ä–≤–æ–Ω–∏–π, 120=–∑–µ–ª–µ–Ω–∏–π
                    stageBarEl.style.backgroundColor = `hsl(${hue}, 85%, 45%)`;
                }
            }


            // —Ç–µ–∫—Å—Ç —Ä–æ–±–∏–º–æ "—ñ–≥—Ä–æ–≤–∏–º", –∞–ª–µ –∫–æ—Ä–æ—Ç–∫–∏–º
            exerciseStepEl.textContent =
                `–ï—Ç–∞–ø ${currentExerciseStep} –∑ 3 ‚Ä¢ ‚ù§Ô∏è ${s.lives} ‚Ä¢ ‚úÖ ${s.correct}/${cfg.needCorrect} ‚Ä¢ üéØ ${acc}% (–ø–æ—Ç—Ä—ñ–±–Ω–æ ${needAcc}%) ‚Ä¢ XP ${gameXP}`;
        }

        /* ====== –î–û–ü–û–ú–Ü–ñ–ù–Ü ====== */
        let autoNextTimeout = null;

        // –ª–æ–∫–∞–ª—å–Ω—ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–Ω—è
        let wrongAttemptsMC = 0;
        let wrongAttemptsWrite = 0;
        let wrongAttemptsSent = 0;

        function randInt(max) {
            return Math.floor(Math.random() * max);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = randInt(i + 1);
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function normalizeAnswer(str) {
            return str
                .toLowerCase()
                .replace(/\s+/g, " ")
                .trim()
                .replace(/[.!?]+$/, "");
        }

        function flashScreen(type) {
            const cls = type === "green" ? "flash-green" : "flash-red";
            document.body.classList.remove("flash-green", "flash-red");
            // –ø—Ä–∏–º—É—Å–æ–≤–∏–π reflow
            void document.body.offsetWidth;
            document.body.classList.add(cls);

            let duration = 500; // –∑–µ–ª–µ–Ω–µ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–æ–≤—à–µ
            if (type === "red") {
                duration = 750; // 0.25 * 3 –±–ª–∏–º–∞–Ω–Ω—è
            }

            setTimeout(() => {
                document.body.classList.remove(cls);
            }, duration);
        }

        function clearAutoNext() {
            if (autoNextTimeout !== null) {
                clearTimeout(autoNextTimeout);
                autoNextTimeout = null;
            }
        }

        /* ====== DOM ====== */
        const blockTitleEl = document.getElementById("block-title");
        const blockProgressTextEl = document.getElementById("block-progress-text");
        const exerciseStepEl = document.getElementById("exercise-step");
        const stageBarWrapEl = document.getElementById("stage-bar-wrap");
        const stageBarEl = document.getElementById("stage-bar");
        const explainEl = document.getElementById("explain");
        const btnToggleExplain = document.getElementById("btn-toggle-explain");

        const blockSelectEl = document.getElementById("block-select");

        const ex1Card = document.getElementById("ex1");
        const ex2Card = document.getElementById("ex2");
        const ex3Card = document.getElementById("ex3");

        // MC
        const mcQuestionEl = document.getElementById("mc-question");
        const mcOptionsEl = document.getElementById("mc-options");
        const mcFeedbackEl = document.getElementById("mc-feedback");
        const mcNextBtn = document.getElementById("mc-next");

        // write
        const wQuestionEl = document.getElementById("w-question");
        const wInputEl = document.getElementById("w-input");
        const wFeedbackEl = document.getElementById("w-feedback");
        const wCheckBtn = document.getElementById("w-check");
        const wShowBtn = document.getElementById("w-show");
        const wNextBtn = document.getElementById("w-next");

        // sentences
        const sQuestionEl = document.getElementById("s-question");
        const sInputEl = document.getElementById("s-input");
        const sFeedbackEl = document.getElementById("s-feedback");
        const sCheckBtn = document.getElementById("s-check");
        const sShowBtn = document.getElementById("s-show");
        const sNextBtn = document.getElementById("s-next");

        // –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è
        const btnPrev = document.getElementById("btn-prev");
        const btnNext = document.getElementById("btn-next");
        const btnNextEx = document.getElementById("btn-next-ex");
        const btnRestart = document.getElementById("btn-restart");

        const statsEl = document.getElementById("stats");

        const topPanelEl = document.getElementById("topPanel");
        const btnTopPanelEl = document.getElementById("btn-topPanel");

        // –ø–∞–Ω–µ–ª—å –∑–≤–µ—Ä—Ö—É: —Ö–æ–≤–∞—î–º–æ –ø—ñ–¥ —á–∞—Å –ø—Ä–∞–∫—Ç–∏–∫–∏, –ø–æ–∫–∞–∑—É—î–º–æ –ª–∏—à–µ –ø–æ –∫–Ω–æ–ø—Ü—ñ
        let topPanelVisibleInPractice = false;

        /* ====== –°–¢–ê–ù ====== */
        let currentBlockIndex = 0;
        // 0 ‚Äì –ª–∏—à–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è, 1 ‚Äì –≤–ø—Ä–∞–≤–∞ 1, 2 ‚Äì –≤–ø—Ä–∞–≤–∞ 2, 3 ‚Äì –≤–ø—Ä–∞–≤–∞ 3
        let currentExerciseStep = 0;
        let explainVisible = true;


        // –©–æ–± –Ω–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞–ª–æ—Å—è –æ–¥–Ω–µ –π —Ç–µ —Å–∞–º–µ –æ–¥—Ä–∞–∑—É –ø—ñ–¥—Ä—è–¥ (–º—ñ–Ω—ñ–º—É–º —á–µ—Ä–µ–∑ 1)
        let lastVocabIndexMC = -1;
        let lastVocabIndexWrite = -1;
        let lastSentenceIndex = -1;
        // ===== Sequencer: 1 pass in-order through all items (N), then random drill K=N*3 (repeats allowed) =====
        // –ö–æ–º—ñ—Ç: —Ç–µ–ø–µ—Ä —Ü–µ –û–î–ò–ù –ø–æ—Ç—ñ–∫ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤–ø—Ä–∞–≤–∏: N –ø–æ –ø–æ—Ä—è–¥–∫—É, –ø–æ—Ç—ñ–º N*3 —Ä–∞–Ω–¥–æ–º–æ–º –∑ —Ç–∏—Ö —Å–∞–º–∏—Ö N.
        function makeSeq() { return { pos: 0, last: -1, n: 0 }; }
        const seq = { mc: makeSeq(), write: makeSeq(), sent: makeSeq() };

        function resetSeq(kind, n) {
            seq[kind] = makeSeq();
            seq[kind].n = n || 0;
            seq[kind].pos = 0;
            seq[kind].last = -1;
        }

        function nextIndex(kind, n) {
            if (!seq[kind] || seq[kind].n !== n) resetSeq(kind, n);
            const s = seq[kind];
            if (n <= 0) return 0;

            let idx;
            if (s.pos < n) {
                // ordered pass
                idx = s.pos;
            } else {
                // drill
                idx = randIntExcept(n, s.last);
            }
            s.pos++;
            s.last = idx;
            return idx;
        }
        function randIntExcept(max, last) {
            if (max <= 1) return 0;
            let i = randInt(max);
            if (i === last) {
                // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                i = (i + 1 + randInt(max - 1)) % max;
                if (i === last) i = (i + 1) % max;
            }
            return i;
        }
        let currentVocabIndexMC = 0;
        let currentVocabIndexWrite = 0;
        let currentSentenceIndex = 0;

        const stats = {};

        function ensureStatsForBlock(index) {
            if (!stats[index]) {
                stats[index] = {
                    mc: { correct: 0, total: 0 },
                    write: { correct: 0, total: 0 },
                    sent: { correct: 0, total: 0 }
                };
            }
        }

        function updateStatsView() {
            ensureStatsForBlock(currentBlockIndex);
            const st = stats[currentBlockIndex];
            statsEl.textContent =
                `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏ (–ª–∏—à–µ –∑–∞ —Ü—é —Å–µ—Å—ñ—é): ` +
                `–≤–∏–±—ñ—Ä ‚Äî ${st.mc.correct}/${st.mc.total}, ` +
                `–Ω–∞–ø–∏—Å–∞–Ω–Ω—è ‚Äî ${st.write.correct}/${st.write.total}, ` +
                `—Ä–µ—á–µ–Ω–Ω—è ‚Äî ${st.sent.correct}/${st.sent.total}.`;
        }

        function updateExplainVisibility() {
            if (currentExerciseStep === 0) {
                // –ù–∞ –µ—Ç–∞–ø—ñ –ø–æ—è—Å–Ω–µ–Ω–Ω—è: –∑–∞–≤–∂–¥–∏ –≤–∏–¥–Ω–æ, –∫–Ω–æ–ø–∫—É –±–ª–æ–∫—É—î–º–æ
                explainVisible = true;
                explainEl.style.display = "block";
                btnToggleExplain.disabled = true;
                btnToggleExplain.textContent = "–°—Ö–æ–≤–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è";
            } else {
                // –ü—ñ–¥ —á–∞—Å –≤–ø—Ä–∞–≤ –∫–Ω–æ–ø–∫—É –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏
                btnToggleExplain.disabled = false;
                explainEl.style.display = explainVisible ? "block" : "none";
                btnToggleExplain.textContent = explainVisible
                    ? "–°—Ö–æ–≤–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è"
                    : "–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è";
            }
        }

        function updateExerciseVisibility() {
            ex1Card.style.display = (currentExerciseStep === 1) ? "block" : "none";
            ex2Card.style.display = (currentExerciseStep === 2) ? "block" : "none";
            ex3Card.style.display = (currentExerciseStep === 3) ? "block" : "none";

            if (currentExerciseStep === 0) {
                exerciseStepEl.textContent = "–°–ø–æ—á–∞—Ç–∫—É —Å–ø–æ–∫—ñ–π–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π –ø–æ—è—Å–Ω–µ–Ω–Ω—è, –ø–æ—Ç—ñ–º –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ü–æ—á–∞—Ç–∏ –≤–ø—Ä–∞–≤–∏¬ª.";
                btnNextEx.textContent = "–ü–æ—á–∞—Ç–∏ –≤–ø—Ä–∞–≤–∏";
            } else if (currentExerciseStep === 1) {
                exerciseStepEl.textContent = "–ï—Ç–∞–ø 1 –∑ 3: –ø—Ä–æ—Å—Ç–æ –æ–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É —Ñ—Ä–∞–∑—É.";
                btnNextEx.textContent = "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ 2-–≥–æ –µ—Ç–∞–ø—É";
            } else if (currentExerciseStep === 2) {
                exerciseStepEl.textContent = "–ï—Ç–∞–ø 2 –∑ 3: –Ω–∞–ø–∏—à–∏ —Ñ—Ä–∞–∑—É —Å–∞–º.";
                btnNextEx.textContent = "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ 3-–≥–æ –µ—Ç–∞–ø—É";
            } else {
                exerciseStepEl.textContent = "–ï—Ç–∞–ø 3 –∑ 3: –ø–µ—Ä–µ–∫–ª–∞–¥–∏ –º–∞–ª–µ–Ω—å–∫—ñ —Ä–µ—á–µ–Ω–Ω—è.";
                btnNextEx.textContent = "–£—Å—ñ –µ—Ç–∞–ø–∏ –ø—Ä–æ–π–¥–µ–Ω—ñ ‚Äî –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –≤–ø—Ä–∞–≤–∏";
            }

            updateExplainVisibility();
            updateGateUI();
        }

        function nextExerciseStep() {
            clearAutoNext();
            if (currentExerciseStep === 0) {
                currentExerciseStep = 1;
                explainVisible = false;
                updateExerciseVisibility();
                return;
            }

            if (currentExerciseStep < 3) {
                currentExerciseStep++;
                updateExerciseVisibility();
            } else {
                openModal({ title: "–í–∂–µ –æ—Å—Ç–∞–Ω–Ω—ñ–π –µ—Ç–∞–ø", text: "–¶—è –≤–ø—Ä–∞–≤–∞ –≤–∂–µ –Ω–∞ –æ—Å—Ç–∞–Ω–Ω—å–æ–º—É –µ—Ç–∞–ø—ñ. –ú–æ–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ —ó—ó –∞–±–æ –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—ñ.", primaryText: "–û–∫" });
            }
        }

        /* ====== –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –í–ü–†–ê–í–ò ====== */
        function loadBlock(index) {
            clearAutoNext();

            const total = blocks.length;
            if (index < 0) index = 0;
            if (index >= total) index = total - 1;

            currentBlockIndex = index;
            currentExerciseStep = 0;
            explainVisible = true;
            topPanelVisibleInPractice = false;
            resetAllStages();
            lastVocabIndexMC = -1;
            lastVocabIndexWrite = -1;
            lastSentenceIndex = -1;

            // reset sequencers for this block
            try {
                const b = blocks[currentBlockIndex];
                resetSeq("mc", (b.vocab && b.vocab.length) ? b.vocab.length : 0);
                resetSeq("write", (b.vocab && b.vocab.length) ? b.vocab.length : 0);
                resetSeq("sent", (b.sentences && b.sentences.length) ? b.sentences.length : 0);
            } catch (e) { }


            const block = blocks[currentBlockIndex];

            // Dynamic repetition rule (as requested):
            // 1 pass through all N items in order + random drill K=N*3 from the same items.
            // To prevent switching to the next exercise after the first pass, we require total correct = N*4.
            try {
                const nV = (block.vocab && block.vocab.length) ? block.vocab.length : 0;
                const nS = (block.sentences && block.sentences.length) ? block.sentences.length : 0;
                if (nV > 0) {
                    GAME.stage.mc.needCorrect = nV * 4;
                    GAME.stage.write.needCorrect = nV * 4;
                }
                if (nS > 0) {
                    GAME.stage.sent.needCorrect = nS * 4;
                }
            } catch (e) { }

            blockTitleEl.textContent = `–í–ø—Ä–∞–≤–∞ ${currentBlockIndex + 1}. ${block.title}`;
            blockProgressTextEl.textContent = `–í–ø—Ä–∞–≤–∞ ${currentBlockIndex + 1} –∑ ${total}`;
            explainEl.innerHTML = `
                                        ${block.topicTag ? `<div class="topic-tag">${block.topicTag}</div>` : ""}
                                        ${block.explanation}
                                    `;

            blockSelectEl.value = String(currentBlockIndex);

            btnPrev.disabled = currentBlockIndex === 0;
            btnNext.disabled = currentBlockIndex === total - 1;

            loadMCQuestion();
            loadWQuestion();
            loadSentence();

            mcFeedbackEl.textContent = "";
            mcFeedbackEl.className = "feedback";
            wFeedbackEl.textContent = "";
            wFeedbackEl.className = "feedback";
            sFeedbackEl.textContent = "";
            sFeedbackEl.className = "feedback";

            ensureStatsForBlock(currentBlockIndex);
            updateStatsView();
            updateExerciseVisibility();
        }

        /* ====== –í–ü–†–ê–í–ê 1 ‚Äì –í–ò–ë–Ü–† ====== */
        function loadMCQuestion() {
            clearAutoNext();
            wrongAttemptsMC = 0; // —Å–∫–∏–¥–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞

            const block = blocks[currentBlockIndex];
            if (!block.vocab || !block.vocab.length) {
                mcQuestionEl.textContent = "–î–ª—è —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏ –ø–æ–∫–∏ –Ω–µ–º–∞—î —Å–ª—ñ–≤.";
                mcOptionsEl.innerHTML = "";
                return;
            }

            currentVocabIndexMC = nextIndex('mc', block.vocab.length);
            lastVocabIndexMC = currentVocabIndexMC;
            const card = block.vocab[currentVocabIndexMC];

            mcQuestionEl.textContent = card.ua;
            mcFeedbackEl.textContent = "";
            mcFeedbackEl.className = "feedback";

            const maxOptions = Math.min(4, block.vocab.length);
            const options = [card.en];

            while (options.length < maxOptions) {
                const idx = randInt(block.vocab.length);
                const opt = block.vocab[idx].en;
                if (!options.includes(opt)) {
                    options.push(opt);
                }
            }

            shuffle(options);

            mcOptionsEl.innerHTML = "";
            options.forEach(text => {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.className = "option-btn";
                btn.addEventListener("click", () => checkMCAnswer(btn, text, card.en));
                mcOptionsEl.appendChild(btn);
            });
        }

        function checkMCAnswer(button, chosen, correct) {
            clearAutoNext();

            ensureStatsForBlock(currentBlockIndex);
            const st = stats[currentBlockIndex].mc;
            st.total++;

            if (normalizeAnswer(chosen) === normalizeAnswer(correct)) {
                flashScreen("green");
                mcFeedbackEl.textContent = "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!";
                mcFeedbackEl.className = "feedback correct";
                st.correct++;
                onCorrect("mc");

                speakSpanish(correct);
                // –ø–æ–∑–Ω–∞—á–∞—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É –∫–Ω–æ–ø–∫—É –∑–µ–ª–µ–Ω–∏–º
                button.classList.add("correct");

                updateStatsView();

                autoNextTimeout = setTimeout(() => {
                    loadMCQuestion();
                }, 900);
            } else {
                wrongAttemptsMC++;
                flashScreen("red");

                if (wrongAttemptsMC >= 3) {
                    mcFeedbackEl.textContent = "‚ùå –ù–µ –∑–æ–≤—Å—ñ–º. –ü—ñ–¥–∫–∞–∑–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å ‚Äî " + correct;
                    speakSpanish(correct);
                } else {
                    mcFeedbackEl.textContent = "‚ùå –ù–µ –∑–æ–≤—Å—ñ–º. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.";
                }

                mcFeedbackEl.className = "feedback wrong";
                // –ø—ñ–¥—Å–≤—ñ—Ç–∏—Ç–∏ –ª–∏—à–µ –æ–±—Ä–∞–Ω—É –∫–Ω–æ–ø–∫—É, –∞–ª–µ –Ω–µ –±–ª–æ–∫—É–≤–∞—Ç–∏ —ñ–Ω—à—ñ
                button.classList.add("wrong");

                onWrong("mc");
                updateStatsView();
            }
        }

        mcNextBtn.addEventListener("click", loadMCQuestion);

        /* ====== –í–ü–†–ê–í–ê 2 ‚Äì –ù–ê–ü–ò–°–ê–¢–ò ====== */
        function loadWQuestion() {
            clearAutoNext();
            wrongAttemptsWrite = 0; // —Å–∫–∏–¥–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –ø—Ä–∏ –Ω–æ–≤–æ–º—É —Å–ª–æ–≤—ñ

            const block = blocks[currentBlockIndex];
            if (!block.vocab || !block.vocab.length) {
                wQuestionEl.textContent = "–î–ª—è —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏ –ø–æ–∫–∏ –Ω–µ–º–∞—î —Å–ª—ñ–≤.";
                return;
            }

            currentVocabIndexWrite = nextIndex('write', block.vocab.length);
            lastVocabIndexWrite = currentVocabIndexWrite;
            const card = block.vocab[currentVocabIndexWrite];

            wQuestionEl.textContent = card.ua;
            wInputEl.value = "";
            wFeedbackEl.textContent = "";
            wFeedbackEl.className = "feedback";
        }

        function checkWAnswer() {
            clearAutoNext();
            const block = blocks[currentBlockIndex];
            if (!block.vocab || !block.vocab.length) return;

            const card = block.vocab[currentVocabIndexWrite];
            const user = wInputEl.value;
            if (!user.trim()) return;

            ensureStatsForBlock(currentBlockIndex);
            const st = stats[currentBlockIndex].write;
            st.total++;

            if (normalizeAnswer(user) === normalizeAnswer(card.en)) {
                flashScreen("green");
                wFeedbackEl.textContent = "‚úÖ –ß—É–¥–æ–≤–æ! –°–∞–º–µ —Ç–∞–∫ —ñ –ø–∏—à–µ—Ç—å—Å—è.";
                wFeedbackEl.className = "feedback correct";
                st.correct++;
                onCorrect("write");
                speakSpanish(card.en);
                updateStatsView();

                autoNextTimeout = setTimeout(() => {
                    loadWQuestion();
                }, 900);
            } else {
                wrongAttemptsWrite++;
                flashScreen("red");

                if (wrongAttemptsWrite >= 3) {
                    wFeedbackEl.textContent = "‚ùå –¢—Ä–æ—Ö–∏ –Ω–µ —Ç–∞–∫. –ü—ñ–¥–∫–∞–∑–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å ‚Äî " + card.en;
                    speakSpanish(card.en);
                } else {
                    wFeedbackEl.textContent = "‚ùå –¢—Ä–æ—Ö–∏ –Ω–µ —Ç–∞–∫. –í–∏–ø—Ä–∞–≤ —ñ –Ω–∞—Ç–∏—Å–Ω–∏ —â–µ —Ä–∞–∑.";
                }

                wFeedbackEl.className = "feedback wrong";
                onWrong("write");
                updateStatsView();
            }
        }

        function showWAnswer() {
            clearAutoNext();
            const block = blocks[currentBlockIndex];
            if (!block.vocab || !block.vocab.length) return;

            const card = block.vocab[currentVocabIndexWrite];
            wFeedbackEl.textContent = "–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: " + card.en;
            wFeedbackEl.className = "feedback";
            speakSpanish(card.en);
        }

        wCheckBtn.addEventListener("click", checkWAnswer);
        wShowBtn.addEventListener("click", showWAnswer);
        wNextBtn.addEventListener("click", loadWQuestion);
        wInputEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter") checkWAnswer();
        });

        /* ====== –í–ü–†–ê–í–ê 3 ‚Äì –†–ï–ß–ï–ù–ù–Ø ====== */
        function loadSentence() {
            clearAutoNext();
            wrongAttemptsSent = 0; // —Å–∫–∏–¥–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫

            const block = blocks[currentBlockIndex];
            if (!block.sentences || !block.sentences.length) {
                sQuestionEl.textContent = "–î–ª—è —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏ –ø–æ–∫–∏ –Ω–µ–º–∞—î —Ä–µ—á–µ–Ω—å.";
                sInputEl.value = "";
                sFeedbackEl.textContent = "";
                sFeedbackEl.className = "feedback";
                return;
            }

            currentSentenceIndex = nextIndex('sent', block.sentences.length);
            lastSentenceIndex = currentSentenceIndex;
            const card = block.sentences[currentSentenceIndex];

            sQuestionEl.textContent = card.ua;
            sInputEl.value = "";
            sFeedbackEl.textContent = "";
            sFeedbackEl.className = "feedback";
        }

        function checkSentence() {
            clearAutoNext();
            const block = blocks[currentBlockIndex];
            if (!block.sentences || !block.sentences.length) return;

            const card = block.sentences[currentSentenceIndex];
            const user = sInputEl.value;
            if (!user.trim()) return;

            ensureStatsForBlock(currentBlockIndex);
            const st = stats[currentBlockIndex].sent;
            st.total++;

            if (normalizeAnswer(user) === normalizeAnswer(card.en)) {
                flashScreen("green");
                sFeedbackEl.textContent = "‚úÖ –ß—É–¥–æ–≤–æ! –†–µ—á–µ–Ω–Ω—è –ø–µ—Ä–µ–∫–ª–∞–¥–µ–Ω–æ —Ç–æ—á–Ω–æ.";
                sFeedbackEl.className = "feedback correct";
                st.correct++;
                onCorrect("sent");
                speakSpanish(card.en);
                updateStatsView();

                autoNextTimeout = setTimeout(() => {
                    loadSentence();
                }, 900);
            } else {
                wrongAttemptsSent++;
                flashScreen("red");

                if (wrongAttemptsSent >= 3) {
                    sFeedbackEl.textContent = "‚ùå –¢—Ä–æ—Ö–∏ –Ω–µ —Ç–∞–∫. –ü—ñ–¥–∫–∞–∑–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç ‚Äî\n" + card.en;
                } else {
                    sFeedbackEl.textContent = "‚ùå –¢—Ä–æ—Ö–∏ –Ω–µ —Ç–∞–∫. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å¬ª.";
                }

                sFeedbackEl.className = "feedback wrong";
                onWrong("sent");
                updateStatsView();
            }
        }

        function showSentenceAnswer() {
            clearAutoNext();
            const block = blocks[currentBlockIndex];
            if (!block.sentences || !block.sentences.length) return;

            const card = block.sentences[currentSentenceIndex];
            sFeedbackEl.textContent = "–ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç:\n" + card.en;
            sFeedbackEl.className = "feedback";
            speakSpanish(card.en);
        }

        sCheckBtn.addEventListener("click", checkSentence);
        sShowBtn.addEventListener("click", showSentenceAnswer);
        sNextBtn.addEventListener("click", loadSentence);
        sInputEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) checkSentence();
        });

        /* ====== –ù–ê–í–Ü–ì–ê–¶–Ü–Ø, –ï–¢–ê–ü–ò, –†–ï–°–¢–ê–†–¢ ====== */
        btnPrev.addEventListener("click", () => {
            if (currentBlockIndex > 0) loadBlock(currentBlockIndex - 1);
        });

        btnNext.addEventListener("click", () => {
            if (currentBlockIndex < blocks.length - 1) loadBlock(currentBlockIndex + 1);
        });

        btnNextEx.addEventListener("click", nextExerciseStep);

        btnToggleExplain.addEventListener("click", () => {
            if (currentExerciseStep === 0) {
                explainVisible = true;
                updateExplainVisibility();
                return;
            }
            explainVisible = !explainVisible;
            updateExplainVisibility();
        });


        btnTopPanelEl.addEventListener("click", () => {
            // –ø—Ä–∞—Ü—é—î –ª–∏—à–µ –ø—ñ–¥ —á–∞—Å –ø—Ä–∞–∫—Ç–∏–∫–∏ (–µ—Ç–∞–ø 1‚Äì3)
            if (currentExerciseStep === 0) return;

            topPanelVisibleInPractice = !topPanelVisibleInPractice;
            updateGateUI();
        });

        blockSelectEl.addEventListener("change", () => {
            const idx = parseInt(blockSelectEl.value, 10);
            loadBlock(idx);
        });

        btnRestart.addEventListener("click", () => {
            clearAutoNext();
            // —Å–∫–∏–¥–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ª–∏—à–µ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó –≤–ø—Ä–∞–≤–∏
            stats[currentBlockIndex] = {
                mc: { correct: 0, total: 0 },
                write: { correct: 0, total: 0 },
                sent: { correct: 0, total: 0 }
            };
            updateStatsView();
            resetAllStages();
            lastVocabIndexMC = -1;
            lastVocabIndexWrite = -1;
            lastSentenceIndex = -1;

            // reset sequencers for this block
            try {
                const b = blocks[currentBlockIndex];
                resetSeq("mc", (b.vocab && b.vocab.length) ? b.vocab.length : 0);
                resetSeq("write", (b.vocab && b.vocab.length) ? b.vocab.length : 0);
                resetSeq("sent", (b.sentences && b.sentences.length) ? b.sentences.length : 0);
            } catch (e) { }

            gameXP = 0;
            // –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –Ω–∞ –µ—Ç–∞–ø –ø–æ—è—Å–Ω–µ–Ω–Ω—è —ñ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è
            currentExerciseStep = 0;
            explainVisible = true;
            updateExerciseVisibility();
            loadMCQuestion();
            loadWQuestion();
            loadSentence();
            window.scrollTo({ top: 0, behavior: "smooth" });
        });

        /* ====== –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ====== */
        (function init() {
            blocks.forEach((b, i) => {
                const opt = document.createElement("option");
                opt.value = String(i);
                opt.textContent = `${i + 1}. ${b.title}`;
                blockSelectEl.appendChild(opt);
            });
            loadBlock(0);
            try { resetStage('mc'); resetStage('write'); resetStage('sent'); } catch (e) { }

        })();

        // ===== Spanish TTS: –æ–∑–≤—É—á–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ =====
        let TTS_ENABLED = true;
        let TTS_LANG = "es-ES"; // –∞–±–æ "es-MX"

        function speakSpanish(text) {
            if (!TTS_ENABLED) return;
            if (!("speechSynthesis" in window)) return;
            try { window.speechSynthesis.cancel(); } catch (e) { }
            const u = new SpeechSynthesisUtterance(text);
            u.lang = TTS_LANG;
            u.rate = 0.95;
            u.pitch = 1.0;
            window.speechSynthesis.speak(u);
        }

    </script>
</body>
</html>
