# План: логіка вправ (поточний стан)

Оновлено за фактичним станом коду в `shared/js/app.js` і `course_config`.

---

## 1) Що реалізовано

### Об'єднаний етап 1 (MC + Write)
- Етап 1 працює як об'єднаний: спочатку `MC`, потім `Write` у межах батчів.
- Є стан:
  - `currentBatchStart`
  - `combinedStagePart` (`mc` / `write`)
  - `writeQueue`, `writeQueuePos`
- Розмір батчу:
  - `n < 10` -> `3`
  - `n >= 10` -> `5`
  - реалізовано через `getBatchSize(n)`.

### Правило 3/5 (життя та відкат)
- Працює через:
  - `getLivesMax(kind)`
  - `getRollbackSteps(kind)`
- Для малого набору -> 3, для великого -> 5.

### Перехідні модалки між частинами етапу 1
- `MC -> Write`: мотиваційна + "А тепер трохи складніше".
- `Write -> MC`: мотиваційна без суфікса "складніше".
- Підтримано через `getCombinedTransitionModalText(...)`.

### Помилки перед фінальним етапом (remediation)
- Є модалки і логіка опрацювання помилок перед переходом у фінальний етап.
- Формується список проблемних фраз за помилками `MC + Write`.
- Є раунди remediation (`remediationRound`, `remediationMaxRounds`).

### Прогрес етапу 1
- Рахується як єдина шкала для комбінованого етапу:
  - `getProgressPercentForBatchCombined()`
- Не скидається при переході `MC <-> Write` у межах етапу 1.

### Збереження/відновлення прогресу
- У `localStorage` зберігаються і відновлюються:
  - батч-стан (`currentBatchStart`, `combinedStagePart`)
  - черга `writeQueue`, `writeQueuePos`
  - лічильники помилок
  - стани remediation

### Рестарт/перезапуск
- При перезапуску вправи і при переході між блоками батч-стан обнуляється коректно.

---

## 2) Частково / не реалізовано з початкових побажань

- Підказка формату `N з B` прямо в UI блоку `Write`:
  - окремого стабільного текстового індикатора в карточці не додано.

---

## 3) Зроблено поза початковим планом

### Фінальний етап (sentences) перероблено
- Додано окрему чергу фінального етапу:
  - `sentQueue`, `sentQueuePos`
- На кожен новий прохід фінального етапу формується рандомний набір:
  - базово `ceil(N/3)`
  - мінімум `5`
  - виняток: якщо `N = 1`, лишається 1
  - для `N = 2..4` є повтори до 5 кроків.

### Прогрес фінального етапу
- Відображається у відсотках.
- Прив'язаний до фактичної довжини `sentQueue`.

### Resume/fail для фінального етапу
- Додано збереження/відновлення позиції `sentQueuePos`.
- Відкат при помилках у фінальному етапі враховує `sentQueuePos`.

### Мотиваційні повідомлення
- Додано градації з випадковими фразами (`motivationalMessages`) у `course_config`.

### Додаткові UI-фікси
- Внесено окремі CSS-фікси для контрасту кнопок у classic/mac темі.

---

## 4) Поточний короткий чеклист

| Завдання | Статус |
|---|---|
| Об'єднаний етап 1 (MC + Write) | Зроблено |
| Батчі 3/5 | Зроблено |
| Модалка "трохи складніше" перед Write | Зроблено |
| Логіка проблемних фраз перед фіналом | Зроблено |
| Прогрес етапу 1 без скидання | Зроблено |
| Збереження/відновлення батч-стану | Зроблено |
| Підказка `N з B` у Write | Частково / не окремим UI-елементом |
| Фінальний етап = 1/3 (мін. 5) | Зроблено (поза початковим планом) |
| Фінальний етап: % прогрес + queue resume | Зроблено (поза початковим планом) |

---

## 5) Важливо

- Цей документ описує **поточний фактичний стан**.
- Якщо буде новий раунд змін, документ треба оновлювати разом з кодом.
