<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English A0 ‚Äì —Ç—Ä–µ–Ω–∞–∂–µ—Ä (Video 01)</title>
    <style>
        :root {
            --base-font: 16px;
            --accent: #ffb74d;
            --accent-soft: #fff4e0;
            --card-bg: #ffffff;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 12px 12px 24px;
            line-height: 1.5;
            font-size: var(--base-font);
            box-sizing: border-box;
            background: #f5f5f5;
            transition: background-color 0.15s;
        }

        h1 {
            text-align: center;
            margin: 16px 0 4px;
            font-size: 1.4rem;
        }

        .subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }

        .warning {
            font-size: 0.85rem;
            color: #a15a00;
            background: var(--accent-soft);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 8px 10px;
            margin-bottom: 10px;
        }

        .top-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .block-selector-label {
            font-size: 0.85rem;
            color: #555;
        }

        select {
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            background: #fff;
        }

        .block-header {
            margin: 8px 0 4px;
        }

        .block-title {
            font-weight: 700;
            font-size: 1.05rem;
        }

        .block-progress {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--accent);
        }

        .exercise-step {
            font-size: 0.9rem;
            margin: 6px 0 8px;
            color: #333;
        }

        .explain {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            padding: 10px 12px;
            margin-bottom: 12px;
        }

        .topic-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 999px;
            background: #eef4ff;
            color: #244272;
            margin-bottom: 4px;
        }

        .explain h2 {
            margin: 2px 0 6px;
            font-size: 1rem;
        }

        .explain p {
            margin: 4px 0;
        }

        .explain ul {
            margin: 4px 0 4px 18px;
            padding: 0;
        }

        .explain li {
            margin-bottom: 3px;
        }

        .toggle-explain-row {
            margin-bottom: 6px;
            text-align: right;
        }

        .card {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            background: var(--card-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .label {
            font-size: 0.83rem;
            color: #555;
            margin-bottom: 4px;
        }

        .question {
            font-size: 1.05rem;
            margin-bottom: 8px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 8px;
        }

        .option-btn {
            text-align: left;
            width: 100%;
            border-radius: 999px;
            padding-left: 14px;
        }

            .option-btn.correct {
                border-color: #2e7d32;
                background: #e6f7e6;
            }

            .option-btn.wrong {
                border-color: #c62828;
                background: #ffecec;
            }

        .feedback {
            min-height: 20px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.92rem;
        }

            .feedback.correct {
                color: #2e7d32;
            }

            .feedback.wrong {
                color: #c62828;
            }

        .input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: nowrap;
        }

        input[type="text"], textarea {
            flex: 1 1 auto;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 0.95rem;
            min-width: 0;
            font-family: inherit;
            resize: vertical;
            background: #fafafa;
        }

        button {
            padding: 9px 13px;
            border-radius: 999px;
            border: 1px solid #ccc;
            cursor: pointer;
            font-size: 0.9rem;
            background: #fff;
            transition: background 0.15s, transform 0.05s, box-shadow 0.1s;
            touch-action: manipulation;
        }

            button:hover:enabled {
                background: #f5f5f5;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }

            button:active:enabled {
                transform: scale(0.97);
            }

            button.primary {
                border-color: #333;
                background: #f0f0f0;
                font-weight: 600;
            }

            button:disabled {
                opacity: 0.6;
                cursor: default;
                box-shadow: none;
            }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-top: 8px;
        }

            .nav-buttons button {
                flex: 1 1 0;
            }

        .next-ex-btn-wrap {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
            margin-top: 4px;
        }

        .stats {
            font-size: 0.8rem;
            color: #555;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 6px 8px;
            margin-top: 6px;
        }


        /* –°–º—É–≥–∞ –ø—Ä–æ–≥—Ä–µ—Å—É –µ—Ç–∞–ø—É (—á–µ—Ä–≤–æ–Ω–∞ ‚Üí –∂–æ–≤—Ç–∞ ‚Üí –∑–µ–ª–µ–Ω–∞) */
        #stage-bar-wrap{
            height: 10px;
            width: 100%;
            border-radius: 999px;
            background: #e6e6e6;
            overflow: hidden;
            margin: 10px 0 8px;
            border: 1px solid #ddd;
        }
        #stage-bar{
            height: 100%;
            width: 0%;
            background: #ff4d4d;
            border-radius: 999px;
            transition: width 0.25s ease, background-color 0.25s ease;
        }

        .small {
            font-size: 0.8rem;
            color: #777;
            margin-top: 6px;
            text-align: center;
        }

        /* –°–ø–∞–ª–∞—Ö–∏ –µ–∫—Ä–∞–Ω–∞ */
        @keyframes flash-green {
            0% {
                background-color: #c8f7c5;
            }

            100% {
                background-color: #f5f5f5;
            }
        }

        @keyframes flash-red {
            0% {
                background-color: #ffb3b3;
            }

            100% {
                background-color: #f5f5f5;
            }
        }

        /* –∑–µ–ª–µ–Ω–µ ‚Äì –æ–¥–∏–Ω —Ä–∞–∑, –∞–ª–µ –¥–æ–≤—à–µ; —á–µ—Ä–≤–æ–Ω–µ ‚Äì 1 –±–ª–∏–º–∞–Ω–Ω—è */
        body.flash-green {
            animation: flash-green 0.5s ease-out;
        }

        
        /* Toast for penalties */
        .toast-overlay{
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity .15s ease;
            z-index: 9999;
        }
        .toast-overlay.show{ opacity: 1; }
        .toast{
            max-width: 90vw;
            background: rgba(30,30,30,0.92);
            color: #fff;
            padding: 10px 14px;
            border-radius: 14px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }

        body.flash-red {
            animation: flash-red 0.5s ease-out 1;
        }

        .small-toggle{
            display:none;
            margin: 6px 0 10px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
                font-size: 15px;
            }

            h1 {
                font-size: 1.2rem;
                margin-top: 12px;
            }

            .input-row {
                flex-direction: column;
            }

                .input-row button {
                    width: 100%;
                }

            .nav-buttons {
                flex-direction: column;
            }

            .top-row {
                flex-direction: column;
                align-items: stretch;
            }

            select {
                width: 100%;
            }

            .toggle-explain-row {
                text-align: left;
            }
        }

        /* ====== MODAL (–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏, –∑–∞–º—ñ—Å—Ç—å confirm/alert) ====== */
        .modal-overlay{
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
        }
        .modal{
            width: min(520px, 100%);
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 18px 60px rgba(0,0,0,0.25);
            padding: 18px 18px 14px;
        }
        .modal h2{
            margin: 0 0 10px;
            font-size: 1.2rem;
        }
        .modal p{
            margin: 0 0 14px;
            line-height: 1.35;
            white-space: pre-wrap;
        }
        .modal-actions{
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        .modal-actions button{
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #cfcfcf;
            background: #fff;
            cursor: pointer;
            font-weight: 600;
        }
        .modal-actions button.primary{
            border-color: #222;
            background: #222;
            color: #fff;
        }

</style>
</head>
<body>
    <h1>English A0 ‚Äì —Ç—Ä–µ–Ω–∞–∂–µ—Ä (Video 01)</h1>
    <div class="subtitle">–ü–æ–∫—Ä–æ–∫–æ–≤—ñ –≤–ø—Ä–∞–≤–∏: –±–∞–∑–æ–≤—ñ —Ñ—Ä–∞–∑–∏ —Ç–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó (UA ‚Üí EN).</div>

    <div id="topPanel">
        <div class="warning">
            –ö—Ä–∞—â–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç–∏ –≤–ø—Ä–∞–≤–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É. –ú–æ–∂–Ω–∞ —Å—Ç—Ä–∏–±–∞—Ç–∏ –ø–æ —Å–ø–∏—Å–∫—É, –∞–ª–µ –º–æ–∑–æ–∫ –±—É–¥–µ —Å–∏–ª—å–Ω—ñ—à–µ –≤—Ç–æ–º–ª—é–≤–∞—Ç–∏—Å—è üôÇ
        </div>

        <div class="top-row">
            <div class="block-selector-label">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –≤–ø—Ä–∞–≤–∏:</div>
            <select id="block-select"></select>
            <button id="btn-tts" type="button">üîä –û–∑–≤—É—á–∫–∞: —É–≤—ñ–º–∫–Ω–µ–Ω–∞</button>
        </div>

        <div class="block-header">
            <div class="block-title" id="block-title"></div>
        </div>
        <div class="block-progress">
            <span class="progress-dot"></span>
            <span id="block-progress-text"></span>
        </div>
    </div>

    <button id="btn-topPanel" class="small-toggle">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å</button>

    <div class="exercise-step" id="exercise-step"></div>


    <div id="stage-bar-wrap" aria-label="–ü—Ä–æ–≥—Ä–µ—Å –µ—Ç–∞–ø—É"><div id="stage-bar"></div></div>
    <div class="toggle-explain-row">
        <button id="btn-toggle-explain">–°—Ö–æ–≤–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è</button>
    </div>

    <!-- –ü–û–Ø–°–ù–ï–ù–ù–Ø –í–ü–†–ê–í–ò -->
    <div id="explain" class="explain"></div>

    <!-- –í–ø—Ä–∞–≤–∞ 1: –≤–∏–±—ñ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Ñ—Ä–∞–∑–∏ -->
    <div id="ex1" class="card" style="display:none;">
        <div class="card-title">1Ô∏è‚É£ –í–∏–±—ñ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Ñ—Ä–∞–∑–∏</div>
        <div class="label">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ —Ñ—Ä–∞–∑–∞:</div>
        <div id="mc-question" class="question"></div>

        <div class="label">–û–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–µ—Ä–µ–∫–ª–∞–¥ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é:</div>
        <div id="mc-options" class="options"></div>

        <div id="mc-feedback" class="feedback"></div>
        <button id="mc-next" class="primary">–ù–∞—Å—Ç—É–ø–Ω–µ —Å–ª–æ–≤–æ –≤ —Ü—ñ–π –≤–ø—Ä–∞–≤—ñ</button>
    </div>

    <!-- –í–ø—Ä–∞–≤–∞ 2: –≤–ø–∏—Å–∞—Ç–∏ —Ñ—Ä–∞–∑—É -->
    <div id="ex2" class="card" style="display:none;">
        <div class="card-title">2Ô∏è‚É£ –ù–∞–ø–∏—Å–∞—Ç–∏ —Ñ—Ä–∞–∑—É —Å–∞–º–æ–º—É</div>
        <div class="label">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ —Ñ—Ä–∞–∑–∞:</div>
        <div id="w-question" class="question"></div>

        <div class="label">–ù–∞–ø–∏—à–∏ –ø–µ—Ä–µ–∫–ª–∞–¥ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é:</div>
        <div class="input-row">
            <input id="w-input" type="text" autocomplete="off">
            <button id="w-check">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
        </div>

        <div id="w-feedback" class="feedback"></div>
        <button id="w-show">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</button>
        <button id="w-next" class="primary">–ù–∞—Å—Ç—É–ø–Ω–µ —Å–ª–æ–≤–æ –≤ —Ü—ñ–π –≤–ø—Ä–∞–≤—ñ</button>
    </div>

    <!-- –í–ø—Ä–∞–≤–∞ 3: –ø–µ—Ä–µ–∫–ª–∞–¥ —Ä–µ—á–µ–Ω—å -->
    <div id="ex3" class="card" style="display:none;">
        <div class="card-title">3Ô∏è‚É£ –ü–µ—Ä–µ–∫–ª–∞–¥ –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ä–µ—á–µ–Ω—å</div>
        <div class="label">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π —Ç–µ–∫—Å—Ç:</div>
        <div id="s-question" class="question"></div>

        <div class="label">–ü–µ—Ä–µ–∫–ª–∞–¥–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é:</div>
        <div class="input-row">
            <textarea id="s-input" rows="3" autocomplete="off"></textarea>
            <button id="s-check">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
        </div>

        <div id="s-feedback" class="feedback"></div>
        <button id="s-show">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</button>
        <button id="s-next" class="primary">–ù–∞—Å—Ç—É–ø–Ω–µ —Ä–µ—á–µ–Ω–Ω—è –≤ —Ü—ñ–π –≤–ø—Ä–∞–≤—ñ</button>
    </div>

    <div class="next-ex-btn-wrap">
        <button id="btn-restart" class="primary">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ü—é –≤–ø—Ä–∞–≤—É</button>
        <button id="btn-next-ex" class="primary">–ü–æ—á–∞—Ç–∏ –≤–ø—Ä–∞–≤–∏</button>
    </div>

    <div id="stats" class="stats"></div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü—ñ—è –ø–æ –≤–ø—Ä–∞–≤–∞–º -->
    <div class="nav-buttons">
        <button id="btn-prev">‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—è –≤–ø—Ä–∞–≤–∞</button>
        <button id="btn-next">–ù–∞—Å—Ç—É–ø–Ω–∞ –≤–ø—Ä–∞–≤–∞ ‚Üí</button>
    </div>

    <div class="small">
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–∏—à–µ –ø–æ–∫–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞.
    </div>


    <!-- ====== MODAL (–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏) ====== -->
    <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal">
            <h2 id="modalTitle">–ì–æ—Ç–æ–≤–æ</h2>
            <p id="modalText"></p>
            <div class="modal-actions">
                <button id="modalSecondary">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑</button>
                <button id="modalPrimary" class="primary">–î–∞–ª—ñ</button>

                <button id="modalTertiary" class="secondary">–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –≤–ø—Ä–∞–≤—É</button>
            </div>
        </div>
    </div>

    <script>
        /* ====== –î–ê–ù–Ü –í–ü–†–ê–í ====== */
        const blocks = [
            {
                title: "I + verb",
                topicTag: "üß© –±–∞–∑–æ–≤–∞ –¥—ñ—è –ø—Ä–æ —Å–µ–±–µ",
                explanation: `
                                            <div class="topic-tag">üß© I + verb</div>
                                            <h2>I + verb</h2>
                                            <p><b>UA:</b> –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —â–æ–± —Å–∫–∞–∑–∞—Ç–∏, —â–æ —è —â–æ—Å—å —Ä–æ–±–ª—é –∞–±–æ —Ü–µ —Ñ–∞–∫—Ç –ø—Ä–æ –º–µ–Ω–µ.</p>
                                            <p><b>EN:</b> Used to say what I do or what is true about me.</p>
                                            <p><b>Form:</b> I + verb</p>
                                            <ul>
                                                <li>I understand ‚Äî –Ø —Ä–æ–∑—É–º—ñ—é</li>
                                                <li>I see ‚Äî –Ø –±–∞—á—É</li>
                                                <li>I work ‚Äî –Ø –ø—Ä–∞—Ü—é—é</li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø —Ä–æ–∑—É–º—ñ—é", en: "I understand" },
                    { ua: "–Ø –±–∞—á—É", en: "I see" },
                    { ua: "–Ø –ø—Ä–∞—Ü—é—é", en: "I work" }
                ],
                sentences: [
                    { ua: "–Ø —Ä–æ–∑—É–º—ñ—é —ñ –±–∞—á—É.", en: "I understand and I see." },
                    { ua: "–Ø –ø—Ä–∞—Ü—é—é.", en: "I work." }
                ]
            },
            {
                title: "I + verb + object",
                topicTag: "üéØ –¥—ñ—è –∑ –æ–±'—î–∫—Ç–æ–º",
                explanation: `
                                            <div class="topic-tag">üéØ I + verb + object</div>
                                            <h2>I + verb + object</h2>
                                            <p><b>UA:</b> –ö–æ–ª–∏ –¥—ñ—è —Å–ø—Ä—è–º–æ–≤–∞–Ω–∞ –Ω–∞ –æ–±‚Äô—î–∫—Ç –∞–±–æ –º–∞—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è.</p>
                                            <p><b>EN:</b> Used when the action has an object.</p>
                                            <p><b>Form:</b> I + verb + object</p>
                                            <ul>
                                                <li>I understand you ‚Äî –Ø —Ç–µ–±–µ —Ä–æ–∑—É–º—ñ—é</li>
                                                <li>I see you ‚Äî –Ø —Ç–µ–±–µ –±–∞—á—É</li>
                                                <li>I work online ‚Äî –Ø –ø—Ä–∞—Ü—é—é –æ–Ω–ª–∞–π–Ω</li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø —Ç–µ–±–µ —Ä–æ–∑—É–º—ñ—é", en: "I understand you" },
                    { ua: "–Ø —Ç–µ–±–µ –±–∞—á—É", en: "I see you" },
                    { ua: "–Ø –ø—Ä–∞—Ü—é—é –æ–Ω–ª–∞–π–Ω", en: "I work online" }
                ],
                sentences: [
                    { ua: "–Ø —Ç–µ–±–µ —Ä–æ–∑—É–º—ñ—é.", en: "I understand you." },
                    { ua: "–Ø –ø—Ä–∞—Ü—é—é –æ–Ω–ª–∞–π–Ω.", en: "I work online." }
                ]
            },
            {
                title: "I live in + place",
                topicTag: "üìç –¥–µ —è –∂–∏–≤—É",
                explanation: `
                                            <div class="topic-tag">üìç I live in + place</div>
                                            <h2>I live in + place</h2>
                                            <p><b>UA:</b> –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —â–æ–± —Å–∫–∞–∑–∞—Ç–∏, –¥–µ —è –∂–∏–≤—É.</p>
                                            <p><b>EN:</b> Used to say where I live.</p>
                                            <p><b>Form:</b> I live in + country / city / town</p>
                                            <ul>
                                                <li>I live in London ‚Äî –Ø –∂–∏–≤—É –≤ –õ–æ–Ω–¥–æ–Ω—ñ</li>
                                                <li>I live in New York ‚Äî –Ø –∂–∏–≤—É –≤ –ù—å—é-–ô–æ—Ä–∫—É</li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø –∂–∏–≤—É –≤ –õ–æ–Ω–¥–æ–Ω—ñ", en: "I live in London" },
                    { ua: "–Ø –∂–∏–≤—É –≤ –ù—å—é-–ô–æ—Ä–∫—É", en: "I live in New York" }
                ],
                sentences: [
                    { ua: "–Ø –∂–∏–≤—É –≤ –õ–æ–Ω–¥–æ–Ω—ñ.", en: "I live in London." },
                    { ua: "–Ø –∂–∏–≤—É –≤ –ù—å—é-–ô–æ—Ä–∫—É.", en: "I live in New York." }
                ]
            },
            {
                title: "I speak + language",
                topicTag: "üó£Ô∏è –º–æ–≤–∏",
                explanation: `
                                            <div class="topic-tag">üó£Ô∏è I speak + language</div>
                                            <h2>I speak + language</h2>
                                            <p><b>UA:</b> –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —â–æ–± —Å–∫–∞–∑–∞—Ç–∏, —è–∫–æ—é –º–æ–≤–æ—é —è –≥–æ–≤–æ—Ä—é.</p>
                                            <p><b>EN:</b> Used to say what language I speak.</p>
                                            <p><b>Form:</b> I speak + language</p>
                                            <ul>
                                                <li>I speak English ‚Äî –Ø –≥–æ–≤–æ—Ä—é –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é</li>
                                                <li>I speak Spanish ‚Äî –Ø –≥–æ–≤–æ—Ä—é —ñ—Å–ø–∞–Ω—Å—å–∫–æ—é</li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø –≥–æ–≤–æ—Ä—é –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é", en: "I speak English" },
                    { ua: "–Ø –≥–æ–≤–æ—Ä—é —ñ—Å–ø–∞–Ω—Å—å–∫–æ—é", en: "I speak Spanish" }
                ],
                sentences: [
                    { ua: "–Ø –≥–æ–≤–æ—Ä—é –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é.", en: "I speak English." },
                    { ua: "–Ø –≥–æ–≤–æ—Ä—é —ñ—Å–ø–∞–Ω—Å—å–∫–æ—é.", en: "I speak Spanish." }
                ]
            },
            {
                title: "I learn",
                topicTag: "üìö –Ω–∞–≤—á–∞–Ω–Ω—è",
                explanation: `
                                            <div class="topic-tag">üìö I learn</div>
                                            <h2>I learn</h2>
                                            <p><b>UA:</b> –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —â–æ–± —Å–∫–∞–∑–∞—Ç–∏, —â–æ —è —â–æ—Å—å –≤–∏–≤—á–∞—é.</p>
                                            <p><b>EN:</b> Used to say what I learn.</p>
                                            <p><b>Form:</b> I learn + object</p>
                                            <ul>
                                                <li>I learn English ‚Äî –Ø –≤–∏–≤—á–∞—é –∞–Ω–≥–ª—ñ–π—Å—å–∫—É</li>
                                                <li>I learn online ‚Äî –Ø –≤–∏–≤—á–∞—é –æ–Ω–ª–∞–π–Ω</li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø –≤–∏–≤—á–∞—é –∞–Ω–≥–ª—ñ–π—Å—å–∫—É", en: "I learn English" },
                    { ua: "–Ø –≤–∏–≤—á–∞—é –æ–Ω–ª–∞–π–Ω", en: "I learn online" }
                ],
                sentences: [
                    { ua: "–Ø –≤–∏–≤—á–∞—é –∞–Ω–≥–ª—ñ–π—Å—å–∫—É.", en: "I learn English." },
                    { ua: "–Ø –≤–∏–≤—á–∞—é –æ–Ω–ª–∞–π–Ω.", en: "I learn online." }
                ]
            },
            {
                title: "I like / I love",
                topicTag: "‚ù§Ô∏è –≤–ø–æ–¥–æ–±–∞–Ω–Ω—è",
                explanation: `
                                            <div class="topic-tag">‚ù§Ô∏è I like / I love</div>
                                            <h2>I like / I love</h2>
                                            <p><b>UA:</b> –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —â–æ–± —Å–∫–∞–∑–∞—Ç–∏, —â–æ –º–µ–Ω—ñ –ø–æ–¥–æ–±–∞—î—Ç—å—Å—è –∞–±–æ —â–æ —è –ª—é–±–ª—é.</p>
                                            <p><b>EN:</b> Used to express liking or love.</p>
                                            <p><b>Form:</b> I like / I love + object</p>
                                            <ul>
                                                <li>I like music ‚Äî –ú–µ–Ω—ñ –ø–æ–¥–æ–±–∞—î—Ç—å—Å—è –º—É–∑–∏–∫–∞</li>
                                                <li>I love you ‚Äî –Ø —Ç–µ–±–µ –ª—é–±–ª—é</li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–ú–µ–Ω—ñ –ø–æ–¥–æ–±–∞—î—Ç—å—Å—è –º—É–∑–∏–∫–∞", en: "I like music" },
                    { ua: "–Ø —Ç–µ–±–µ –ª—é–±–ª—é", en: "I love you" }
                ],
                sentences: [
                    { ua: "–ú–µ–Ω—ñ –ø–æ–¥–æ–±–∞—î—Ç—å—Å—è –º—É–∑–∏–∫–∞.", en: "I like music." },
                    { ua: "–Ø —Ç–µ–±–µ –ª—é–±–ª—é.", en: "I love you." }
                ]
            },
            {
                title: "here / there / often",
                topicTag: "üìå –º—ñ—Å—Ü–µ —ñ —á–∞—Å—Ç–æ—Ç–∞",
                explanation: `
                                            <div class="topic-tag">üìå here / there / often</div>
                                            <h2>here / there / often</h2>
                                            <p><b>UA:</b> –°–ª–æ–≤–∞ –º—ñ—Å—Ü—è —Ç–∞ —á–∞—Å—Ç–æ—Ç–∏ –¥—ñ—ó.</p>
                                            <p><b>EN:</b> Words of place and frequency.</p>
                                            <p><b>Form:</b> here / there / often</p>
                                            <ul>
                                                <li>I live here ‚Äî –Ø –∂–∏–≤—É —Ç—É—Ç</li>
                                                <li>I work there ‚Äî –Ø –ø—Ä–∞—Ü—é—é —Ç–∞–º</li>
                                                <li>I often work online ‚Äî –Ø —á–∞—Å—Ç–æ –ø—Ä–∞—Ü—é—é –æ–Ω–ª–∞–π–Ω</li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø –∂–∏–≤—É —Ç—É—Ç", en: "I live here" },
                    { ua: "–Ø –ø—Ä–∞—Ü—é—é —Ç–∞–º", en: "I work there" },
                    { ua: "–Ø —á–∞—Å—Ç–æ –ø—Ä–∞—Ü—é—é –æ–Ω–ª–∞–π–Ω", en: "I often work online" }
                ],
                sentences: [
                    { ua: "–Ø –∂–∏–≤—É —Ç—É—Ç.", en: "I live here." },
                    { ua: "–Ø —á–∞—Å—Ç–æ –ø—Ä–∞—Ü—é—é –æ–Ω–ª–∞–π–Ω.", en: "I often work online." }
                ]
            },
            {
                title: "I have / I can",
                topicTag: "üõ†Ô∏è –º–∞—Ç–∏ —ñ –º–æ–≥—Ç–∏",
                explanation: `
                                            <div class="topic-tag">üõ†Ô∏è I have / I can</div>
                                            <h2>I have / I can</h2>
                                            <p><b>UA:</b> I have ‚Äî –º–∞—Ç–∏ —â–æ—Å—å; I can ‚Äî –≤–º—ñ—Ç–∏ –∞–±–æ –º–æ–≥—Ç–∏ —â–æ—Å—å –∑—Ä–æ–±–∏—Ç–∏.</p>
                                            <p><b>EN:</b> I have ‚Äî possession; I can ‚Äî ability.</p>
                                            <p><b>Form:</b> I have + object / I can + verb</p>
                                            <ul>
                                                <li>I have time ‚Äî –Ø –º–∞—é —á–∞—Å</li>
                                                <li>I can speak English ‚Äî –Ø –º–æ–∂—É –≥–æ–≤–æ—Ä–∏—Ç–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é</li>
                                            </ul>
                                        `,
                vocab: [
                    { ua: "–Ø –º–∞—é —á–∞—Å", en: "I have time" },
                    { ua: "–Ø –º–æ–∂—É –≥–æ–≤–æ—Ä–∏—Ç–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é", en: "I can speak English" }
                ],
                sentences: [
                    { ua: "–Ø –º–∞—é —á–∞—Å.", en: "I have time." },
                    { ua: "–Ø –º–æ–∂—É –≥–æ–≤–æ—Ä–∏—Ç–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é.", en: "I can speak English." }
                ]
            }
        ];


        /* ====== –Ü–ì–†–û–í–ê –õ–û–ì–Ü–ö–ê (—Ü—ñ–ª—ñ –µ—Ç–∞–ø—ñ–≤) ====== */
        const GAME = {
            livesPerStage: 3,
            stage: {
                mc: { needCorrect: 5, minAccuracy: 0.70 },
                write: { needCorrect: 5, minAccuracy: 0.70 },
                sent: { needCorrect: 3, minAccuracy: 0.60 }
            },
            stars: {
                two: 0.85,
                three: 0.95,
                streakForThree: 5
            }
        };

        let gameXP = 0;

        let stageState = {
            mc: { correct: 0, attempts: 0, streak: 0, lives: 3, cleared: false, stars: 0 },
            write: { correct: 0, attempts: 0, streak: 0, lives: 3, cleared: false, stars: 0 },
            sent: { correct: 0, attempts: 0, streak: 0, lives: 3, cleared: false, stars: 0 }
        };


        // ====== –ö–æ–º—ñ—Ç–∏: —à—Ç—Ä–∞—Ñ –∑–∞–º—ñ—Å—Ç—å —Å–∫–∏–¥–∞–Ω–Ω—è ======
        // –ü—Ä–∞–≤–∏–ª–∞:
        // - –Ø–∫—â–æ N <= 3: 3 –∂–∏—Ç—Ç—è, —à—Ç—Ä–∞—Ñ = –≤—ñ–¥–∫–∞—Ç –Ω–∞ 3
        // - –Ø–∫—â–æ N > 3: 5 –∂–∏—Ç—Ç—ñ–≤ (–º–∞–∫—Å), —à—Ç—Ä–∞—Ñ = –≤—ñ–¥–∫–∞—Ç –Ω–∞ 5
        // - –ñ–û–î–ù–ò–• –ø–æ–≤–Ω–∏—Ö —Å–∫–∏–¥—ñ–≤ –Ω–∞–∑–∞–¥. –õ–∏—à–µ –≤—ñ–¥–∫–∞—Ç correct —ñ –ø–æ–∑–∏—Ü—ñ—ó –ø–æ–∫–∞–∑—É.
        function getNFor(kind) {
            const b = blocks[currentBlockIndex];
            if (kind === "sent") return (b.sentences && b.sentences.length) ? b.sentences.length : 0;
            return (b.vocab && b.vocab.length) ? b.vocab.length : 0;
        }
        function getLivesMax(kind) {
            const n = getNFor(kind);
            return (n <= 3) ? 3 : 5;
        }
        function getRollbackSteps(kind) {
            // —à—Ç—Ä–∞—Ñ = 3 –∞–±–æ 5 (–Ω–µ –±—ñ–ª—å—à–µ 5)
            const n = getNFor(kind);
            return (n <= 3) ? 3 : 5;
        }

        function showToast(msg) {
            const ov = document.getElementById("toastOverlay");
            const el = document.getElementById("toastMsg");
            if (!ov || !el) return;
            el.textContent = msg;
            ov.classList.add("show");
            ov.setAttribute("aria-hidden", "false");
            setTimeout(() => {
                ov.classList.remove("show");
                ov.setAttribute("aria-hidden", "true");
            }, 1200);
        }

        function resetStage(kind) {
            stageState[kind] = { correct: 0, attempts: 0, streak: 0, lives: getLivesMax(kind), cleared: false, stars: 0 };
        }

        function resetAllStages() {
            resetStage("mc");
            resetStage("write");
            resetStage("sent");
        }

        // --- UX helpers: –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –µ—Ç–∞–ø—É/–≤–ø—Ä–∞–≤–∏ —ñ "–ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏" ---
        function restartStage(kind) {
            clearAutoNext();
            resetStage(kind);

            // —Å–∫–∏–¥–∞–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –ø—ñ–¥–∫–∞–∑–∫–∏
            if (kind === "mc") { wrongAttemptsMC = 0; lastVocabIndexMC = -1; try { const b = blocks[currentBlockIndex]; resetSeq("mc", (b.vocab && b.vocab.length) ? b.vocab.length : 0); } catch (e) { } loadMCQuestion(); }
            if (kind === "write") { wrongAttemptsWrite = 0; lastVocabIndexWrite = -1; try { const b = blocks[currentBlockIndex]; resetSeq("write", (b.vocab && b.vocab.length) ? b.vocab.length : 0); } catch (e) { } loadWQuestion(); }
            if (kind === "sent") { wrongAttemptsSent = 0; lastSentenceIndex = -1; try { const b = blocks[currentBlockIndex]; resetSeq("sent", (b.sentences && b.sentences.length) ? b.sentences.length : 0); } catch (e) { } loadSentence(); }

            updateExerciseVisibility();
            updateGateUI();
        }

        function restartCurrentBlock() {
            clearAutoNext();
            // —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—î—ó –≤–ø—Ä–∞–≤–∏ (—ñ –ø—Ä–æ–≥—Ä–µ—Å—É –µ—Ç–∞–ø—ñ–≤)
            try { if (typeof resetAllStages === "function") resetAllStages(); } catch (e) { }

            // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ü—ñ—î—ó —Å–µ—Å—ñ—ó (stats) —á—ñ–ø–∞—î–º–æ –ª–∏—à–µ —è–∫—â–æ –≤–æ–Ω–∞ –≤–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞
            try {
                if (typeof stats !== "undefined") {
                    stats[currentBlockIndex] = {
                        mc: { correct: 0, total: 0 },
                        write: { correct: 0, total: 0 },
                        sent: { correct: 0, total: 0 }
                    };
                }
            } catch (e) { }

            loadBlock(currentBlockIndex);
            try { if (typeof updateStatsView === "function") updateStatsView(); } catch (e) { }
        }

        function goNextStep() {
            clearAutoNext();
            nextExerciseStep();
        }

        function nextBlock() {
            clearAutoNext();
            if (currentBlockIndex < blocks.length - 1) {
                loadBlock(currentBlockIndex + 1);
            } else {
                // —è–∫—â–æ —Ü–µ –æ—Å—Ç–∞–Ω–Ω—è –≤–ø—Ä–∞–≤–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É —ñ –ª–∏—à–∞—î–º–æ—Å—è —Ç—É—Ç
                loadBlock(currentBlockIndex);
            }
        }

        function stageAccuracy(kind) {
            const s = stageState[kind];
            return s.attempts ? (s.correct / s.attempts) : 0;
        }

        function getStageGoal(kind) {
            const cfg = GAME.stage[kind];
            const n = getNFor(kind);
            if (!n) {
                return { needCorrect: 0, minAccuracy: cfg.minAccuracy };
            }
            return {
                needCorrect: Math.max(1, Math.min(cfg.needCorrect, n)),
                minAccuracy: cfg.minAccuracy
            };
        }

        function stageGoalMet(kind) {
            const { needCorrect, minAccuracy } = getStageGoal(kind);
            const s = stageState[kind];
            if (!needCorrect) return true;
            return s.correct >= needCorrect && stageAccuracy(kind) >= minAccuracy;
        }

        function calcStars(kind) {
            const s = stageState[kind];
            if (!s.cleared) return 0;
            const a = stageAccuracy(kind);
            if (a >= GAME.stars.three && s.streak >= GAME.stars.streakForThree) return 3;
            if (a >= GAME.stars.two) return 2;
            return 1;
        }

        function currentKind() {
            if (currentExerciseStep === 1) return "mc";
            if (currentExerciseStep === 2) return "write";
            if (currentExerciseStep === 3) return "sent";
            return null;
        }


        // ====== MODAL helpers ======
        const modalOverlayEl = document.getElementById("modalOverlay");
        const modalTitleEl = document.getElementById("modalTitle");
        const modalTextEl = document.getElementById("modalText");
        const modalPrimaryEl = document.getElementById("modalPrimary");
        const modalSecondaryEl = document.getElementById("modalSecondary");
        const modalTertiaryEl = document.getElementById("modalTertiary");

        let modalPrimaryAction = null;
        let modalSecondaryAction = null;
        let modalTertiaryAction = null;

        function openModal({ title, text, primaryText = "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏", secondaryText = null, tertiaryText = null, onPrimary = null, onSecondary = null, onTertiary = null }) {
            modalTitleEl.textContent = title;
            modalTextEl.textContent = text;

            modalPrimaryEl.textContent = primaryText;
            modalSecondaryEl.textContent = secondaryText || "";
            modalTertiaryEl.textContent = tertiaryText || "";

            modalPrimaryAction = onPrimary;
            modalSecondaryAction = onSecondary;
            modalTertiaryAction = onTertiary;

            modalSecondaryEl.style.display = secondaryText ? "inline-flex" : "none";
            modalTertiaryEl.style.display = tertiaryText ? "inline-flex" : "none";

            modalOverlayEl.style.display = "flex";
            modalOverlayEl.setAttribute("aria-hidden", "false");

            // —Ñ–æ–∫—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ñ–π –∫–Ω–æ–ø—Ü—ñ
            modalPrimaryEl.focus();
        }

        function closeModal() {
            modalOverlayEl.style.display = "none";
            modalOverlayEl.setAttribute("aria-hidden", "true");
            modalPrimaryAction = null;
            modalSecondaryAction = null;
            modalTertiaryAction = null;
        }

        modalPrimaryEl.addEventListener("click", () => {
            const fn = modalPrimaryAction;
            closeModal();
            if (typeof fn === "function") fn();
        });

        modalSecondaryEl.addEventListener("click", () => {
            const fn = modalSecondaryAction;
            closeModal();
            if (typeof fn === "function") fn();
        });



        modalTertiaryEl.addEventListener("click", () => {
            const fn = modalTertiaryAction;
            closeModal();
            if (typeof fn === "function") fn();
        });
        // –∑–∞–∫—Ä–∏—Ç—Ç—è –∫–ª—ñ–∫–æ–º –ø–æ –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—é
        modalOverlayEl.addEventListener("click", (e) => {
            if (e.target === modalOverlayEl) {
                closeModal();
            }
        });

        function showVictory(kind) {
            clearAutoNext();

            // –í —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ —Ç–µ—Ö-—è—Ä–ª–∏–∫–∏ MC/WRITE/SENT.
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –Ω–æ–º–µ—Ä –µ—Ç–∞–ø—É 1..3 –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:
            const stageNumber = (kind === "mc") ? 1 : (kind === "write") ? 2 : 3;

            // –Ø–∫—â–æ —Ü–µ –æ—Å—Ç–∞–Ω–Ω—ñ–π –µ—Ç–∞–ø —ñ –≤—ñ–Ω –ø—Ä–æ–π–¥–µ–Ω–∏–π ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤–ø—Ä–∞–≤–∏
            const isFinalStage = (kind === "sent");
            const exerciseDone = isFinalStage && stageState.mc.cleared && stageState.write.cleared && stageState.sent.cleared;

            if (exerciseDone) {
                // –ú–æ–∂–µ–º–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥—Å—É–º–∫–æ–≤—ñ –∑—ñ—Ä–∫–∏ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–º –µ—Ç–∞–ø–æ–º (–∞–±–æ –ø—Ä–æ—Å—Ç–æ ‚≠ê‚≠ê‚≠ê –∑–∞ –±–∞–∂–∞–Ω–Ω—è–º).
                const stars = calcStars(kind);
                stageState[kind].stars = stars;

                openModal({
                    title: "–£–†–ê! –í–ò –ü–†–û–ô–®–õ–ò –¶–Æ –í–ü–†–ê–í–£ üéâ " + "‚≠ê".repeat(stars),
                    text: "–í–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤—Å—ñ –µ—Ç–∞–ø–∏ —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏.",
                    primaryText: "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –Ω–∞–≤—á–∞–Ω–Ω—è",
                    secondaryText: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π –µ—Ç–∞–ø",
                    tertiaryText: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –≤–ø—Ä–∞–≤—É",
                    onPrimary: () => {
                        closeModal();
                        nextBlock(); // –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –≤–ø—Ä–∞–≤–∏
                    },
                    onSecondary: () => {
                        closeModal();
                        restartStage(kind); // —Å–∫–∏–¥–∞–Ω–Ω—è –ª–∏—à–µ –µ—Ç–∞–ø—É 3
                    },
                    onTertiary: () => {
                        closeModal();
                        restartCurrentBlock(); // —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—î—ó –≤–ø—Ä–∞–≤–∏
                    }
                });
                return;
            }

            // –ó–≤–∏—á–∞–π–Ω–∞ –ø–µ—Ä–µ–º–æ–≥–∞ –µ—Ç–∞–ø—É
            const stars = calcStars(kind);
            stageState[kind].stars = stars;

            openModal({
                title: "–ï–¢–ê–ü " + stageNumber + " –ó 3 –ü–†–û–ô–î–ï–ù–û  " + "‚≠ê".repeat(stars),
                text: "–ß—É–¥–æ–≤–æ! –ú–æ–∂–µ—à –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∞–±–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Ü–µ–π –µ—Ç–∞–ø.",
                primaryText: "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏",
                secondaryText: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –µ—Ç–∞–ø",
                tertiaryText: "",
                onPrimary: () => {
                    closeModal();
                    goNextStep(); // –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –µ—Ç–∞–ø
                },
                onSecondary: () => {
                    closeModal();
                    restartStage(kind); // —Å–∫–∏–¥–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É –ø–æ—Ç–æ—á–Ω–æ–≥–æ –µ—Ç–∞–ø—É
                }
            });
        }

        function showFail(kind) {
            clearAutoNext();

            // –®—Ç—Ä–∞—Ñ –∑–∞–º—ñ—Å—Ç—å —Å–∫–∏–¥–∞–Ω–Ω—è: –≤—ñ–¥–∫–∞—Ç –Ω–∞ 3 –∞–±–æ 5, –ø–æ—Ç—ñ–º –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ
            const rollback = getRollbackSteps(kind);
            const s = stageState[kind];

            // –≤—ñ–¥–∫–∞—Ç –ø—Ä–æ–≥—Ä–µ—Å—É (–∞–ª–µ –Ω–µ –Ω–∏–∂—á–µ 0)
            s.correct = Math.max(0, s.correct - rollback);
            // –∂–∏—Ç—Ç—è –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –¥–æ –º–∞–∫—Å–∏–º—É–º—É –¥–ª—è —Ü—å–æ–≥–æ N
            s.lives = getLivesMax(kind);

            // –≤—ñ–¥–∫–∞—Ç –ø–æ–∑–∏—Ü—ñ—ó –ø–æ–∫–∞–∑—É (—â–æ–± —Ä–µ–∞–ª—å–Ω–æ –ø–æ–≤—Ç–æ—Ä—é–≤–∞–ª–æ, –∞ –Ω–µ –ø–µ—Ä–µ—Å–∫–∞–∫—É–≤–∞–ª–æ)
            try {
                if (seq && seq[kind]) {
                    seq[kind].pos = Math.max(0, (seq[kind].pos || 0) - rollback);
                    seq[kind].last = -1;
                }
            } catch (e) { }

            // —ñ–≥—Ä–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è + —á–µ—Ä–≤–æ–Ω–∞ –≤—Å–ø–∏—à–∫–∞
            flashScreen("red");
            showToast(`–£–ø—Å! –ü–æ–º–∏–ª–∫–∞ üòÖ –®—Ç—Ä–∞—Ñ: -${rollback}`);

            updateGateUI();

            // –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –µ—Ç–∞–ø
            if (kind === "mc") loadMCQuestion();
            if (kind === "write") loadWQuestion();
            if (kind === "sent") loadSentence();
        }
        function onCorrect(kind) {
            const s = stageState[kind];
            s.attempts++;
            s.correct++;
            s.streak++;
            gameXP += 10;

            if (!s.cleared && stageGoalMet(kind)) {
                s.cleared = true;
                s.stars = calcStars(kind);
                updateGateUI();
                showVictory(kind);
                return;
            }

            updateGateUI();
        }

        function onWrong(kind) {
            const s = stageState[kind];
            s.attempts++;
            s.streak = 0;
            s.lives--;

            if (s.lives <= 0) {
                showFail(kind);
                return;
            }

            updateGateUI();
        }

        function updateGateUI() {
            const kind = currentKind();

            // 1) –≤–µ—Ä—Ö–Ω—è –ø–∞–Ω–µ–ª—å (–º–µ–Ω—à–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –ø—Ä–∞–∫—Ç–∏–∫–∏)
            if (currentExerciseStep === 0) {
                // –Ω–∞ –ø–æ—è—Å–Ω–µ–Ω–Ω—ñ –ø–∞–Ω–µ–ª—å –∑–∞–≤–∂–¥–∏ –≤–∏–¥–Ω–∞, –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞
                topPanelEl.style.display = "block";
                btnTopPanelEl.style.display = "none";
                // –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –¥–æ –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø–∞–Ω–µ–ª—å –±—É–¥–µ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                btnTopPanelEl.textContent = "–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å";
            } else {
                // –ø—ñ–¥ —á–∞—Å –ø—Ä–∞–∫—Ç–∏–∫–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Ö–æ–≤–∞—î–º–æ, –∞–ª–µ –¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –≤—ñ–¥–∫—Ä–∏—Ç–∏
                topPanelEl.style.display = topPanelVisibleInPractice ? "block" : "none";
                btnTopPanelEl.style.display = "inline-flex";
                btnTopPanelEl.textContent = topPanelVisibleInPractice ? "–°—Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å" : "–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å";
            }

            // 2) “ë–µ–π—Ç –∑–∞ –µ—Ç–∞–ø–∞–º–∏
            if (!kind) {
                btnNextEx.disabled = false;
                return;
            }

            btnNextEx.disabled = !stageState[kind].cleared;

            const cfg = getStageGoal(kind);
            const s = stageState[kind];
            const acc = Math.round(stageAccuracy(kind) * 100);
            const needAcc = Math.round(cfg.minAccuracy * 100);

            // —Å–º—É–∂–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—É –µ—Ç–∞–ø—É (—á–µ—Ä–≤–æ–Ω–∞ ‚Üí –∂–æ–≤—Ç–∞ ‚Üí –∑–µ–ª–µ–Ω–∞)
            if (stageBarWrapEl && stageBarEl) {
                if (currentExerciseStep === 0) {
                    stageBarWrapEl.style.display = "none";
                } else {
                    stageBarWrapEl.style.display = "block";
                    const progress = cfg.needCorrect ? Math.max(0, Math.min(1, s.correct / cfg.needCorrect)) : 1;
                    stageBarEl.style.width = `${Math.round(progress * 100)}%`;
                    const hue = Math.round(progress * 120); // 0=—á–µ—Ä–≤–æ–Ω–∏–π, 120=–∑–µ–ª–µ–Ω–∏–π
                    stageBarEl.style.backgroundColor = `hsl(${hue}, 85%, 45%)`;
                }
            }


            // —Ç–µ–∫—Å—Ç —Ä–æ–±–∏–º–æ "—ñ–≥—Ä–æ–≤–∏–º", –∞–ª–µ –∫–æ—Ä–æ—Ç–∫–∏–º
            exerciseStepEl.textContent =
                `–ï—Ç–∞–ø ${currentExerciseStep} –∑ 3 ‚Ä¢ ‚ù§Ô∏è ${s.lives} ‚Ä¢ ‚úÖ ${s.correct}/${cfg.needCorrect} ‚Ä¢ üéØ ${acc}% (–ø–æ—Ç—Ä—ñ–±–Ω–æ ${needAcc}%) ‚Ä¢ XP ${gameXP}`;
        }

        /* ====== –î–û–ü–û–ú–Ü–ñ–ù–Ü ====== */
        let autoNextTimeout = null;

        // –ª–æ–∫–∞–ª—å–Ω—ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–Ω—è
        let wrongAttemptsMC = 0;
        let wrongAttemptsWrite = 0;
        let wrongAttemptsSent = 0;

        function randInt(max) {
            return Math.floor(Math.random() * max);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = randInt(i + 1);
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function flashScreen(color) {
            document.body.classList.remove("flash-green", "flash-red");
            if (color === "green") document.body.classList.add("flash-green");
            if (color === "red") document.body.classList.add("flash-red");
        }

        function clearAutoNext() {
            if (autoNextTimeout) {
                clearTimeout(autoNextTimeout);
                autoNextTimeout = null;
            }
        }

        function normalizeText(str) {
            return (str || "")
                .trim()
                .toLowerCase()
                .replace(/[‚Äô‚Äò]/g, "'")
                .replace(/\s+/g, " ");
        }

        // ====== TTS (English) ======
        let ttsEnabled = true;
        const ttsLanguage = "en-US";

        function speakEnglish(text) {
            if (!ttsEnabled) return;
            if (!("speechSynthesis" in window)) return;
            try { window.speechSynthesis.cancel(); } catch (e) { }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = ttsLanguage;
            utterance.rate = 0.95;
            utterance.pitch = 1.0;
            window.speechSynthesis.speak(utterance);
        }

        // ====== –†–ï–ù–î–ï–† –ü–ê–ù–ï–õ–Ü + EXPLAIN ======
        const blockSelectEl = document.getElementById("block-select");
        const blockTitleEl = document.getElementById("block-title");
        const blockProgressTextEl = document.getElementById("block-progress-text");
        const explainEl = document.getElementById("explain");
        const btnToggleExplain = document.getElementById("btn-toggle-explain");
        const topPanelEl = document.getElementById("topPanel");
        const btnTopPanelEl = document.getElementById("btn-topPanel");
        const btnTtsEl = document.getElementById("btn-tts");

        const stageBarWrapEl = document.getElementById("stage-bar-wrap");
        const stageBarEl = document.getElementById("stage-bar");

        const toastOverlayEl = document.createElement("div");
        toastOverlayEl.id = "toastOverlay";
        toastOverlayEl.className = "toast-overlay";
        toastOverlayEl.setAttribute("aria-hidden", "true");
        toastOverlayEl.innerHTML = '<div class="toast" id="toastMsg"></div>';
        document.body.appendChild(toastOverlayEl);

        let currentBlockIndex = 0;
        let currentExerciseStep = 0; // 0 = –ø–æ—è—Å–Ω–µ–Ω–Ω—è, 1/2/3 = –µ—Ç–∞–ø–∏
        let explainVisible = true;
        let topPanelVisibleInPractice = false;

        // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–Ω–∞ —Å–µ—Å—ñ—é)
        let stats = blocks.map(() => ({
            mc: { correct: 0, total: 0 },
            write: { correct: 0, total: 0 },
            sent: { correct: 0, total: 0 }
        }));

        function buildBlockSelect() {
            blockSelectEl.innerHTML = "";
            blocks.forEach((b, idx) => {
                const opt = document.createElement("option");
                opt.value = idx;
                opt.textContent = `${idx + 1}. ${b.title}`;
                blockSelectEl.appendChild(opt);
            });
        }

        function updateBlockHeader() {
            const b = blocks[currentBlockIndex];
            blockTitleEl.textContent = b.title;
            blockProgressTextEl.textContent = `–í–ø—Ä–∞–≤–∞ ${currentBlockIndex + 1} –∑ ${blocks.length}`;
            blockSelectEl.value = currentBlockIndex;
        }

        function updateStatsView() {
            const s = stats[currentBlockIndex];
            const totalCorrect = s.mc.correct + s.write.correct + s.sent.correct;
            const totalAttempts = s.mc.total + s.write.total + s.sent.total;
            const acc = totalAttempts ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
            document.getElementById("stats").textContent =
                `–í—Å—å–æ–≥–æ: ${totalCorrect}/${totalAttempts} ‚Ä¢ –¢–æ—á–Ω—ñ—Å—Ç—å: ${acc}%`;
        }

        function updateExerciseVisibility() {
            const ex1 = document.getElementById("ex1");
            const ex2 = document.getElementById("ex2");
            const ex3 = document.getElementById("ex3");

            ex1.style.display = (currentExerciseStep === 1) ? "block" : "none";
            ex2.style.display = (currentExerciseStep === 2) ? "block" : "none";
            ex3.style.display = (currentExerciseStep === 3) ? "block" : "none";

            explainEl.style.display = (currentExerciseStep === 0 && explainVisible) ? "block" : "none";
            btnToggleExplain.style.display = (currentExerciseStep === 0) ? "inline-flex" : "inline-flex";
        }

        // ====== –ü–û–°–õ–Ü–î–û–í–ù–Ü–°–¢–¨ –î–õ–Ø –ù–ï–ü–û–í–¢–û–†–ï–ù–ù–Ø ======
        function makeSequence(n) {
            const order = Array.from({ length: n }, (_, i) => i);
            shuffle(order);
            return { order, pos: 0, last: -1 };
        }

        const seq = {
            mc: null,
            write: null,
            sent: null
        };

        function resetSeq(kind, n) {
            seq[kind] = makeSequence(n);
        }

        function nextIndex(kind, n) {
            if (!seq[kind] || seq[kind].order.length !== n) resetSeq(kind, n);
            const s = seq[kind];
            if (s.pos >= s.order.length) {
                resetSeq(kind, n);
            }
            let idx = s.order[s.pos++];
            if (idx === s.last && n > 1) {
                idx = s.order[s.pos++ % s.order.length];
            }
            s.last = idx;
            return idx;
        }

        // ====== EX1: Multiple Choice ======
        const mcQuestionEl = document.getElementById("mc-question");
        const mcOptionsEl = document.getElementById("mc-options");
        const mcFeedbackEl = document.getElementById("mc-feedback");
        const mcNextBtn = document.getElementById("mc-next");
        let mcAnswer = "";
        let lastVocabIndexMC = -1;

        function loadMCQuestion() {
            const vocab = blocks[currentBlockIndex].vocab;
            if (!vocab || vocab.length === 0) return;

            const idx = nextIndex("mc", vocab.length);
            lastVocabIndexMC = idx;
            const item = vocab[idx];
            mcQuestionEl.textContent = item.ua;
            mcAnswer = item.en;

            // options = 1 correct + 3 random
            const options = [item.en];
            const otherItems = vocab.filter((_, i) => i !== idx);
            shuffle(otherItems);
            for (let i = 0; i < Math.min(3, otherItems.length); i++) {
                options.push(otherItems[i].en);
            }
            shuffle(options);

            mcOptionsEl.innerHTML = "";
            options.forEach(opt => {
                const btn = document.createElement("button");
                btn.className = "option-btn";
                btn.textContent = opt;
                btn.onclick = () => checkMCAnswer(btn, opt);
                mcOptionsEl.appendChild(btn);
            });

            mcFeedbackEl.textContent = "";
            wrongAttemptsMC = 0;
        }

        function checkMCAnswer(btn, opt) {
            const isCorrect = normalizeText(opt) === normalizeText(mcAnswer);

            mcFeedbackEl.textContent = isCorrect ? "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!" : "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ";
            mcFeedbackEl.className = "feedback " + (isCorrect ? "correct" : "wrong");

            if (isCorrect) {
                btn.classList.add("correct");
                flashScreen("green");
                onCorrect("mc");
                speakEnglish(mcAnswer);
            } else {
                btn.classList.add("wrong");
                flashScreen("red");
                onWrong("mc");
                wrongAttemptsMC++;
            }

            if (isCorrect) {
                autoNextTimeout = setTimeout(() => {
                    loadMCQuestion();
                }, 450);
            } else if (wrongAttemptsMC >= 2) {
                mcFeedbackEl.textContent = `‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: ${mcAnswer}`;
            }
        }

        mcNextBtn.addEventListener("click", () => {
            loadMCQuestion();
        });

        // ====== EX2: Write Answer ======
        const wQuestionEl = document.getElementById("w-question");
        const wInputEl = document.getElementById("w-input");
        const wFeedbackEl = document.getElementById("w-feedback");
        const wCheckBtn = document.getElementById("w-check");
        const wShowBtn = document.getElementById("w-show");
        const wNextBtn = document.getElementById("w-next");
        let wAnswer = "";
        let lastVocabIndexWrite = -1;

        function loadWQuestion() {
            const vocab = blocks[currentBlockIndex].vocab;
            if (!vocab || vocab.length === 0) return;

            const idx = nextIndex("write", vocab.length);
            lastVocabIndexWrite = idx;
            const item = vocab[idx];
            wQuestionEl.textContent = item.ua;
            wAnswer = item.en;
            wInputEl.value = "";
            wFeedbackEl.textContent = "";
            wrongAttemptsWrite = 0;
        }

        function checkWriteAnswer() {
            const user = normalizeText(wInputEl.value);
            const correct = normalizeText(wAnswer);
            const isCorrect = user === correct;

            wFeedbackEl.textContent = isCorrect ? "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!" : "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ";
            wFeedbackEl.className = "feedback " + (isCorrect ? "correct" : "wrong");

            if (isCorrect) {
                flashScreen("green");
                onCorrect("write");
                speakEnglish(wAnswer);
                autoNextTimeout = setTimeout(() => {
                    loadWQuestion();
                }, 500);
            } else {
                flashScreen("red");
                onWrong("write");
                wrongAttemptsWrite++;
            }
        }

        wCheckBtn.addEventListener("click", checkWriteAnswer);
        wInputEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                checkWriteAnswer();
            }
        });

        wShowBtn.addEventListener("click", () => {
            wFeedbackEl.textContent = `‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: ${wAnswer}`;
            wFeedbackEl.className = "feedback correct";
        });

        wNextBtn.addEventListener("click", () => {
            loadWQuestion();
        });

        // ====== EX3: Sentences ======
        const sQuestionEl = document.getElementById("s-question");
        const sInputEl = document.getElementById("s-input");
        const sFeedbackEl = document.getElementById("s-feedback");
        const sCheckBtn = document.getElementById("s-check");
        const sShowBtn = document.getElementById("s-show");
        const sNextBtn = document.getElementById("s-next");
        let sAnswer = "";
        let lastSentenceIndex = -1;

        function loadSentence() {
            const sentences = blocks[currentBlockIndex].sentences;
            if (!sentences || sentences.length === 0) return;

            const idx = nextIndex("sent", sentences.length);
            lastSentenceIndex = idx;
            const item = sentences[idx];
            sQuestionEl.textContent = item.ua;
            sAnswer = item.en;
            sInputEl.value = "";
            sFeedbackEl.textContent = "";
            wrongAttemptsSent = 0;
        }

        function checkSentence() {
            const user = normalizeText(sInputEl.value);
            const correct = normalizeText(sAnswer);
            const isCorrect = user === correct;

            sFeedbackEl.textContent = isCorrect ? "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!" : "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ";
            sFeedbackEl.className = "feedback " + (isCorrect ? "correct" : "wrong");

            if (isCorrect) {
                flashScreen("green");
                onCorrect("sent");
                speakEnglish(sAnswer);
                autoNextTimeout = setTimeout(() => {
                    loadSentence();
                }, 500);
            } else {
                flashScreen("red");
                onWrong("sent");
                wrongAttemptsSent++;
            }
        }

        sCheckBtn.addEventListener("click", checkSentence);
        sInputEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                checkSentence();
            }
        });

        sShowBtn.addEventListener("click", () => {
            sFeedbackEl.textContent = `‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: ${sAnswer}`;
            sFeedbackEl.className = "feedback correct";
        });

        sNextBtn.addEventListener("click", () => {
            loadSentence();
        });

        // ====== –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –ø–æ –±–ª–æ–∫–∞–º —ñ –µ—Ç–∞–ø–∞–º ======
        function loadBlock(index) {
            currentBlockIndex = index;
            currentExerciseStep = 0;
            explainVisible = true;
            topPanelVisibleInPractice = false;

            updateBlockHeader();
            updateStatsView();

            // Reset stage state for new block
            resetAllStages();
            updateGateUI();

            const block = blocks[currentBlockIndex];
            explainEl.innerHTML = `
                    ${block.explanation}
                `;

            updateExerciseVisibility();

            // Reset sequences
            resetSeq("mc", block.vocab ? block.vocab.length : 0);
            resetSeq("write", block.vocab ? block.vocab.length : 0);
            resetSeq("sent", block.sentences ? block.sentences.length : 0);

            loadMCQuestion();
            loadWQuestion();
            loadSentence();
        }

        function nextExerciseStep() {
            if (currentExerciseStep < 3) {
                currentExerciseStep++;
            }
            updateExerciseVisibility();
            updateGateUI();
        }

        document.getElementById("btn-next-ex").addEventListener("click", () => {
            if (currentExerciseStep === 0) {
                currentExerciseStep = 1;
            } else if (currentExerciseStep < 3) {
                currentExerciseStep++;
            }
            updateExerciseVisibility();
            updateGateUI();
        });

        document.getElementById("btn-prev").addEventListener("click", () => {
            if (currentBlockIndex > 0) {
                loadBlock(currentBlockIndex - 1);
            }
        });

        document.getElementById("btn-next").addEventListener("click", () => {
            if (currentBlockIndex < blocks.length - 1) {
                loadBlock(currentBlockIndex + 1);
            }
        });

        document.getElementById("btn-restart").addEventListener("click", () => {
            restartCurrentBlock();
        });

        blockSelectEl.addEventListener("change", (e) => {
            const idx = parseInt(e.target.value, 10);
            loadBlock(idx);
        });

        btnToggleExplain.addEventListener("click", () => {
            explainVisible = !explainVisible;
            explainEl.style.display = explainVisible ? "block" : "none";
            btnToggleExplain.textContent = explainVisible ? "–°—Ö–æ–≤–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è" : "–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è";
        });

        btnTopPanelEl.addEventListener("click", () => {
            topPanelVisibleInPractice = !topPanelVisibleInPractice;
            updateGateUI();
        });

        btnTtsEl.addEventListener("click", () => {
            ttsEnabled = !ttsEnabled;
            btnTtsEl.textContent = ttsEnabled ? "üîä –û–∑–≤—É—á–∫–∞: —É–≤—ñ–º–∫–Ω–µ–Ω–∞" : "üîá –û–∑–≤—É—á–∫–∞: –≤–∏–º–∫–Ω–µ–Ω–∞";
        });

        // Init
        buildBlockSelect();
        loadBlock(0);
    </script>
</body>
</html>
