<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English A0 ‚Äì —Ç—Ä–µ–Ω–∞–∂–µ—Ä (Video 01)</title>
    <style>
        :root {
            --base-font: 16px;
            --accent: #ffb74d;
            --accent-soft: #fff4e0;
            --card-bg: #ffffff;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 12px 12px 24px;
            line-height: 1.5;
            font-size: var(--base-font);
            box-sizing: border-box;
            background: #f5f5f5;
            transition: background-color 0.15s;
        }

        h1 {
            text-align: center;
            margin: 16px 0 4px;
            font-size: 1.4rem;
        }

        .subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }

        .warning {
            font-size: 0.85rem;
            color: #a15a00;
            background: var(--accent-soft);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 8px 10px;
            margin-bottom: 10px;
        }

        .top-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .block-selector-label {
            font-size: 0.85rem;
            color: #555;
        }

        select {
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            background: #fff;
        }

        .block-header {
            margin: 8px 0 4px;
        }

        .block-title {
            font-weight: 700;
            font-size: 1.05rem;
        }

        .block-progress {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--accent);
        }

        .exercise-step {
            font-size: 0.9rem;
            margin: 6px 0 8px;
            color: #333;
        }

        .explain {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            padding: 10px 12px;
            margin-bottom: 12px;
        }

        .topic-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 999px;
            background: #eef4ff;
            color: #244272;
            margin-bottom: 4px;
        }

        .explain h2 {
            margin: 2px 0 6px;
            font-size: 1rem;
        }

        .explain p {
            margin: 4px 0;
        }

        .explain ul {
            margin: 4px 0 4px 18px;
            padding: 0;
        }

        .explain li {
            margin-bottom: 3px;
        }

        .toggle-explain-row {
            margin-bottom: 6px;
            text-align: right;
        }

        .card {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            background: var(--card-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .label {
            font-size: 0.83rem;
            color: #555;
            margin-bottom: 4px;
        }

        .question {
            font-size: 1.05rem;
            margin-bottom: 8px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 8px;
        }

        .option-btn {
            text-align: left;
            width: 100%;
            border-radius: 999px;
            padding-left: 14px;
        }

            .option-btn.correct {
                border-color: #2e7d32;
                background: #e6f7e6;
            }

            .option-btn.wrong {
                border-color: #c62828;
                background: #ffecec;
            }

        .feedback {
            min-height: 20px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.92rem;
        }

            .feedback.correct {
                color: #2e7d32;
            }

            .feedback.wrong {
                color: #c62828;
            }

        .input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: nowrap;
        }

        input[type="text"], textarea {
            flex: 1 1 auto;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 0.95rem;
            min-width: 0;
            font-family: inherit;
            resize: vertical;
            background: #fafafa;
        }

        button {
            padding: 9px 13px;
            border-radius: 999px;
            border: 1px solid #ccc;
            cursor: pointer;
            font-size: 0.9rem;
            background: #fff;
            transition: background 0.15s, transform 0.05s, box-shadow 0.1s;
            touch-action: manipulation;
        }

            button:hover:enabled {
                background: #f5f5f5;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }

            button:active:enabled {
                transform: scale(0.97);
            }

            button.primary {
                border-color: #333;
                background: #f0f0f0;
                font-weight: 600;
            }

            button:disabled {
                opacity: 0.6;
                cursor: default;
                box-shadow: none;
            }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-top: 8px;
        }

            .nav-buttons button {
                flex: 1 1 0;
            }

        .next-ex-btn-wrap {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
            margin-top: 4px;
        }

        .stats {
            font-size: 0.8rem;
            color: #555;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 6px 8px;
            margin-top: 6px;
        }


        /* –ü–æ–ª–æ—Å–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —ç—Ç–∞–ø–∞ (–∫—Ä–∞—Å–Ω–∞—è ‚Üí –∂—ë–ª—Ç–∞—è ‚Üí –∑–µ–ª—ë–Ω–∞—è) */
        #stage-bar-wrap{
            height: 10px;
            width: 100%;
            border-radius: 999px;
            background: #e6e6e6;
            overflow: hidden;
            margin: 10px 0 8px;
            border: 1px solid #ddd;
        }
        #stage-bar{
            height: 100%;
            width: 0%;
            background: #ff4d4d;
            border-radius: 999px;
            transition: width 0.25s ease, background-color 0.25s ease;
        }

        .small {
            font-size: 0.8rem;
            color: #777;
            margin-top: 6px;
            text-align: center;
        }

        /* –í—Å–ø—ã—à–∫–∏ —ç–∫—Ä–∞–Ω–∞ */
        @keyframes flash-green {
            0% {
                background-color: #c8f7c5;
            }

            100% {
                background-color: #f5f5f5;
            }
        }

        @keyframes flash-red {
            0% {
                background-color: #ffb3b3;
            }

            100% {
                background-color: #f5f5f5;
            }
        }

        /* –∑–µ–ª—ë–Ω–æ–µ ‚Äì –æ–¥–∏–Ω —Ä–∞–∑, –Ω–æ –¥–æ–ª—å—à–µ; –∫—Ä–∞—Å–Ω–æ–µ ‚Äì 1 –º–∏–≥–∞–Ω–∏—è */
        body.flash-green {
            animation: flash-green 0.5s ease-out;
        }

        
        /* Toast for penalties */
        .toast-overlay{
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity .15s ease;
            z-index: 9999;
        }
        .toast-overlay.show{ opacity: 1; }
        .toast{
            max-width: 90vw;
            background: rgba(30,30,30,0.92);
            color: #fff;
            padding: 10px 14px;
            border-radius: 14px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }

        body.flash-red {
            animation: flash-red 0.5s ease-out 1;
        }

        .small-toggle{
            display:none;
            margin: 6px 0 10px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
                font-size: 15px;
            }

            h1 {
                font-size: 1.2rem;
                margin-top: 12px;
            }

            .input-row {
                flex-direction: column;
            }

                .input-row button {
                    width: 100%;
                }

            .nav-buttons {
                flex-direction: column;
            }

            .top-row {
                flex-direction: column;
                align-items: stretch;
            }

            select {
                width: 100%;
            }

            .toggle-explain-row {
                text-align: left;
            }
        }
    
        /* ====== MODAL (–≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≤–º–µ—Å—Ç–æ confirm/alert) ====== */
        .modal-overlay{
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
        }
        .modal{
            width: min(520px, 100%);
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 18px 60px rgba(0,0,0,0.25);
            padding: 18px 18px 14px;
        }
        .modal h2{
            margin: 0 0 10px;
            font-size: 1.2rem;
        }
        .modal p{
            margin: 0 0 14px;
            line-height: 1.35;
            white-space: pre-wrap;
        }
        .modal-actions{
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        .modal-actions button{
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #cfcfcf;
            background: #fff;
            cursor: pointer;
            font-weight: 600;
        }
        .modal-actions button.primary{
            border-color: #222;
            background: #222;
            color: #fff;
        }

</style>
</head>
<body>
    <h1>English A0 ‚Äì —Ç—Ä–µ–Ω–∞–∂–µ—Ä (Video 01)</h1>
    <div class="subtitle">–ü–æ–∫—Ä–æ–∫–æ–≤—ñ –≤–ø—Ä–∞–≤–∏: Video 01 (UA ‚Üí EN).</div>

    <div id="topPanel">
<div class="warning">
        –ö—Ä–∞—â–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç–∏ –≤–ø—Ä–∞–≤–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É. –ú–æ–∂–Ω–∞ —Å—Ç—Ä–∏–±–∞—Ç–∏ –ø–æ —Å–ø–∏—Å–∫—É, –∞–ª–µ –º–æ–∑–æ–∫ –±—É–¥–µ —Å–∏–ª—å–Ω—ñ—à–µ –≤—Ç–æ–º–ª—é–≤–∞—Ç–∏—Å—è üôÇ
    </div>

    <div class="top-row">
        <div class="block-selector-label">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –≤–ø—Ä–∞–≤–∏:</div>
        <select id="block-select"></select>
    </div>

    <div class="block-header">
        <div class="block-title" id="block-title"></div>
</div>
        <div class="block-progress">
            <span class="progress-dot"></span>
            <span id="block-progress-text"></span>
        </div>
    </div>

    <button id="btn-topPanel" class="small-toggle">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å</button>

    <div class="exercise-step" id="exercise-step"></div>

    
    <div id="stage-bar-wrap" aria-label="–ü—Ä–æ–≥—Ä–µ—Å –µ—Ç–∞–ø—É"><div id="stage-bar"></div></div>
<div class="toggle-explain-row">
        <button id="btn-toggle-explain">–°—Ö–æ–≤–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è</button>
    </div>

    <!-- –û–ë–™–Ø–°–ù–ï–ù–ò–ï –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø -->
    <div id="explain" class="explain"></div>

    <!-- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 1: –≤—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ñ—Ä–∞–∑—ã -->
    <div id="ex1" class="card" style="display:none;">
        <div class="card-title">1Ô∏è‚É£ –í–∏–±—ñ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Ñ—Ä–∞–∑–∏</div>
        <div class="label">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ —Ñ—Ä–∞–∑–∞:</div>
        <div id="mc-question" class="question"></div>

        <div class="label">–û–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–µ—Ä–µ–∫–ª–∞–¥ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é:</div>
        <div id="mc-options" class="options"></div>

        <div id="mc-feedback" class="feedback"></div>
        <button id="mc-next" class="primary">–ù–∞—Å—Ç—É–ø–Ω–µ —Å–ª–æ–≤–æ –≤ —Ü—ñ–π –≤–ø—Ä–∞–≤—ñ</button>
    </div>

    <!-- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 2: –≤–ø–∏—Å–∞—Ç—å —Ñ—Ä–∞–∑—É -->
    <div id="ex2" class="card" style="display:none;">
        <div class="card-title">2Ô∏è‚É£ –ù–∞–ø–∏—Å–∞—Ç–∏ —Ñ—Ä–∞–∑—É —Å–∞–º–æ–º—É</div>
        <div class="label">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ —Ñ—Ä–∞–∑–∞:</div>
        <div id="w-question" class="question"></div>

        <div class="label">–ù–∞–ø–∏—à–∏ –ø–µ—Ä–µ–∫–ª–∞–¥ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é:</div>
        <div class="input-row">
            <input id="w-input" type="text" autocomplete="off">
            <button id="w-check">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
        </div>

        <div id="w-feedback" class="feedback"></div>
        <button id="w-show">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</button>
        <button id="w-next" class="primary">–ù–∞—Å—Ç—É–ø–Ω–µ —Å–ª–æ–≤–æ –≤ —Ü—ñ–π –≤–ø—Ä–∞–≤—ñ</button>
    </div>

    <!-- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 3: –ø–µ—Ä–µ–≤–æ–¥ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π -->
    <div id="ex3" class="card" style="display:none;">
        <div class="card-title">3Ô∏è‚É£ –ü–µ—Ä–µ–∫–ª–∞–¥ –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ä–µ—á–µ–Ω—å</div>
        <div class="label">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π —Ç–µ–∫—Å—Ç:</div>
        <div id="s-question" class="question"></div>

        <div class="label">–ü–µ—Ä–µ–∫–ª–∞–¥–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é:</div>
        <div class="input-row">
            <textarea id="s-input" rows="3" autocomplete="off"></textarea>
            <button id="s-check">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
        </div>

        <div id="s-feedback" class="feedback"></div>
        <button id="s-show">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</button>
        <button id="s-next" class="primary">–ù–∞—Å—Ç—É–ø–Ω–µ —Ä–µ—á–µ–Ω–Ω—è –≤ —Ü—ñ–π –≤–ø—Ä–∞–≤—ñ</button>
    </div>

    <div class="next-ex-btn-wrap">
        <button id="btn-restart" class="primary">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ü—é –≤–ø—Ä–∞–≤—É</button>
        <button id="btn-next-ex" class="primary">–ü–æ—á–∞—Ç–∏ –≤–ø—Ä–∞–≤–∏</button>
    </div>

    <div id="stats" class="stats"></div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–ø—Ä–∞–≤–∏–º -->
    <div class="nav-buttons">
        <button id="btn-prev">‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—è –≤–ø—Ä–∞–≤–∞</button>
        <button id="btn-next">–ù–∞—Å—Ç—É–ø–Ω–∞ –≤–ø—Ä–∞–≤–∞ ‚Üí</button>
    </div>

    <div class="small">
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–∏—à–µ –ø–æ–∫–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞.
    </div>

    
    <!-- ====== MODAL (–≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã) ====== -->
    <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal">
            <h2 id="modalTitle">–ì–æ—Ç–æ–≤–æ</h2>
            <p id="modalText"></p>
            <div class="modal-actions">
                <button id="modalSecondary">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑</button>
                <button id="modalPrimary" class="primary">–î–∞–ª—ñ</button>
            
                <button id="modalTertiary" class="secondary">–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –≤–ø—Ä–∞–≤—É</button>
            </div>
        </div>
    </div>

<script>
        /* ====== –î–ê–ù–Ü –í–ü–†–ê–í ====== */
        const blocks = [
            {
                title: "Video 01",
                topicTag: "English A0 ‚Äî Video 01",
                explanation: `
                        <div class="topic-tag">English A0 ‚Äî Video 01</div>
                        <h2>I + verb</h2>
                        <p>UA: –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —â–æ–± —Å–∫–∞–∑–∞—Ç–∏, —â–æ —è —â–æ—Å—å —Ä–æ–±–ª—é –∞–±–æ —Ü–µ —Ñ–∞–∫—Ç –ø—Ä–æ –º–µ–Ω–µ.</p>
                        <p>EN: Used to say what I do or what is true about me.</p>
                        <p>Form: I + verb</p>
                        <p><b>Examples:</b></p>
                        <h2>I + verb + object</h2>
                        <p>UA: –ö–æ–ª–∏ –¥—ñ—è —Å–ø—Ä—è–º–æ–≤–∞–Ω–∞ –Ω–∞ –æ–±‚Äô—î–∫—Ç –∞–±–æ –º–∞—î —É—Ç–æ—á–Ω–µ–Ω–Ω—è.</p>
                        <p>EN: Used when the action has an object.</p>
                        <p>Form: I + verb + object</p>
                        <p><b>Examples:</b></p>
                        <h2>I live in + place</h2>
                        <p>UA: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —â–æ–± —Å–∫–∞–∑–∞—Ç–∏, –¥–µ —è –∂–∏–≤—É.</p>
                        <p>EN: Used to say where I live.</p>
                        <p>Form: I live in + country / city / town</p>
                        <p><b>Examples:</b></p>
                        <h2>I speak + language</h2>
                        <p>UA: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —â–æ–± —Å–∫–∞–∑–∞—Ç–∏, —è–∫–æ—é –º–æ–≤–æ—é —è –≥–æ–≤–æ—Ä—é.</p>
                        <p>EN: Used to say what language I speak.</p>
                        <p>Form: I speak + language</p>
                        <p><b>Examples:</b></p>
                        <h2>I learn</h2>
                        <p>UA: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —â–æ–± —Å–∫–∞–∑–∞—Ç–∏, —â–æ —è —â–æ—Å—å –≤–∏–≤—á–∞—é.</p>
                        <p>EN: Used to say what I learn.</p>
                        <p>Form: I learn + object</p>
                        <p><b>Examples:</b></p>
                        <h2>I like / I love</h2>
                        <p>UA: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —â–æ–± —Å–∫–∞–∑–∞—Ç–∏, —â–æ –º–µ–Ω—ñ –ø–æ–¥–æ–±–∞—î—Ç—å—Å—è –∞–±–æ —â–æ —è –ª—é–±–ª—é.</p>
                        <p>EN: Used to express liking or love.</p>
                        <p>Form: I like / I love + object</p>
                        <p><b>Examples:</b></p>
                        <h2>here / there / often</h2>
                        <p>UA: –°–ª–æ–≤–∞ –º—ñ—Å—Ü—è —Ç–∞ —á–∞—Å—Ç–æ—Ç–∏ –¥—ñ—ó.</p>
                        <p>EN: Words of place and frequency.</p>
                        <p>Form: here / there / often</p>
                        <p><b>Examples:</b></p>
                        <h2>I have / I can</h2>
                        <p>UA: I have ‚Äî –º–∞—Ç–∏ —â–æ—Å—å; I can ‚Äî –≤–º—ñ—Ç–∏ –∞–±–æ –º–æ–≥—Ç–∏ —â–æ—Å—å –∑—Ä–æ–±–∏—Ç–∏.</p>
                        <p>EN: I have ‚Äî possession; I can ‚Äî ability.</p>
                        <p>Form: I have + object / I can + verb</p>
                        <p><b>Examples:</b></p>
                    `,
                vocab: [
                    { ua: "–Ø —Ä–æ–∑—É–º—ñ—é", en: "I understand" },
                    { ua: "–Ø –±–∞—á—É", en: "I see" },
                    { ua: "–Ø –ø—Ä–∞—Ü—é—é", en: "I work" },
                    { ua: "–Ø —Ç–µ–±–µ —Ä–æ–∑—É–º—ñ—é", en: "I understand you" },
                    { ua: "–Ø —Ç–µ–±–µ –±–∞—á—É", en: "I see you" },
                    { ua: "–Ø –ø—Ä–∞—Ü—é—é –æ–Ω–ª–∞–π–Ω", en: "I work online" },
                    { ua: "–Ø –∂–∏–≤—É –≤ –õ–æ–Ω–¥–æ–Ω—ñ", en: "I live in London" },
                    { ua: "–Ø –∂–∏–≤—É –≤ –ù—å—é-–ô–æ—Ä–∫—É", en: "I live in New York" },
                    { ua: "–Ø –≥–æ–≤–æ—Ä—é –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é", en: "I speak English" },
                    { ua: "–Ø –≥–æ–≤–æ—Ä—é —ñ—Å–ø–∞–Ω—Å—å–∫–æ—é", en: "I speak Spanish" },
                    { ua: "–Ø –≤–∏–≤—á–∞—é –∞–Ω–≥–ª—ñ–π—Å—å–∫—É", en: "I learn English" },
                    { ua: "–Ø –≤–∏–≤—á–∞—é –æ–Ω–ª–∞–π–Ω", en: "I learn online" },
                    { ua: "–ú–µ–Ω—ñ –ø–æ–¥–æ–±–∞—î—Ç—å—Å—è –º—É–∑–∏–∫–∞", en: "I like music" },
                    { ua: "–Ø —Ç–µ–±–µ –ª—é–±–ª—é", en: "I love you" },
                    { ua: "–Ø –∂–∏–≤—É —Ç—É—Ç", en: "I live here" },
                    { ua: "–Ø –ø—Ä–∞—Ü—é—é —Ç–∞–º", en: "I work there" },
                    { ua: "–Ø —á–∞—Å—Ç–æ –ø—Ä–∞—Ü—é—é –æ–Ω–ª–∞–π–Ω", en: "I often work online" },
                    { ua: "–Ø –º–∞—é —á–∞—Å", en: "I have time" },
                    { ua: "–Ø –º–æ–∂—É –≥–æ–≤–æ—Ä–∏—Ç–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é", en: "I can speak English" }
                ],
                sentences: [
                    { ua: "–Ø —Ä–æ–∑—É–º—ñ—é", en: "I understand" },
                    { ua: "–Ø –±–∞—á—É", en: "I see" },
                    { ua: "–Ø –ø—Ä–∞—Ü—é—é", en: "I work" },
                    { ua: "–Ø —Ç–µ–±–µ —Ä–æ–∑—É–º—ñ—é", en: "I understand you" },
                    { ua: "–Ø —Ç–µ–±–µ –±–∞—á—É", en: "I see you" },
                    { ua: "–Ø –ø—Ä–∞—Ü—é—é –æ–Ω–ª–∞–π–Ω", en: "I work online" },
                    { ua: "–Ø –∂–∏–≤—É –≤ –õ–æ–Ω–¥–æ–Ω—ñ", en: "I live in London" },
                    { ua: "–Ø –∂–∏–≤—É –≤ –ù—å—é-–ô–æ—Ä–∫—É", en: "I live in New York" },
                    { ua: "–Ø –≥–æ–≤–æ—Ä—é –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é", en: "I speak English" },
                    { ua: "–Ø –≥–æ–≤–æ—Ä—é —ñ—Å–ø–∞–Ω—Å—å–∫–æ—é", en: "I speak Spanish" },
                    { ua: "–Ø –≤–∏–≤—á–∞—é –∞–Ω–≥–ª—ñ–π—Å—å–∫—É", en: "I learn English" },
                    { ua: "–Ø –≤–∏–≤—á–∞—é –æ–Ω–ª–∞–π–Ω", en: "I learn online" },
                    { ua: "–ú–µ–Ω—ñ –ø–æ–¥–æ–±–∞—î—Ç—å—Å—è –º—É–∑–∏–∫–∞", en: "I like music" },
                    { ua: "–Ø —Ç–µ–±–µ –ª—é–±–ª—é", en: "I love you" },
                    { ua: "–Ø –∂–∏–≤—É —Ç—É—Ç", en: "I live here" },
                    { ua: "–Ø –ø—Ä–∞—Ü—é—é —Ç–∞–º", en: "I work there" },
                    { ua: "–Ø —á–∞—Å—Ç–æ –ø—Ä–∞—Ü—é—é –æ–Ω–ª–∞–π–Ω", en: "I often work online" },
                    { ua: "–Ø –º–∞—é —á–∞—Å", en: "I have time" },
                    { ua: "–Ø –º–æ–∂—É –≥–æ–≤–æ—Ä–∏—Ç–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é", en: "I can speak English" }
                ]
            }
        ];


        /* ====== –Ü–ì–†–û–í–ê –õ–û–ì–Ü–ö–ê (—Ü—ñ–ª—ñ –µ—Ç–∞–ø—ñ–≤) ====== */
        const GAME = {
            livesPerStage: 3,
            stage: {
                mc:    { needCorrect: 5, minAccuracy: 0.70 },
                write: { needCorrect: 5, minAccuracy: 0.70 },
                sent:  { needCorrect: 3, minAccuracy: 0.60 }
            },
            stars: {
                two: 0.85,
                three: 0.95,
                streakForThree: 5
            }
        };

        let gameXP = 0;

        let stageState = {
            mc:    { correct: 0, attempts: 0, streak: 0, lives: 3, cleared: false, stars: 0 },
            write: { correct: 0, attempts: 0, streak: 0, lives: 3, cleared: false, stars: 0 },
            sent:  { correct: 0, attempts: 0, streak: 0, lives: 3, cleared: false, stars: 0 }
        };

        
        // ====== –ö–æ–º—ñ—Ç–∏: —à—Ç—Ä–∞—Ñ –∑–∞–º—ñ—Å—Ç—å —Å–∫–∏–¥–∞–Ω–Ω—è ======
        // –ü—Ä–∞–≤–∏–ª–∞:
        // - –Ø–∫—â–æ N <= 3: 3 –∂–∏—Ç—Ç—è, —à—Ç—Ä–∞—Ñ = –≤—ñ–¥–∫–∞—Ç –Ω–∞ 3
        // - –Ø–∫—â–æ N > 3: 5 –∂–∏—Ç—Ç—ñ–≤ (–º–∞–∫—Å), —à—Ç—Ä–∞—Ñ = –≤—ñ–¥–∫–∞—Ç –Ω–∞ 5
        // - –ñ–û–î–ù–ò–• –ø–æ–≤–Ω–∏—Ö —Å–∫–∏–¥—ñ–≤ –Ω–∞–∑–∞–¥. –õ–∏—à–µ –≤—ñ–¥–∫–∞—Ç correct —ñ –ø–æ–∑–∏—Ü—ñ—ó –ø–æ–∫–∞–∑—É.
        function getNFor(kind){
            const b = blocks[currentBlockIndex];
            if (kind === "sent") return (b.sentences && b.sentences.length) ? b.sentences.length : 0;
            return (b.vocab && b.vocab.length) ? b.vocab.length : 0;
        }
        function getLivesMax(kind){
            const n = getNFor(kind);
            return (n <= 3) ? 3 : 5;
        }
        function getRollbackSteps(kind){
            // —à—Ç—Ä–∞—Ñ = 3 –∞–±–æ 5 (–Ω–µ –±—ñ–ª—å—à–µ 5)
            const n = getNFor(kind);
            return (n <= 3) ? 3 : 5;
        }

        function showToast(msg){
            const ov = document.getElementById("toastOverlay");
            const el = document.getElementById("toastMsg");
            if(!ov || !el) return;
            el.textContent = msg;
            ov.classList.add("show");
            ov.setAttribute("aria-hidden","false");
            setTimeout(()=>{
                ov.classList.remove("show");
                ov.setAttribute("aria-hidden","true");
            }, 1200);
        }

        function resetStage(kind) {
            stageState[kind] = { correct: 0, attempts: 0, streak: 0, lives: getLivesMax(kind), cleared: false, stars: 0 };
        }

        function resetAllStages() {
            resetStage("mc");
            resetStage("write");
            resetStage("sent");
        }

        // --- UX helpers: –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –µ—Ç–∞–ø—É/–≤–ø—Ä–∞–≤–∏ —ñ "–ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏" ---
        function restartStage(kind) {
            clearAutoNext();
            resetStage(kind);

            // —Å–∫–∏–¥–∞–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –ø—ñ–¥–∫–∞–∑–∫–∏
            if (kind === "mc") { wrongAttemptsMC = 0; lastVocabIndexMC = -1; try { const b=blocks[currentBlockIndex]; resetSeq("mc",(b.vocab&&b.vocab.length)?b.vocab.length:0);} catch(e){} loadMCQuestion(); }
            if (kind === "write") { wrongAttemptsWrite = 0; lastVocabIndexWrite = -1; try { const b=blocks[currentBlockIndex]; resetSeq("write",(b.vocab&&b.vocab.length)?b.vocab.length:0);} catch(e){} loadWQuestion(); }
            if (kind === "sent") { wrongAttemptsSent = 0; lastSentenceIndex = -1; try { const b=blocks[currentBlockIndex]; resetSeq("sent",(b.sentences&&b.sentences.length)?b.sentences.length:0);} catch(e){} loadSentence(); }

            updateExerciseVisibility();
            updateGateUI();
        }

        function restartCurrentBlock() {
            clearAutoNext();
            // —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—î—ó –≤–ø—Ä–∞–≤–∏ (—ñ –ø—Ä–æ–≥—Ä–µ—Å—É –µ—Ç–∞–ø—ñ–≤)
            try { if (typeof resetAllStages === "function") resetAllStages(); } catch (e) {}

            // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ü—ñ—î—ó —Å–µ—Å—ñ—ó (stats) —á—ñ–ø–∞—î–º–æ –ª–∏—à–µ —è–∫—â–æ –≤–æ–Ω–∞ –≤–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞
            try {
                if (typeof stats !== "undefined") {
                    stats[currentBlockIndex] = {
                        mc: { correct: 0, total: 0 },
                        write: { correct: 0, total: 0 },
                        sent: { correct: 0, total: 0 }
                    };
                }
            } catch (e) {}

            loadBlock(currentBlockIndex);
            try { if (typeof updateStatsView === "function") updateStatsView(); } catch (e) {}
        }

        function goNextStep() {
            clearAutoNext();
            nextExerciseStep();
        }

        function nextBlock() {
            clearAutoNext();
            if (currentBlockIndex < blocks.length - 1) {
                loadBlock(currentBlockIndex + 1);
            } else {
                // —è–∫—â–æ —Ü–µ –æ—Å—Ç–∞–Ω–Ω—è –≤–ø—Ä–∞–≤–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É –π –ª–∏—à–∞—î–º–æ—Å—å —Ç—É—Ç
                loadBlock(currentBlockIndex);
            }
        }

        function stageAccuracy(kind) {
            const s = stageState[kind];
            return s.attempts ? (s.correct / s.attempts) : 0;
        }

        function stageGoalMet(kind) {
            const cfg = GAME.stage[kind];
            const s = stageState[kind];
            return s.correct >= cfg.needCorrect && stageAccuracy(kind) >= cfg.minAccuracy;
        }

        function calcStars(kind) {
            const s = stageState[kind];
            if (!s.cleared) return 0;
            const a = stageAccuracy(kind);
            if (a >= GAME.stars.three && s.streak >= GAME.stars.streakForThree) return 3;
            if (a >= GAME.stars.two) return 2;
            return 1;
        }

        function currentKind() {
            if (currentExerciseStep === 1) return "mc";
            if (currentExerciseStep === 2) return "write";
            if (currentExerciseStep === 3) return "sent";
            return null;
        }

        
        // ====== MODAL helpers ======
        const modalOverlayEl = document.getElementById("modalOverlay");
        const modalTitleEl = document.getElementById("modalTitle");
        const modalTextEl = document.getElementById("modalText");
        const modalPrimaryEl = document.getElementById("modalPrimary");
        const modalSecondaryEl = document.getElementById("modalSecondary");
        const modalTertiaryEl = document.getElementById("modalTertiary");

        let modalPrimaryAction = null;
        let modalSecondaryAction = null;
        let modalTertiaryAction = null;

        function openModal({ title, text, primaryText = "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏", secondaryText = null, tertiaryText = null, onPrimary = null, onSecondary = null, onTertiary = null }) {
            modalTitleEl.textContent = title;
            modalTextEl.textContent = text;

            modalPrimaryEl.textContent = primaryText;
            modalSecondaryEl.textContent = secondaryText || "";
            modalTertiaryEl.textContent = tertiaryText || "";

            modalPrimaryAction = onPrimary;
            modalSecondaryAction = onSecondary;
            modalTertiaryAction = onTertiary;

            modalSecondaryEl.style.display = secondaryText ? "inline-flex" : "none";
            modalTertiaryEl.style.display = tertiaryText ? "inline-flex" : "none";

            modalOverlayEl.style.display = "flex";
            modalOverlayEl.setAttribute("aria-hidden", "false");

            // —Ñ–æ–∫—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–µ
            modalPrimaryEl.focus();
        }

        function closeModal() {
            modalOverlayEl.style.display = "none";
            modalOverlayEl.setAttribute("aria-hidden", "true");
            modalPrimaryAction = null;
            modalSecondaryAction = null;
            modalTertiaryAction = null;
        }

        modalPrimaryEl.addEventListener("click", () => {
            const fn = modalPrimaryAction;
            closeModal();
            if (typeof fn === "function") fn();
        });

        modalSecondaryEl.addEventListener("click", () => {
            const fn = modalSecondaryAction;
            closeModal();
            if (typeof fn === "function") fn();
        });

        

        modalTertiaryEl.addEventListener("click", () => {
            const fn = modalTertiaryAction;
            closeModal();
            if (typeof fn === "function") fn();
        });
// –∑–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∏–∫–æ–º –ø–æ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—é
        modalOverlayEl.addEventListener("click", (e) => {
            if (e.target === modalOverlayEl) {
                closeModal();
            }
        });

        function showVictory(kind) {
            clearAutoNext();

            // –í —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ —Ç–µ—Ö-—è—Ä–ª–∏–∫–∏ MC/WRITE/SENT.
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –Ω–æ–º–µ—Ä –µ—Ç–∞–ø—É 1..3 –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:
            const stageNumber = (kind === "mc") ? 1 : (kind === "write") ? 2 : 3;

            // –Ø–∫—â–æ —Ü–µ –æ—Å—Ç–∞–Ω–Ω—ñ–π –µ—Ç–∞–ø —ñ –≤—ñ–Ω –ø—Ä–æ–π–¥–µ–Ω–∏–π ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤–ø—Ä–∞–≤–∏
            const isFinalStage = (kind === "sent");
            const exerciseDone = isFinalStage && stageState.mc.cleared && stageState.write.cleared && stageState.sent.cleared;

            if (exerciseDone) {
                // –ú–æ–∂–µ–º–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥—Å—É–º–∫–æ–≤—ñ –∑—ñ—Ä–∫–∏ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –µ—Ç–∞–ø (–∞–±–æ –ø—Ä–æ—Å—Ç–æ ‚≠ê‚≠ê‚≠ê —è–∫—â–æ —Ö–æ—á–µ—Ç—å—Å—è).
                const stars = calcStars(kind);
                stageState[kind].stars = stars;

                openModal({
                    title: "–£–†–ê! –í–ò –ü–†–û–ô–®–õ–ò –¶–Æ –í–ü–†–ê–í–£ üéâ " + "‚≠ê".repeat(stars),
                    text: "–í–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤—Å—ñ –µ—Ç–∞–ø–∏ —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏.",
                    primaryText: "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –Ω–∞–≤—á–∞–Ω–Ω—è",
                    secondaryText: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π –µ—Ç–∞–ø",
                    tertiaryText: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –≤–ø—Ä–∞–≤—É",
                    onPrimary: () => {
                        closeModal();
                        nextBlock(); // –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –≤–ø—Ä–∞–≤–∏
                    },
                    onSecondary: () => {
                        closeModal();
                        restartStage(kind); // —Å–∫–∏–¥–∞–Ω–Ω—è –ª–∏—à–µ –µ—Ç–∞–ø—É 3
                    },
                    onTertiary: () => {
                        closeModal();
                        restartCurrentBlock(); // —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—î—ó –≤–ø—Ä–∞–≤–∏
                    }
                });
                return;
            }

            // –ó–≤–∏—á–∞–π–Ω–∞ –ø–µ—Ä–µ–º–æ–≥–∞ –µ—Ç–∞–ø—É
            const stars = calcStars(kind);
            stageState[kind].stars = stars;

            openModal({
                title: "–ï—Ç–∞–ø " + stageNumber + " –∑ 3 –ø—Ä–æ–π–¥–µ–Ω–æ  " + "‚≠ê".repeat(stars),
                text: "–ß—É–¥–æ–≤–æ! –ú–æ–∂–µ—à –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∞–±–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Ü–µ–π –µ—Ç–∞–ø.",
                primaryText: "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏",
                secondaryText: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –µ—Ç–∞–ø",
                tertiaryText: "",
                onPrimary: () => {
                    closeModal();
                    goNextStep(); // –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –µ—Ç–∞–ø
                },
                onSecondary: () => {
                    closeModal();
                    restartStage(kind); // —Å–∫–∏–¥–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É –ø–æ—Ç–æ—á–Ω–æ–≥–æ –µ—Ç–∞–ø—É
                }
            });
}

        function showFail(kind) {
            clearAutoNext();

            // –®—Ç—Ä–∞—Ñ –∑–∞–º—ñ—Å—Ç—å —Å–∫–∏–¥–∞–Ω–Ω—è: –≤—ñ–¥–∫–∞—Ç –Ω–∞ 3 –∞–±–æ 5, –ø–æ—Ç—ñ–º –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ
            const rollback = getRollbackSteps(kind);
            const s = stageState[kind];

            // –≤—ñ–¥–∫–∞—Ç –ø—Ä–æ–≥—Ä–µ—Å—É (–∞–ª–µ –Ω–µ –Ω–∏–∂—á–µ 0)
            s.correct = Math.max(0, s.correct - rollback);
            // –∂–∏—Ç—Ç—è –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –¥–æ –º–∞–∫—Å–∏–º—É–º—É –¥–ª—è —Ü—å–æ–≥–æ N
            s.lives = getLivesMax(kind);

            // –≤—ñ–¥–∫–∞—Ç –ø–æ–∑–∏—Ü—ñ—ó –ø–æ–∫–∞–∑—É (—â–æ–± —Ä–µ–∞–ª—å–Ω–æ –ø–æ–≤—Ç–æ—Ä—é–≤–∞–ª–æ, –∞ –Ω–µ –ø–µ—Ä–µ—Å–∫–∞–∫—É–≤–∞–ª–æ)
            try {
                if (seq && seq[kind]) {
                    seq[kind].pos = Math.max(0, (seq[kind].pos || 0) - rollback);
                    seq[kind].last = -1;
                }
            } catch(e) {}

            // —ñ–≥—Ä–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è + —á–µ—Ä–≤–æ–Ω–∞ —Å–ø–∞–ª–∞—Ö
            flashScreen("red");
            showToast(`–£–ø—Å! –ü–æ–º–∏–ª–∫–∞ üòÖ –®—Ç—Ä–∞—Ñ: -${rollback}`);

            updateGateUI();

            // –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –µ—Ç–∞–ø
            if (kind === "mc") loadMCQuestion();
            if (kind === "write") loadWQuestion();
            if (kind === "sent") loadSentence();
        }
function onCorrect(kind) {
            const s = stageState[kind];
            s.attempts++;
            s.correct++;
            s.streak++;
            gameXP += 10;

            if (!s.cleared && stageGoalMet(kind)) {
                s.cleared = true;
                s.stars = calcStars(kind);
                updateGateUI();
                showVictory(kind);
                return;
            }

            updateGateUI();
        }

        function onWrong(kind) {
            const s = stageState[kind];
            s.attempts++;
            s.streak = 0;
            s.lives--;

            if (s.lives <= 0) {
                showFail(kind);
                return;
            }

            updateGateUI();
        }

        function updateGateUI() {
            const kind = currentKind();

            // 1) –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å (–º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –≤–æ –≤—Ä–µ–º—è –ø—Ä–∞–∫—Ç–∏–∫–∏)
            if (currentExerciseStep === 0) {
                // –Ω–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏–∏ –ø–∞–Ω–µ–ª—å –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞, –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞
                topPanelEl.style.display = "block";
                btnTopPanelEl.style.display = "none";
                // –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ –ø–∞–Ω–µ–ª—å –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                btnTopPanelEl.textContent = "–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å";
            } else {
                // –≤–æ –≤—Ä–µ–º—è –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã–≤–∞–µ–º, –Ω–æ –¥–∞—ë–º –∫–Ω–æ–ø–∫—É –æ—Ç–∫—Ä—ã—Ç—å
                topPanelEl.style.display = topPanelVisibleInPractice ? "block" : "none";
                btnTopPanelEl.style.display = "inline-flex";
                btnTopPanelEl.textContent = topPanelVisibleInPractice ? "–°—Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å" : "–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å";
            }

            // 2) –≥–µ–π—Ç –ø–æ —ç—Ç–∞–ø–∞–º
            if (!kind) {
                btnNextEx.disabled = false;
                return;
            }

            btnNextEx.disabled = !stageState[kind].cleared;

            const cfg = GAME.stage[kind];
            const s = stageState[kind];
            const acc = Math.round(stageAccuracy(kind) * 100);
            const needAcc = Math.round(cfg.minAccuracy * 100);

            // –ø–æ–ª–æ—Å–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —ç—Ç–∞–ø–∞ (–∫—Ä–∞—Å–Ω–∞—è ‚Üí –∂—ë–ª—Ç–∞—è ‚Üí –∑–µ–ª—ë–Ω–∞—è)
            if (stageBarWrapEl && stageBarEl) {
                if (currentExerciseStep === 0) {
                    stageBarWrapEl.style.display = "none";
                } else {
                    stageBarWrapEl.style.display = "block";
                    const progress = Math.max(0, Math.min(1, s.correct / cfg.needCorrect));
                    stageBarEl.style.width = `${Math.round(progress * 100)}%`;
                    const hue = Math.round(progress * 120); // 0=–∫—Ä–∞—Å–Ω—ã–π, 120=–∑–µ–ª—ë–Ω—ã–π
                    stageBarEl.style.backgroundColor = `hsl(${hue}, 85%, 45%)`;
                }
            }


            // —Ç–µ–∫—Å—Ç –¥–µ–ª–∞–µ–º "–∏–≥—Ä–æ–≤—ã–º", –Ω–æ –∫–æ—Ä–æ—Ç–∫–∏–º
            exerciseStepEl.textContent =
                `–ï—Ç–∞–ø ${currentExerciseStep} –∑ 3 ‚Ä¢ ‚ù§Ô∏è ${s.lives} ‚Ä¢ ‚úÖ ${s.correct}/${cfg.needCorrect} ‚Ä¢ üéØ ${acc}% (–ø–æ—Ç—Ä—ñ–±–Ω–æ ${needAcc}%) ‚Ä¢ XP ${gameXP}`;
        }

        /* ====== –î–û–ü–û–ú–Ü–ñ–ù–Ü ====== */
        let autoNextTimeout = null;

        // –ª–æ–∫–∞–ª—å–Ω—ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–Ω—è
        let wrongAttemptsMC = 0;
        let wrongAttemptsWrite = 0;
        let wrongAttemptsSent = 0;

        function randInt(max) {
            return Math.floor(Math.random() * max);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = randInt(i + 1);
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function normalizeAnswer(str) {
            return str
                .toLowerCase()
                .replace(/\s+/g, " ")
                .trim()
                .replace(/[.!?]+$/, "");
        }

        function flashScreen(type) {
            const cls = type === "green" ? "flash-green" : "flash-red";
            document.body.classList.remove("flash-green", "flash-red");
            // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reflow
            void document.body.offsetWidth;
            document.body.classList.add(cls);

            let duration = 500; // –∑–µ–ª—ë–Ω–æ–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ–ª—å—à–µ
            if (type === "red") {
                duration = 750; // 0.25 * 3 –º–∏–≥–∞–Ω–∏—è
            }

            setTimeout(() => {
                document.body.classList.remove(cls);
            }, duration);
        }

        function clearAutoNext() {
            if (autoNextTimeout !== null) {
                clearTimeout(autoNextTimeout);
                autoNextTimeout = null;
            }
        }

        /* ====== DOM ====== */
        const blockTitleEl = document.getElementById("block-title");
        const blockProgressTextEl = document.getElementById("block-progress-text");
        const exerciseStepEl = document.getElementById("exercise-step");
        const stageBarWrapEl = document.getElementById("stage-bar-wrap");
        const stageBarEl = document.getElementById("stage-bar");
        const explainEl = document.getElementById("explain");
        const btnToggleExplain = document.getElementById("btn-toggle-explain");

        const blockSelectEl = document.getElementById("block-select");

        const ex1Card = document.getElementById("ex1");
        const ex2Card = document.getElementById("ex2");
        const ex3Card = document.getElementById("ex3");

        // MC
        const mcQuestionEl = document.getElementById("mc-question");
        const mcOptionsEl = document.getElementById("mc-options");
        const mcFeedbackEl = document.getElementById("mc-feedback");
        const mcNextBtn = document.getElementById("mc-next");

        // write
        const wQuestionEl = document.getElementById("w-question");
        const wInputEl = document.getElementById("w-input");
        const wFeedbackEl = document.getElementById("w-feedback");
        const wCheckBtn = document.getElementById("w-check");
        const wShowBtn = document.getElementById("w-show");
        const wNextBtn = document.getElementById("w-next");

        // sentences
        const sQuestionEl = document.getElementById("s-question");
        const sInputEl = document.getElementById("s-input");
        const sFeedbackEl = document.getElementById("s-feedback");
        const sCheckBtn = document.getElementById("s-check");
        const sShowBtn = document.getElementById("s-show");
        const sNextBtn = document.getElementById("s-next");

        // –Ω–∞–≤–∏–≥–∞—Ü–∏—è
        const btnPrev = document.getElementById("btn-prev");
        const btnNext = document.getElementById("btn-next");
        const btnNextEx = document.getElementById("btn-next-ex");
        const btnRestart = document.getElementById("btn-restart");

        const statsEl = document.getElementById("stats");

        const topPanelEl = document.getElementById("topPanel");
        const btnTopPanelEl = document.getElementById("btn-topPanel");

        // –ø–∞–Ω–µ–ª—å —Å–≤–µ—Ä—Ö—É: —Å–∫—Ä—ã–≤–∞–µ–º –≤–æ –≤—Ä–µ–º—è –ø—Ä–∞–∫—Ç–∏–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ
        let topPanelVisibleInPractice = false;

        /* ====== –°–û–°–¢–û–Ø–ù–ò–ï ====== */
        let currentBlockIndex = 0;
        // 0 ‚Äì –ª–∏—à–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è, 1 ‚Äì –≤–ø—Ä–∞–≤–∞ 1, 2 ‚Äì –≤–ø—Ä–∞–≤–∞ 2, 3 ‚Äì –≤–ø—Ä–∞–≤–∞ 3
        let currentExerciseStep = 0;
        let explainVisible = true;

        
        // –©–æ–± –Ω–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞–ª–æ—Å—è –æ–¥–Ω–µ –π —Ç–µ —Å–∞–º–µ –æ–¥—Ä–∞–∑—É –ø—ñ–¥—Ä—è–¥ (–º—ñ–Ω—ñ–º—É–º —á–µ—Ä–µ–∑ 1)
        let lastVocabIndexMC = -1;
        let lastVocabIndexWrite = -1;
        let lastSentenceIndex = -1;
        // ===== Sequencer: 1 pass in-order through all items (N), then random drill K=N*3 (repeats allowed) =====
        // –ö–æ–º—ñ—Ç: —Ç–µ–ø–µ—Ä —Ü–µ –û–î–ò–ù –ø–æ—Ç—ñ–∫ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤–ø—Ä–∞–≤–∏: N –ø–æ –ø–æ—Ä—è–¥–∫—É, –ø–æ—Ç—ñ–º N*3 —Ä–∞–Ω–¥–æ–º–æ–º –∑ —Ç–∏—Ö —Å–∞–º–∏—Ö N.
        function makeSeq() { return { pos: 0, last: -1, n: 0 }; }
        const seq = { mc: makeSeq(), write: makeSeq(), sent: makeSeq() };

        function resetSeq(kind, n) {
            seq[kind] = makeSeq();
            seq[kind].n = n || 0;
            seq[kind].pos = 0;
            seq[kind].last = -1;
        }

        function nextIndex(kind, n) {
            if (!seq[kind] || seq[kind].n !== n) resetSeq(kind, n);
            const s = seq[kind];
            if (n <= 0) return 0;

            let idx;
            if (s.pos < n) {
                // ordered pass
                idx = s.pos;
            } else {
                // drill
                idx = randIntExcept(n, s.last);
            }
            s.pos++;
            s.last = idx;
            return idx;
        }
function randIntExcept(max, last) {
            if (max <= 1) return 0;
            let i = randInt(max);
            if (i === last) {
                // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ —ñ–Ω—à–µ –∑–Ω–∞—á–µ–Ω–Ω—è
                i = (i + 1 + randInt(max - 1)) % max;
                if (i === last) i = (i + 1) % max;
            }
            return i;
        }
let currentVocabIndexMC = 0;
        let currentVocabIndexWrite = 0;
        let currentSentenceIndex = 0;

        const stats = {};

        function ensureStatsForBlock(index) {
            if (!stats[index]) {
                stats[index] = {
                    mc: { correct: 0, total: 0 },
                    write: { correct: 0, total: 0 },
                    sent: { correct: 0, total: 0 }
                };
            }
        }

        function updateStatsView() {
            ensureStatsForBlock(currentBlockIndex);
            const st = stats[currentBlockIndex];
            statsEl.textContent =
                `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏ (–ª–∏—à–µ –∑–∞ —Ü—é —Å–µ—Å—ñ—é): ` +
                `–≤–∏–±—ñ—Ä ‚Äî ${st.mc.correct}/${st.mc.total}, ` +
                `–Ω–∞–ø–∏—Å–∞–Ω–Ω—è ‚Äî ${st.write.correct}/${st.write.total}, ` +
                `—Ä–µ—á–µ–Ω–Ω—è ‚Äî ${st.sent.correct}/${st.sent.total}.`;
        }

        function updateExplainVisibility() {
            if (currentExerciseStep === 0) {
                // –ù–∞ —ç—Ç–∞–ø–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è: –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–æ, –∫–Ω–æ–ø–∫—É –±–ª–æ–∫–∏—Ä—É–µ–º
                explainVisible = true;
                explainEl.style.display = "block";
                btnToggleExplain.disabled = true;
                btnToggleExplain.textContent = "–°—Ö–æ–≤–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è";
            } else {
                // –í–æ –≤—Ä–µ–º—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∫–Ω–æ–ø–∫—É –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                btnToggleExplain.disabled = false;
                explainEl.style.display = explainVisible ? "block" : "none";
                btnToggleExplain.textContent = explainVisible
                    ? "–°—Ö–æ–≤–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è"
                    : "–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è";
            }
        }

        function updateExerciseVisibility() {
            ex1Card.style.display = (currentExerciseStep === 1) ? "block" : "none";
            ex2Card.style.display = (currentExerciseStep === 2) ? "block" : "none";
            ex3Card.style.display = (currentExerciseStep === 3) ? "block" : "none";

            if (currentExerciseStep === 0) {
                exerciseStepEl.textContent = "–°–ø–æ—á–∞—Ç–∫—É —Å–ø–æ–∫—ñ–π–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π –ø–æ—è—Å–Ω–µ–Ω–Ω—è, –ø–æ—Ç—ñ–º –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ü–æ—á–∞—Ç–∏ –≤–ø—Ä–∞–≤–∏¬ª.";
                btnNextEx.textContent = "–ü–æ—á–∞—Ç–∏ –≤–ø—Ä–∞–≤–∏";
            } else if (currentExerciseStep === 1) {
                exerciseStepEl.textContent = "–ï—Ç–∞–ø 1 –∑ 3: –ø—Ä–æ—Å—Ç–æ –æ–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É —Ñ—Ä–∞–∑—É.";
                btnNextEx.textContent = "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ 2-–≥–æ –µ—Ç–∞–ø—É";
            } else if (currentExerciseStep === 2) {
                exerciseStepEl.textContent = "–ï—Ç–∞–ø 2 –∑ 3: –Ω–∞–ø–∏—à–∏ —Ñ—Ä–∞–∑—É —Å–∞–º.";
                btnNextEx.textContent = "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ 3-–≥–æ –µ—Ç–∞–ø—É";
            } else {
                exerciseStepEl.textContent = "–ï—Ç–∞–ø 3 –∑ 3: –ø–µ—Ä–µ–∫–ª–∞–¥–∏ –º–∞–ª–µ–Ω—å–∫—ñ —Ä–µ—á–µ–Ω–Ω—è.";
                btnNextEx.textContent = "–£—Å—ñ –µ—Ç–∞–ø–∏ –ø—Ä–æ–π–¥–µ–Ω—ñ ‚Äî –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –≤–ø—Ä–∞–≤–∏";
            }

            updateExplainVisibility();
            updateGateUI();
        }

        const stageReloadAttempted = { mc: false, write: false, sent: false };

        function ensureStageQuestionLoaded() {
            if (currentExerciseStep === 1) {
                if (!mcQuestionEl.textContent.trim() && !stageReloadAttempted.mc) {
                    stageReloadAttempted.mc = true;
                    loadMCQuestion();
                }
                return;
            }
            if (currentExerciseStep === 2) {
                if (!wQuestionEl.textContent.trim() && !stageReloadAttempted.write) {
                    stageReloadAttempted.write = true;
                    loadWQuestion();
                }
                return;
            }
            if (currentExerciseStep === 3) {
                if (!sQuestionEl.textContent.trim() && !stageReloadAttempted.sent) {
                    stageReloadAttempted.sent = true;
                    loadSentence();
                }
            }
        }

        function focusActiveExercise() {
            let card = null;
            let focusTarget = null;

            if (currentExerciseStep === 1) {
                card = ex1Card;
                focusTarget = mcOptionsEl.querySelector("button");
            } else if (currentExerciseStep === 2) {
                card = ex2Card;
                focusTarget = wInputEl;
            } else if (currentExerciseStep === 3) {
                card = ex3Card;
                focusTarget = sInputEl;
            }

            if (!card) return;

            requestAnimationFrame(() => {
                card.scrollIntoView({ behavior: "smooth", block: "start" });
                if (focusTarget && typeof focusTarget.focus === "function") {
                    focusTarget.focus({ preventScroll: true });
                }
            });
        }

        function nextExerciseStep() {
            clearAutoNext();
            if (currentExerciseStep === 0) {
                currentExerciseStep = 1;
                explainVisible = false;
                uaTtsArmed = true;
                lastUaSpokenKey = null;
                stageReloadAttempted.mc = false;
                ensureVoicesReady();
                updateExerciseVisibility();
                loadMCQuestion();
                ensureStageQuestionLoaded();
                focusActiveExercise();
                return;
            }

            if (currentExerciseStep < 3) {
                currentExerciseStep++;
                updateExerciseVisibility();
                lastUaSpokenKey = null;
                if (currentExerciseStep === 2) {
                    stageReloadAttempted.write = false;
                    loadWQuestion();
                }
                if (currentExerciseStep === 3) {
                    stageReloadAttempted.sent = false;
                    loadSentence();
                }
                ensureStageQuestionLoaded();
                focusActiveExercise();
            } else {
                openModal({title:"–í–∂–µ –æ—Å—Ç–∞–Ω–Ω—ñ–π –µ—Ç–∞–ø", text:"–¶—è –≤–ø—Ä–∞–≤–∞ –≤–∂–µ –Ω–∞ –æ—Å—Ç–∞–Ω–Ω—å–æ–º—É –µ—Ç–∞–ø—ñ. –ú–æ–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ —ó—ó –∞–±–æ –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—ñ.", primaryText:"–û–∫"});
            }
        }

        /* ====== –ó–ê–ì–†–£–ó–ö–ê –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø ====== */
        function loadBlock(index) {
            clearAutoNext();

            const total = blocks.length;
            if (index < 0) index = 0;
            if (index >= total) index = total - 1;

            currentBlockIndex = index;
            currentExerciseStep = 0;
            explainVisible = true;
            topPanelVisibleInPractice = false;
            uaTtsArmed = false;
            lastUaSpokenKey = null;
            resetAllStages();
            lastVocabIndexMC = -1;
            lastVocabIndexWrite = -1;
            lastSentenceIndex = -1;
            stageReloadAttempted.mc = false;
            stageReloadAttempted.write = false;
            stageReloadAttempted.sent = false;
 
            // reset sequencers for this block
            try {
                const b = blocks[currentBlockIndex];
                resetSeq("mc", (b.vocab && b.vocab.length) ? b.vocab.length : 0);
                resetSeq("write", (b.vocab && b.vocab.length) ? b.vocab.length : 0);
                resetSeq("sent", (b.sentences && b.sentences.length) ? b.sentences.length : 0);
            } catch (e) {}


            const block = blocks[currentBlockIndex];

            // Dynamic repetition rule (as requested):
            // 1 pass through all N items in order + random drill K=N*3 from the same items.
            // To prevent switching to the next exercise after the first pass, we require total correct = N*4.
            try {
                const nV = (block.vocab && block.vocab.length) ? block.vocab.length : 0;
                const nS = (block.sentences && block.sentences.length) ? block.sentences.length : 0;
                if (nV > 0) {
                    GAME.stage.mc.needCorrect = nV * 4;
                    GAME.stage.write.needCorrect = nV * 4;
                }
                if (nS > 0) {
                    GAME.stage.sent.needCorrect = nS * 4;
                }
            } catch(e) {}

            blockTitleEl.textContent = `–í–ø—Ä–∞–≤–∞ ${currentBlockIndex + 1}. ${block.title}`;
            blockProgressTextEl.textContent = `–í–ø—Ä–∞–≤–∞ ${currentBlockIndex + 1} –∑ ${total}`;
            explainEl.innerHTML = `
                    ${block.topicTag ? `<div class="topic-tag">${block.topicTag}</div>` : ""}
                    ${block.explanation}
                `;

            blockSelectEl.value = String(currentBlockIndex);

            btnPrev.disabled = currentBlockIndex === 0;
            btnNext.disabled = currentBlockIndex === total - 1;

            mcFeedbackEl.textContent = "";
            mcFeedbackEl.className = "feedback";
            wFeedbackEl.textContent = "";
            wFeedbackEl.className = "feedback";
            sFeedbackEl.textContent = "";
            sFeedbackEl.className = "feedback";

            ensureStatsForBlock(currentBlockIndex);
            updateStatsView();
            updateExerciseVisibility();
        }

        /* ====== –í–ü–†–ê–í–ê 1 ‚Äì –í–ò–ë–Ü–† ====== */
        function loadMCQuestion() {
            clearAutoNext();
            wrongAttemptsMC = 0; // —Å–∫–∏–¥–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞

            const block = blocks[currentBlockIndex];
            if (!block.vocab || !block.vocab.length) {
                mcQuestionEl.textContent = "–î–ª—è —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏ —â–µ –Ω–µ–º–∞—î —Å–ª—ñ–≤.";
                mcOptionsEl.innerHTML = "";
                return;
            }

            currentVocabIndexMC = nextIndex('mc', block.vocab.length);
            lastVocabIndexMC = currentVocabIndexMC;
            const card = block.vocab[currentVocabIndexMC];

            mcQuestionEl.textContent = card.ua;
            const mcQuestionId = `mc-${currentBlockIndex}-${currentVocabIndexMC}`;
            speakUkrainianOnce(mcQuestionId, card.ua);
            mcFeedbackEl.textContent = "";
            mcFeedbackEl.className = "feedback";

            const maxOptions = Math.min(4, block.vocab.length);
            const options = [card.en];

            while (options.length < maxOptions) {
                const idx = randInt(block.vocab.length);
                const opt = block.vocab[idx].en;
                if (!options.includes(opt)) {
                    options.push(opt);
                }
            }

            shuffle(options);

            mcOptionsEl.innerHTML = "";
            options.forEach(text => {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.className = "option-btn";
                btn.addEventListener("click", () => checkMCAnswer(btn, text, card.en));
                mcOptionsEl.appendChild(btn);
            });
        }

        function checkMCAnswer(button, chosen, correct) {
            clearAutoNext();

            ensureStatsForBlock(currentBlockIndex);
            const st = stats[currentBlockIndex].mc;
            st.total++;

            if (normalizeAnswer(chosen) === normalizeAnswer(correct)) {
                flashScreen("green");
                mcFeedbackEl.textContent = "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!";
                mcFeedbackEl.className = "feedback correct";
                st.correct++;
                onCorrect("mc");

                speakEnglish(correct);
                // –ø–æ–∑–Ω–∞—á–∞—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É –∫–Ω–æ–ø–∫—É –∑–µ–ª–µ–Ω–∏–º
                button.classList.add("correct");

                updateStatsView();

                autoNextTimeout = setTimeout(() => {
                    loadMCQuestion();
                }, 900);
            } else {
                wrongAttemptsMC++;
                flashScreen("red");

                if (wrongAttemptsMC >= 3) {
                    mcFeedbackEl.textContent = "‚ùå –ù–µ –∑–æ–≤—Å—ñ–º. –ü—ñ–¥–∫–∞–∑–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å ‚Äî " + correct;
                    speakEnglish(correct);
                } else {
                    mcFeedbackEl.textContent = "‚ùå –ù–µ –∑–æ–≤—Å—ñ–º. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.";
                }

                mcFeedbackEl.className = "feedback wrong";
                // –ø—ñ–¥—Å–≤—ñ—Ç–∏—Ç–∏ –ª–∏—à–µ –≤–∏–±—Ä–∞–Ω—É –∫–Ω–æ–ø–∫—É, –∞–ª–µ –Ω–µ –±–ª–æ–∫—É–≤–∞—Ç–∏ —ñ–Ω—à—ñ
                button.classList.add("wrong");

                onWrong("mc");
                updateStatsView();
            }
        }

        mcNextBtn.addEventListener("click", loadMCQuestion);

        /* ====== –í–ü–†–ê–í–ê 2 ‚Äì –ù–ê–ü–ò–°–ê–¢–ò ====== */
        function loadWQuestion() {
            clearAutoNext();
            wrongAttemptsWrite = 0; // —Å–∫–∏–¥–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –ø—Ä–∏ –Ω–æ–≤–æ–º—É —Å–ª–æ–≤—ñ

            const block = blocks[currentBlockIndex];
            if (!block.vocab || !block.vocab.length) {
                wQuestionEl.textContent = "–î–ª—è —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏ —â–µ –Ω–µ–º–∞—î —Å–ª—ñ–≤.";
                return;
            }

            currentVocabIndexWrite = nextIndex('write', block.vocab.length);
            lastVocabIndexWrite = currentVocabIndexWrite;
            const card = block.vocab[currentVocabIndexWrite];

            wQuestionEl.textContent = card.ua;
            const wQuestionId = `write-${currentBlockIndex}-${currentVocabIndexWrite}`;
            speakUkrainianOnce(wQuestionId, card.ua);
            wInputEl.value = "";
            wFeedbackEl.textContent = "";
            wFeedbackEl.className = "feedback";
        }

        function checkWAnswer() {
            clearAutoNext();
            const block = blocks[currentBlockIndex];
            if (!block.vocab || !block.vocab.length) return;

            const card = block.vocab[currentVocabIndexWrite];
            const user = wInputEl.value;
            if (!user.trim()) return;

            ensureStatsForBlock(currentBlockIndex);
            const st = stats[currentBlockIndex].write;
            st.total++;

            if (normalizeAnswer(user) === normalizeAnswer(card.en)) {
                flashScreen("green");
                wFeedbackEl.textContent = "‚úÖ –ß—É–¥–æ–≤–æ! –°–∞–º–µ —Ç–∞–∫ —ñ –ø–∏—à–µ—Ç—å—Å—è.";
                wFeedbackEl.className = "feedback correct";
                st.correct++;
                onCorrect("write");
                speakEnglish(card.en);
                updateStatsView();

                autoNextTimeout = setTimeout(() => {
                    loadWQuestion();
                }, 900);
            } else {
                wrongAttemptsWrite++;
                flashScreen("red");

                if (wrongAttemptsWrite >= 3) {
                    wFeedbackEl.textContent = "‚ùå –¢—Ä–æ—Ö–∏ –Ω–µ —Ç–∞–∫. –ü—ñ–¥–∫–∞–∑–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å ‚Äî " + card.en;
                speakEnglish(card.en);
                } else {
                    wFeedbackEl.textContent = "‚ùå –¢—Ä–æ—Ö–∏ –Ω–µ —Ç–∞–∫. –í–∏–ø—Ä–∞–≤ —ñ –Ω–∞—Ç–∏—Å–Ω–∏ —â–µ —Ä–∞–∑.";
                }

                wFeedbackEl.className = "feedback wrong";
                onWrong("write");
                updateStatsView();
            }
        }

        function showWAnswer() {
            clearAutoNext();
            const block = blocks[currentBlockIndex];
            if (!block.vocab || !block.vocab.length) return;

            const card = block.vocab[currentVocabIndexWrite];
            wFeedbackEl.textContent = "–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: " + card.en;
            wFeedbackEl.className = "feedback";
            speakEnglish(card.en);
        }

        wCheckBtn.addEventListener("click", checkWAnswer);
        wShowBtn.addEventListener("click", showWAnswer);
        wNextBtn.addEventListener("click", loadWQuestion);
        wInputEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter") checkWAnswer();
        });

        /* ====== –í–ü–†–ê–í–ê 3 ‚Äì –†–ï–ß–ï–ù–ù–Ø ====== */
        function loadSentence() {
            clearAutoNext();
            wrongAttemptsSent = 0; // —Å–∫–∏–¥–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫

            const block = blocks[currentBlockIndex];
            if (!block.sentences || !block.sentences.length) {
                sQuestionEl.textContent = "–î–ª—è —Ü—ñ—î—ó –≤–ø—Ä–∞–≤–∏ —â–µ –Ω–µ–º–∞—î —Ä–µ—á–µ–Ω—å.";
                sInputEl.value = "";
                sFeedbackEl.textContent = "";
                sFeedbackEl.className = "feedback";
                return;
            }

            currentSentenceIndex = nextIndex('sent', block.sentences.length);
            lastSentenceIndex = currentSentenceIndex;
            const card = block.sentences[currentSentenceIndex];

            sQuestionEl.textContent = card.ua;
            const sQuestionId = `sent-${currentBlockIndex}-${currentSentenceIndex}`;
            speakUkrainianOnce(sQuestionId, card.ua);
            sInputEl.value = "";
            sFeedbackEl.textContent = "";
            sFeedbackEl.className = "feedback";
        }

        function checkSentence() {
            clearAutoNext();
            const block = blocks[currentBlockIndex];
            if (!block.sentences || !block.sentences.length) return;

            const card = block.sentences[currentSentenceIndex];
            const user = sInputEl.value;
            if (!user.trim()) return;

            ensureStatsForBlock(currentBlockIndex);
            const st = stats[currentBlockIndex].sent;
            st.total++;

            if (normalizeAnswer(user) === normalizeAnswer(card.en)) {
                flashScreen("green");
                sFeedbackEl.textContent = "‚úÖ –ß—É–¥–æ–≤–æ! –†–µ—á–µ–Ω–Ω—è –ø–µ—Ä–µ–∫–ª–∞–¥–µ–Ω–æ —Ç–æ—á–Ω–æ.";
                sFeedbackEl.className = "feedback correct";
                st.correct++;
                onCorrect("sent");
                speakEnglish(card.en);
                updateStatsView();

                autoNextTimeout = setTimeout(() => {
                    loadSentence();
                }, 900);
            } else {
                wrongAttemptsSent++;
                flashScreen("red");

                if (wrongAttemptsSent >= 3) {
                    sFeedbackEl.textContent = "‚ùå –¢—Ä–æ—Ö–∏ –Ω–µ —Ç–∞–∫. –ü—ñ–¥–∫–∞–∑–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç ‚Äî\n" + card.en;
                } else {
                    sFeedbackEl.textContent = "‚ùå –¢—Ä–æ—Ö–∏ –Ω–µ —Ç–∞–∫. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å¬ª.";
                }

                sFeedbackEl.className = "feedback wrong";
                onWrong("sent");
                updateStatsView();
            }
        }

        function showSentenceAnswer() {
            clearAutoNext();
            const block = blocks[currentBlockIndex];
            if (!block.sentences || !block.sentences.length) return;

            const card = block.sentences[currentSentenceIndex];
            sFeedbackEl.textContent = "–ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç:\n" + card.en;
            sFeedbackEl.className = "feedback";
            speakEnglish(card.en);
        }

        sCheckBtn.addEventListener("click", checkSentence);
        sShowBtn.addEventListener("click", showSentenceAnswer);
        sNextBtn.addEventListener("click", loadSentence);
        sInputEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) checkSentence();
        });

        /* ====== –ù–ê–í–Ü–ì–ê–¶–Ü–Ø, –ï–¢–ê–ü–ò, –ü–ï–†–ï–ó–ê–ü–£–°–ö ====== */
        btnPrev.addEventListener("click", () => {
            if (currentBlockIndex > 0) loadBlock(currentBlockIndex - 1);
        });

        btnNext.addEventListener("click", () => {
            if (currentBlockIndex < blocks.length - 1) loadBlock(currentBlockIndex + 1);
        });

        btnNextEx.addEventListener("click", nextExerciseStep);

        btnToggleExplain.addEventListener("click", () => {
            if (currentExerciseStep === 0) {
                explainVisible = true;
                updateExplainVisibility();
                return;
            }
            explainVisible = !explainVisible;
            updateExplainVisibility();
        });


        btnTopPanelEl.addEventListener("click", () => {
            // —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –ø—Ä–∞–∫—Ç–∏–∫–∏ (—ç—Ç–∞–ø 1‚Äì3)
            if (currentExerciseStep === 0) return;

            topPanelVisibleInPractice = !topPanelVisibleInPractice;
            updateGateUI();
        });

        blockSelectEl.addEventListener("change", () => {
            const idx = parseInt(blockSelectEl.value, 10);
            loadBlock(idx);
        });

        btnRestart.addEventListener("click", () => {
            clearAutoNext();
            // —Å–∫–∏–¥–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ª–∏—à–µ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó –≤–ø—Ä–∞–≤–∏
            stats[currentBlockIndex] = {
                mc: { correct: 0, total: 0 },
                write: { correct: 0, total: 0 },
                sent: { correct: 0, total: 0 }
            };
            updateStatsView();
            resetAllStages();
            lastVocabIndexMC = -1;
            lastVocabIndexWrite = -1;
            lastSentenceIndex = -1;
            stageReloadAttempted.mc = false;
            stageReloadAttempted.write = false;
            stageReloadAttempted.sent = false;
 
            // reset sequencers for this block
            try {
                const b = blocks[currentBlockIndex];
                resetSeq("mc", (b.vocab && b.vocab.length) ? b.vocab.length : 0);
                resetSeq("write", (b.vocab && b.vocab.length) ? b.vocab.length : 0);
                resetSeq("sent", (b.sentences && b.sentences.length) ? b.sentences.length : 0);
            } catch (e) {}

            gameXP = 0;
            // –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –Ω–∞ –µ—Ç–∞–ø –ø–æ—è—Å–Ω–µ–Ω–Ω—è
            currentExerciseStep = 0;
            explainVisible = true;
            uaTtsArmed = false;
            lastUaSpokenKey = null;
            updateExerciseVisibility();
            window.scrollTo({ top: 0, behavior: "smooth" });
        });

        /* ====== –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ====== */
        (function init() {
            blocks.forEach((b, i) => {
                const opt = document.createElement("option");
                opt.value = String(i);
                opt.textContent = `${i + 1}. ${b.title}`;
                blockSelectEl.appendChild(opt);
            });
            loadBlock(0);
            try { resetStage('mc'); resetStage('write'); resetStage('sent'); } catch(e) {}

        })();
    
        let lastUaSpokenKey = null;
        let uaTtsArmed = false;
        let uaVoiceCache = null;
        let voicesReadyPromise = null;
        let currentSpeechLang = null;

        function ensureVoicesReady() {
            if (!("speechSynthesis" in window)) return Promise.resolve([]);
            if (voicesReadyPromise) return voicesReadyPromise;

            voicesReadyPromise = new Promise((resolve) => {
                let settled = false;
                const finish = () => {
                    if (settled) return;
                    settled = true;
                    resolve(window.speechSynthesis.getVoices());
                };

                const voices = window.speechSynthesis.getVoices();
                if (voices.length) {
                    finish();
                    return;
                }

                const onChanged = () => {
                    const updated = window.speechSynthesis.getVoices();
                    if (updated.length) {
                        window.speechSynthesis.removeEventListener("voiceschanged", onChanged);
                        clearTimeout(timerId);
                        finish();
                    }
                };

                window.speechSynthesis.addEventListener("voiceschanged", onChanged);
                const timerId = setTimeout(() => {
                    window.speechSynthesis.removeEventListener("voiceschanged", onChanged);
                    finish();
                }, 800);
            });

            return voicesReadyPromise;
        }

        function getUkrainianVoice(voices) {
            return voices.find((voice) => voice.lang && voice.lang.toLowerCase().startsWith("uk")) || null;
        }

        function queueUtterance(utterance, lang) {
            utterance.onstart = () => {
                currentSpeechLang = lang;
            };
            const clearLang = () => {
                if (currentSpeechLang === lang) currentSpeechLang = null;
            };
            utterance.onend = clearLang;
            utterance.onerror = clearLang;
            window.speechSynthesis.speak(utterance);
        }

        function speakUkrainianOnce(questionId, text) {
            if (!uaTtsArmed) return;
            if (!text) return;
            if (lastUaSpokenKey === questionId) return;
            lastUaSpokenKey = questionId;
            if (!("speechSynthesis" in window)) return;
            speakUA(text);
        }

        function speakUA(text) {
            if (!("speechSynthesis" in window)) return;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "uk-UA";
            u.rate = 0.95;
            u.pitch = 1.0;
            ensureVoicesReady().then((voices) => {
                const uaVoice = uaVoiceCache || getUkrainianVoice(voices);
                if (uaVoice) {
                    uaVoiceCache = uaVoice;
                    u.voice = uaVoice;
                }
                const englishSpeaking = window.speechSynthesis.speaking && currentSpeechLang === "en";
                if (!englishSpeaking) {
                    try { window.speechSynthesis.cancel(); } catch(e) {}
                }
                queueUtterance(u, "uk");
            });
        }

        // ===== English TTS: –æ–∑–≤—É—á–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ =====
        let TTS_ENABLED = true;
        let TTS_LANG = "en-US";

        function speakEnglish(text) {
            if (!TTS_ENABLED) return;
            if (!("speechSynthesis" in window)) return;
            try { window.speechSynthesis.cancel(); } catch(e) {}
            const u = new SpeechSynthesisUtterance(text);
            u.lang = TTS_LANG;
            u.rate = 0.95;
            u.pitch = 1.0;
            u.onstart = () => {
                currentSpeechLang = "en";
            };
            const clearLang = () => {
                if (currentSpeechLang === "en") currentSpeechLang = null;
            };
            u.onend = clearLang;
            u.onerror = clearLang;
            window.speechSynthesis.speak(u);
        }

</script>
</body>
</html>
